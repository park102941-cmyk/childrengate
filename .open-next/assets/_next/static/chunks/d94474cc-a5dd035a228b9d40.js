"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7153],{30204:(e,t,n)=>{n.d(t,{$:()=>lb,A:()=>lF,B:()=>li,C:()=>_,D:()=>o5,F:()=>lt,H:()=>lM,N:()=>P,Q:()=>o4,R:()=>$,U:()=>b,W:()=>lp,X:()=>rx,Y:()=>ls,Z:()=>lS,_:()=>p,a:()=>V,a$:()=>lP,a2:()=>oW,a6:()=>o8,a7:()=>nH,a8:()=>oY,aO:()=>o3,aX:()=>ln,ac:()=>oJ,an:()=>nE,az:()=>en,b:()=>M,c:()=>t1,d:()=>C,e:()=>nZ,f:()=>lg,g:()=>lx,h:()=>nS,i:()=>lA,j:()=>nx,k:()=>n0,l:()=>n1,n:()=>n2,o:()=>n4,p:()=>ee,q:()=>nJ,r:()=>ns,s:()=>tY,t:()=>nv,u:()=>nW,v:()=>Q,w:()=>X,y:()=>Z,z:()=>lr});var r,i,s,a,o=n(20944),l=n(68966),u=n(17898),h=n(51437),c=n(80426),d=n(2818),f=n(95714).Buffer;class m{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}m.UNAUTHENTICATED=new m(null),m.GOOGLE_CREDENTIALS=new m("google-credentials-uid"),m.FIRST_PARTY=new m("first-party-uid"),m.MOCK_USER=new m("mock-user");let g="12.9.0";function p(e){g=e}let y=new h.Vy("@firebase/firestore");function w(){return y.logLevel}function v(e,...t){if(y.logLevel<=h.$b.DEBUG){let n=t.map(E);y.debug(`Firestore (${g}): ${e}`,...n)}}function I(e,...t){if(y.logLevel<=h.$b.ERROR){let n=t.map(E);y.error(`Firestore (${g}): ${e}`,...n)}}function T(e,...t){if(y.logLevel<=h.$b.WARN){let n=t.map(E);y.warn(`Firestore (${g}): ${e}`,...n)}}function E(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return e}}function b(e,t,n){let r="Unexpected state";"string"==typeof t?r=t:n=t,S(e,r,n)}function S(e,t,n){let r=`FIRESTORE (${g}) INTERNAL ASSERTION FAILED: ${t} (ID: ${e.toString(16)})`;if(void 0!==n)try{r+=" CONTEXT: "+JSON.stringify(n)}catch(e){r+=" CONTEXT: "+n}throw I(r),Error(r)}function x(e,t,n,r){let i="Unexpected state";"string"==typeof n?i=n:r=n,e||S(t,i,r)}let _={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class C extends l.g{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class N{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class D{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class A{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(m.UNAUTHENTICATED))}shutdown(){}}class k{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class V{constructor(e){this.t=e,this.currentUser=m.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){x(void 0===this.o,42304);let n=this.i,r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve(),i=new N;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new N,e.enqueueRetryable(()=>r(this.currentUser))};let s=()=>{let t=i;e.enqueueRetryable(async()=>{await t.promise,await r(this.currentUser)})},a=e=>{v("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.o&&(this.auth.addAuthTokenListener(this.o),s())};this.t.onInit(e=>a(e)),setTimeout(()=>{if(!this.auth){let e=this.t.getImmediate({optional:!0});e?a(e):(v("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new N)}},0),s()}getToken(){let e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(t=>this.i!==e?(v("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(x("string"==typeof t.accessToken,31837,{l:t}),new D(t.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){let e=this.auth&&this.auth.getUid();return x(null===e||"string"==typeof e,2055,{h:e}),new m(e)}}class R{constructor(e,t,n){this.P=e,this.T=t,this.I=n,this.type="FirstParty",this.user=m.FIRST_PARTY,this.R=new Map}A(){return this.I?this.I():null}get headers(){this.R.set("X-Goog-AuthUser",this.P);let e=this.A();return e&&this.R.set("Authorization",e),this.T&&this.R.set("X-Goog-Iam-Authorization-Token",this.T),this.R}}class O{constructor(e,t,n){this.P=e,this.T=t,this.I=n}getToken(){return Promise.resolve(new R(this.P,this.T,this.I))}start(e,t){e.enqueueRetryable(()=>t(m.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class F{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class M{constructor(e,t){this.V=t,this.forceRefresh=!1,this.appCheck=null,this.m=null,this.p=null,(0,o.xZ)(e)&&e.settings.appCheckToken&&(this.p=e.settings.appCheckToken)}start(e,t){x(void 0===this.o,3512);let n=e=>{null!=e.error&&v("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);let n=e.token!==this.m;return this.m=e.token,v("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable(()=>n(t))};let r=e=>{v("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.o&&this.appCheck.addTokenListener(this.o)};this.V.onInit(e=>r(e)),setTimeout(()=>{if(!this.appCheck){let e=this.V.getImmediate({optional:!0});e?r(e):v("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){if(this.p)return Promise.resolve(new F(this.p));let e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(x("string"==typeof e.token,44558,{tokenResult:e}),this.m=e.token,new F(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}class P{static newId(){let e=62*Math.floor(256/62),t="";for(;t.length<20;){let n=function(e){let t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(40);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let e=0;e<40;e++)n[e]=Math.floor(256*Math.random());return n}(0);for(let r=0;r<n.length;++r)t.length<20&&n[r]<e&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(n[r]%62))}return t}}function L(e,t){return e<t?-1:e>t?1:0}function U(e,t){let n=Math.min(e.length,t.length);for(let r=0;r<n;r++){let n=e.charAt(r),i=t.charAt(r);if(n!==i)return q(n)===q(i)?L(n,i):q(n)?1:-1}return L(e.length,t.length)}function q(e){let t=e.charCodeAt(0);return t>=55296&&t<=57343}function B(e,t,n){return e.length===t.length&&e.every((e,r)=>n(e,t[r]))}let z="__name__";class K{constructor(e,t,n){void 0===t?t=0:t>e.length&&b(637,{offset:t,range:e.length}),void 0===n?n=e.length-t:n>e.length-t&&b(1746,{length:n,range:e.length-t}),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===K.comparator(this,e)}child(e){let t=this.segments.slice(this.offset,this.limit());return e instanceof K?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){let n=Math.min(e.length,t.length);for(let r=0;r<n;r++){let n=K.compareSegments(e.get(r),t.get(r));if(0!==n)return n}return L(e.length,t.length)}static compareSegments(e,t){let n=K.isNumericId(e),r=K.isNumericId(t);return n&&!r?-1:!n&&r?1:n&&r?K.extractNumericId(e).compare(K.extractNumericId(t)):U(e,t)}static isNumericId(e){return e.startsWith("__id")&&e.endsWith("__")}static extractNumericId(e){return u.jz.fromString(e.substring(4,e.length-2))}}class $ extends K{construct(e,t,n){return new $(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){let t=[];for(let n of e){if(n.indexOf("//")>=0)throw new C(_.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>e.length>0))}return new $(t)}static emptyPath(){return new $([])}}let G=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class j extends K{construct(e,t,n){return new j(e,t,n)}static isValidIdentifier(e){return G.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),j.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&this.get(0)===z}static keyField(){return new j([z])}static fromServerFormat(e){let t=[],n="",r=0,i=()=>{if(0===n.length)throw new C(_.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""},s=!1;for(;r<e.length;){let t=e[r];if("\\"===t){if(r+1===e.length)throw new C(_.INVALID_ARGUMENT,"Path has trailing escape character: "+e);let t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new C(_.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?s=!s:"."!==t||s?n+=t:i(),r++}if(i(),s)throw new C(_.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new j(t)}static emptyPath(){return new j([])}}class Q{constructor(e){this.path=e}static fromPath(e){return new Q($.fromString(e))}static fromName(e){return new Q($.fromString(e).popFirst(5))}static empty(){return new Q($.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===$.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return $.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new Q(new $(e.slice()))}}function H(e,t,n){if(!n)throw new C(_.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Y(e){if(!Q.isDocumentKey(e))throw new C(_.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function W(e){if(Q.isDocumentKey(e))throw new C(_.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function J(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}function X(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{var t;let n=(t=e).constructor?t.constructor.name:null;return n?`a custom ${n} object`:"an object"}}return"function"==typeof e?"a function":b(12329,{type:typeof e})}function Z(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new C(_.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let n=X(e);throw new C(_.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function ee(e,t){let n={typeString:e};return t&&(n.value=t),n}function et(e,t){let n;if(!J(e))throw new C(_.INVALID_ARGUMENT,"JSON must be an object");for(let r in t)if(t[r]){let i=t[r].typeString,s="value"in t[r]?{value:t[r].value}:void 0;if(!(r in e)){n=`JSON missing required field: '${r}'`;break}let a=e[r];if(i&&typeof a!==i){n=`JSON field '${r}' must be a ${i}.`;break}if(void 0!==s&&a!==s.value){n=`Expected '${r}' field to equal '${s.value}'`;break}}if(n)throw new C(_.INVALID_ARGUMENT,n);return!0}class en{static now(){return en.fromMillis(Date.now())}static fromDate(e){return en.fromMillis(e.getTime())}static fromMillis(e){let t=Math.floor(e/1e3),n=Math.floor((e-1e3*t)*1e6);return new en(t,n)}constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0||t>=1e9)throw new C(_.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-0xe7791f700||e>=0x3afff44180)throw new C(_.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?L(this.nanoseconds,e.nanoseconds):L(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{type:en._jsonSchemaVersion,seconds:this.seconds,nanoseconds:this.nanoseconds}}static fromJSON(e){if(et(e,en._jsonSchema))return new en(e.seconds,e.nanoseconds)}valueOf(){return String(this.seconds- -0xe7791f700).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}en._jsonSchemaVersion="firestore/timestamp/1.0",en._jsonSchema={type:ee("string",en._jsonSchemaVersion),seconds:ee("number"),nanoseconds:ee("number")};class er{static fromTimestamp(e){return new er(e)}static min(){return new er(new en(0,0))}static max(){return new er(new en(0x3afff4417f,0x3b9ac9ff))}constructor(e){this.timestamp=e}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class ei{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function es(e){return e.fields.find(e=>2===e.kind)}function ea(e){return e.fields.filter(e=>2!==e.kind)}ei.UNKNOWN_ID=-1;class eo{constructor(e,t){this.fieldPath=e,this.kind=t}}class el{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new el(0,ec.min())}}function eu(e,t){let n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1;return new ec(er.fromTimestamp(1e9===r?new en(n+1,0):new en(n,r)),Q.empty(),t)}function eh(e){return new ec(e.readTime,e.key,-1)}class ec{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new ec(er.min(),Q.empty(),-1)}static max(){return new ec(er.max(),Q.empty(),-1)}}function ed(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:0!==(n=Q.comparator(e.documentKey,t.documentKey))?n:L(e.largestBatchId,t.largestBatchId)}let ef="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class em{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function eg(e){if(e.code!==_.FAILED_PRECONDITION||e.message!==ef)throw e;v("LocalStore","Unexpectedly lost primary lease")}class ep{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&b(59440),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new ep((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{let t=e();return t instanceof ep?t:ep.resolve(t)}catch(e){return ep.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):ep.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):ep.reject(t)}static resolve(e){return new ep((t,n)=>{t(e)})}static reject(e){return new ep((t,n)=>{n(e)})}static waitFor(e){return new ep((t,n)=>{let r=0,i=0,s=!1;e.forEach(e=>{++r,e.next(()=>{++i,s&&i===r&&t()},e=>n(e))}),s=!0,i===r&&t()})}static or(e){let t=ep.resolve(!1);for(let n of e)t=t.next(e=>e?ep.resolve(e):n());return t}static forEach(e,t){let n=[];return e.forEach((e,r)=>{n.push(t.call(this,e,r))}),this.waitFor(n)}static mapArray(e,t){return new ep((n,r)=>{let i=e.length,s=Array(i),a=0;for(let o=0;o<i;o++){let l=o;t(e[l]).next(e=>{s[l]=e,++a===i&&n(s)},e=>r(e))}})}static doWhile(e,t){return new ep((n,r)=>{let i=()=>{!0===e()?t().next(()=>{i()},r):n()};i()})}}let ey="SimpleDb";class ew{static open(e,t,n,r){try{return new ew(t,e.transaction(r,n))}catch(e){throw new eE(t,e)}}constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.S=new N,this.transaction.oncomplete=()=>{this.S.resolve()},this.transaction.onabort=()=>{t.error?this.S.reject(new eE(e,t.error)):this.S.resolve()},this.transaction.onerror=t=>{let n=eC(t.target.error);this.S.reject(new eE(e,n))}}get D(){return this.S.promise}abort(e){e&&this.S.reject(e),this.aborted||(v(ey,"Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}C(){let e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){return new eS(this.transaction.objectStore(e))}}class ev{static delete(e){return v(ey,"Removing database:",e),ex((0,l.mS)().indexedDB.deleteDatabase(e)).toPromise()}static v(){if(!(0,l.zW)())return!1;if(ev.F())return!0;let e=(0,l.ZQ)(),t=ev.M(e),n=eI(e);return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||0<t&&t<10||0<n&&n<4.5)}static F(){return void 0!==d&&"YES"===d.__PRIVATE_env?.__PRIVATE_USE_MOCK_PERSISTENCE}static O(e,t){return e.store(t)}static M(e){let t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i);return Number(t?t[1].split("_").slice(0,2).join("."):"-1")}constructor(e,t,n){this.name=e,this.version=t,this.N=n,this.B=null,12.2===ev.M((0,l.ZQ)())&&I("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}async L(e){return this.db||(v(ey,"Opening database:",this.name),this.db=await new Promise((t,n)=>{let r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{t(e.target.result)},r.onblocked=()=>{n(new eE(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{let r=t.target.error;"VersionError"===r.name?n(new C(_.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new C(_.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new eE(e,r))},r.onupgradeneeded=e=>{v(ey,'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);let t=e.target.result;this.N.k(t,r.transaction,e.oldVersion,this.version).next(()=>{v(ey,"Database upgrade to version "+this.version+" complete")})}})),this.K&&(this.db.onversionchange=e=>this.K(e)),this.db}q(e){this.K=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){let i="readonly"===t,s=0;for(;;){++s;try{this.db=await this.L(e);let t=ew.open(this.db,e,i?"readonly":"readwrite",n),s=r(t).next(e=>(t.C(),e)).catch(e=>(t.abort(e),ep.reject(e))).toPromise();return s.catch(()=>{}),await t.D,s}catch(t){let e="FirebaseError"!==t.name&&s<3;if(v(ey,"Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}function eI(e){let t=e.match(/Android ([\d.]+)/i);return Number(t?t[1].split(".").slice(0,2).join("."):"-1")}class eT{constructor(e){this.U=e,this.$=!1,this.W=null}get isDone(){return this.$}get G(){return this.W}set cursor(e){this.U=e}done(){this.$=!0}j(e){this.W=e}delete(){return ex(this.U.delete())}}class eE extends C{constructor(e,t){super(_.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function eb(e){return"IndexedDbTransactionError"===e.name}class eS{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(v(ey,"PUT",this.store.name,e,t),n=this.store.put(t,e)):(v(ey,"PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),ex(n)}add(e){return v(ey,"ADD",this.store.name,e,e),ex(this.store.add(e))}get(e){return ex(this.store.get(e)).next(t=>(void 0===t&&(t=null),v(ey,"GET",this.store.name,e,t),t))}delete(e){return v(ey,"DELETE",this.store.name,e),ex(this.store.delete(e))}count(){return v(ey,"COUNT",this.store.name),ex(this.store.count())}H(e,t){let n=this.options(e,t),r=n.index?this.store.index(n.index):this.store;if("function"==typeof r.getAll){let e=r.getAll(n.range);return new ep((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}{let e=this.cursor(n),t=[];return this.J(e,(e,n)=>{t.push(n)}).next(()=>t)}}Z(e,t){let n=this.store.getAll(e,null===t?void 0:t);return new ep((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}})}X(e,t){v(ey,"DELETE ALL",this.store.name);let n=this.options(e,t);n.Y=!1;let r=this.cursor(n);return this.J(r,(e,t,n)=>n.delete())}ee(e,t){let n;t?n=e:(n={},t=e);let r=this.cursor(n);return this.J(r,t)}te(e){let t=this.cursor({});return new ep((n,r)=>{t.onerror=e=>{r(eC(e.target.error))},t.onsuccess=t=>{let r=t.target.result;r?e(r.primaryKey,r.value).next(e=>{e?r.continue():n()}):n()}})}J(e,t){let n=[];return new ep((r,i)=>{e.onerror=e=>{i(e.target.error)},e.onsuccess=e=>{let i=e.target.result;if(!i)return void r();let s=new eT(i),a=t(i.primaryKey,i.value,s);if(a instanceof ep){let e=a.catch(e=>(s.done(),ep.reject(e)));n.push(e)}s.isDone?r():null===s.G?i.continue():i.continue(s.G)}}).next(()=>ep.waitFor(n))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){let n=this.store.index(e.index);return e.Y?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function ex(e){return new ep((t,n)=>{e.onsuccess=e=>{t(e.target.result)},e.onerror=e=>{n(eC(e.target.error))}})}let e_=!1;function eC(e){let t=ev.M((0,l.ZQ)());if(t>=12.2&&t<13){let t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){let e=new C("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return e_||(e_=!0,setTimeout(()=>{throw e},0)),e}}return e}let eN="IndexBackfiller";class eD{constructor(e,t){this.asyncQueue=e,this.ne=t,this.task=null}start(){this.re(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}re(e){v(eN,`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{let e=await this.ne.ie();v(eN,`Documents written: ${e}`)}catch(e){eb(e)?v(eN,"Ignoring IndexedDB error during index backfill: ",e):await eg(e)}await this.re(6e4)})}}class eA{constructor(e,t){this.localStore=e,this.persistence=t}async ie(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",t=>this.se(t,e))}se(e,t){let n=new Set,r=t,i=!0;return ep.doWhile(()=>!0===i&&r>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>{if(null!==t&&!n.has(t))return v(eN,`Processing collection: ${t}`),this.oe(e,t,r).next(e=>{r-=e,n.add(t)});i=!1})).next(()=>t-r)}oe(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next(n=>{let i=n.changes;return this.localStore.indexManager.updateIndexEntries(e,i).next(()=>this._e(r,n)).next(n=>(v(eN,`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n))).next(()=>i.size)}))}_e(e,t){let n=e;return t.changes.forEach((e,t)=>{let r=eh(t);ed(r,n)>0&&(n=r)}),new ec(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class ek{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ae(e),this.ue=e=>t.writeSequenceNumber(e))}ae(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){let e=++this.previousValue;return this.ue&&this.ue(e),e}}function eV(e){return null==e}function eR(e){return 0===e&&1/e==-1/0}function eO(e){return"number"==typeof e&&Number.isInteger(e)&&!eR(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function eF(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t+="\x01\x01"),t=function(e,t){let n=t,r=e.length;for(let t=0;t<r;t++){let r=e.charAt(t);switch(r){case"\0":n+="\x01\x10";break;case"\x01":n+="\x01\x11";break;default:n+=r}}return n}(e.get(n),t);return t+"\x01\x01"}function eM(e){let t=e.length;if(x(t>=2,64408,{path:e}),2===t)return x("\x01"===e.charAt(0)&&"\x01"===e.charAt(1),56145,{path:e}),$.emptyPath();let n=t-2,r=[],i="";for(let s=0;s<t;){let t=e.indexOf("\x01",s);switch((t<0||t>n)&&b(50515,{path:e}),e.charAt(t+1)){case"\x01":let a;let o=e.substring(s,t);0===i.length?a=o:(i+=o,a=i,i=""),r.push(a);break;case"\x10":i+=e.substring(s,t),i+="\0";break;case"\x11":i+=e.substring(s,t+1);break;default:b(61167,{path:e})}s=t+2}return new $(r)}ek.ce=-1;let eP="remoteDocuments",eL="owner",eU="owner",eq="mutationQueues",eB="mutations",ez="batchId",eK="userMutationsIndex",e$=["userId","batchId"],eG={},ej="documentMutations",eQ="remoteDocumentsV14",eH=["prefixPath","collectionGroup","readTime","documentId"],eY="documentKeyIndex",eW=["prefixPath","collectionGroup","documentId"],eJ="collectionGroupIndex",eX=["collectionGroup","readTime","prefixPath","documentId"],eZ="remoteDocumentGlobal",e0="remoteDocumentGlobalKey",e1="targets",e2="queryTargetsIndex",e4=["canonicalId","targetId"],e5="targetDocuments",e6=["targetId","path"],e3="documentTargetsIndex",e8=["path","targetId"],e9="targetGlobalKey",e7="targetGlobal",te="collectionParents",tt=["collectionId","parent"],tn="clientMetadata",tr="bundles",ti="namedQueries",ts="indexConfiguration",ta="collectionGroupIndex",to="indexState",tl=["indexId","uid"],tu="sequenceNumberIndex",th=["uid","sequenceNumber"],tc="indexEntries",td=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],tf="documentKeyIndex",tm=["indexId","uid","orderedDocumentKey"],tg="documentOverlays",tp=["userId","collectionPath","documentId"],ty="collectionPathOverlayIndex",tw=["userId","collectionPath","largestBatchId"],tv="collectionGroupOverlayIndex",tI=["userId","collectionGroup","largestBatchId"],tT="globals",tE=[eq,eB,ej,eP,e1,eL,e7,e5,tn,eZ,te,tr,ti],tb=[...tE,tg],tS=[eq,eB,ej,eQ,e1,eL,e7,e5,tn,eZ,te,tr,ti,tg],tx=[...tS,ts,to,tc],t_=[...tx,tT];class tC extends em{constructor(e,t){super(),this.le=e,this.currentSequenceNumber=t}}function tN(e,t){return ev.O(e.le,t)}function tD(e){let t=0;for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function tA(e,t){for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function tk(e){for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class tV{constructor(e,t){this.comparator=e,this.root=t||tO.EMPTY}insert(e,t){return new tV(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,tO.BLACK,null,null))}remove(e){return new tV(this.comparator,this.root.remove(e,this.comparator).copy(null,null,tO.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){let n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){let r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return -1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,n)=>(e(t,n),!1))}toString(){let e=[];return this.inorderTraversal((t,n)=>(e.push(`${t}:${n}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new tR(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new tR(this.root,e,this.comparator,!1)}getReverseIterator(){return new tR(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new tR(this.root,e,this.comparator,!0)}}class tR{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?n(e.key,t):1,t&&r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;let e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class tO{constructor(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:tO.RED,this.left=null!=r?r:tO.EMPTY,this.right=null!=i?i:tO.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,i){return new tO(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this,i=n(e,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n))).fixUp()}removeMin(){if(this.left.isEmpty())return tO.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),(e=e.copy(null,null,null,e.left.removeMin(),null)).fixUp()}remove(e,t){let n,r=this;if(0>t(e,r.key))r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return tO.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=(e=e.rotateRight()).colorFlip()),e}rotateLeft(){let e=this.copy(null,null,tO.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){let e=this.copy(null,null,tO.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){let e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){return Math.pow(2,this.check())<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw b(43730,{key:this.key,value:this.value});if(this.right.isRed())throw b(14113,{key:this.key,value:this.value});let e=this.left.check();if(e!==this.right.check())throw b(27949);return e+(this.isRed()?0:1)}}tO.EMPTY=null,tO.RED=!0,tO.BLACK=!1,tO.EMPTY=new class{constructor(){this.size=0}get key(){throw b(57766)}get value(){throw b(16141)}get color(){throw b(16727)}get left(){throw b(29726)}get right(){throw b(36894)}copy(e,t,n,r,i){return this}insert(e,t,n){return new tO(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class tF{constructor(e){this.comparator=e,this.data=new tV(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,n)=>(e(t),!1))}forEachInRange(e,t){let n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){let r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){let t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new tM(this.data.getIterator())}getIteratorFrom(e){return new tM(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof tF)||this.size!==e.size)return!1;let t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){let e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){let e=[];return this.forEach(t=>{e.push(t)}),e}toString(){let e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){let t=new tF(this.comparator);return t.data=e,t}}class tM{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function tP(e){return e.hasNext()?e.getNext():void 0}class tL{constructor(e){this.fields=e,e.sort(j.comparator)}static empty(){return new tL([])}unionWith(e){let t=new tF(j.comparator);for(let e of this.fields)t=t.add(e);for(let n of e)t=t.add(n);return new tL(t.toArray())}covers(e){for(let t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return B(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class tU extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class tq{constructor(e){this.binaryString=e}static fromBase64String(e){return new tq(function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new tU("Invalid base64 string: "+e):e}}(e))}static fromUint8Array(e){return new tq(function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e))}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return btoa(this.binaryString)}toUint8Array(){return function(e){let t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return L(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}tq.EMPTY_BYTE_STRING=new tq("");let tB=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function tz(e){if(x(!!e,39018),"string"==typeof e){let t=0,n=tB.exec(e);if(x(!!n,46558,{timestamp:e}),n[1]){let e=n[1];t=Number(e=(e+"000000000").substr(0,9))}return{seconds:Math.floor(new Date(e).getTime()/1e3),nanos:t}}return{seconds:tK(e.seconds),nanos:tK(e.nanos)}}function tK(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function t$(e){return"string"==typeof e?tq.fromBase64String(e):tq.fromUint8Array(e)}let tG="server_timestamp",tj="__type__",tQ="__previous_value__",tH="__local_write_time__";function tY(e){return(e?.mapValue?.fields||{})[tj]?.stringValue===tG}function tW(e){let t=e.mapValue.fields[tQ];return tY(t)?tW(t):t}function tJ(e){let t=tz(e.mapValue.fields[tH].timestampValue);return new en(t.seconds,t.nanos)}class tX{constructor(e,t,n,r,i,s,a,o,l,u,h){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=l,this.isUsingEmulator=u,this.apiKey=h}}let tZ="(default)";class t0{constructor(e,t){this.projectId=e,this.database=t||tZ}static empty(){return new t0("","")}get isDefaultDatabase(){return this.database===tZ}isEqual(e){return e instanceof t0&&e.projectId===this.projectId&&e.database===this.database}}function t1(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new C(_.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new t0(e.options.projectId,t)}let t2="__type__",t4="__max__",t5={mapValue:{fields:{__type__:{stringValue:t4}}}},t6="__vector__",t3="value",t8={nullValue:"NULL_VALUE"};function t9(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?tY(e)?4:nf(e)?0x1fffffffffffff:nc(e)?10:11:b(28295,{value:e})}function t7(e,t){if(e===t)return!0;let n=t9(e);if(n!==t9(t))return!1;switch(n){case 0:case 0x1fffffffffffff:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return tJ(e).isEqual(tJ(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;let n=tz(e.timestampValue),r=tz(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return t$(e.bytesValue).isEqual(t$(t.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return tK(e.geoPointValue.latitude)===tK(t.geoPointValue.latitude)&&tK(e.geoPointValue.longitude)===tK(t.geoPointValue.longitude);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return tK(e.integerValue)===tK(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){let n=tK(e.doubleValue),r=tK(t.doubleValue);return n===r?eR(n)===eR(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return B(e.arrayValue.values||[],t.arrayValue.values||[],t7);case 10:case 11:return function(e,t){let n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(tD(n)!==tD(r))return!1;for(let e in n)if(n.hasOwnProperty(e)&&(void 0===r[e]||!t7(n[e],r[e])))return!1;return!0}(e,t);default:return b(52216,{left:e})}}function ne(e,t){return void 0!==(e.values||[]).find(e=>t7(e,t))}function nt(e,t){if(e===t)return 0;let n=t9(e),r=t9(t);if(n!==r)return L(n,r);switch(n){case 0:case 0x1fffffffffffff:return 0;case 1:return L(e.booleanValue,t.booleanValue);case 2:return function(e,t){let n=tK(e.integerValue||e.doubleValue),r=tK(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return nn(e.timestampValue,t.timestampValue);case 4:return nn(tJ(e),tJ(t));case 5:return U(e.stringValue,t.stringValue);case 6:return function(e,t){let n=t$(e),r=t$(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){let n=e.split("/"),r=t.split("/");for(let e=0;e<n.length&&e<r.length;e++){let t=L(n[e],r[e]);if(0!==t)return t}return L(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){let n=L(tK(e.latitude),tK(t.latitude));return 0!==n?n:L(tK(e.longitude),tK(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return nr(e.arrayValue,t.arrayValue);case 10:return function(e,t){let n=e.fields||{},r=t.fields||{},i=n[t3]?.arrayValue,s=r[t3]?.arrayValue,a=L(i?.values?.length||0,s?.values?.length||0);return 0!==a?a:nr(i,s)}(e.mapValue,t.mapValue);case 11:return function(e,t){if(e===t5.mapValue&&t===t5.mapValue)return 0;if(e===t5.mapValue)return 1;if(t===t5.mapValue)return -1;let n=e.fields||{},r=Object.keys(n),i=t.fields||{},s=Object.keys(i);r.sort(),s.sort();for(let e=0;e<r.length&&e<s.length;++e){let t=U(r[e],s[e]);if(0!==t)return t;let a=nt(n[r[e]],i[s[e]]);if(0!==a)return a}return L(r.length,s.length)}(e.mapValue,t.mapValue);default:throw b(23264,{he:n})}}function nn(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return L(e,t);let n=tz(e),r=tz(t),i=L(n.seconds,r.seconds);return 0!==i?i:L(n.nanos,r.nanos)}function nr(e,t){let n=e.values||[],r=t.values||[];for(let e=0;e<n.length&&e<r.length;++e){let t=nt(n[e],r[e]);if(t)return t}return L(n.length,r.length)}function ni(e){var t,n;return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){let t=tz(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?t$(e.bytesValue).toBase64():"referenceValue"in e?(t=e.referenceValue,Q.fromName(t).toString()):"geoPointValue"in e?(n=e.geoPointValue,`geo(${n.latitude},${n.longitude})`):"arrayValue"in e?function(e){let t="[",n=!0;for(let r of e.values||[])n?n=!1:t+=",",t+=ni(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){let t=Object.keys(e.fields||{}).sort(),n="{",r=!0;for(let i of t)r?r=!1:n+=",",n+=`${i}:${ni(e.fields[i])}`;return n+"}"}(e.mapValue):b(61005,{value:e})}function ns(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function na(e){return!!e&&"integerValue"in e}function no(e){return!!e&&"arrayValue"in e}function nl(e){return!!e&&"nullValue"in e}function nu(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function nh(e){return!!e&&"mapValue"in e}function nc(e){return(e?.mapValue?.fields||{})[t2]?.stringValue===t6}function nd(e){if(e.geoPointValue)return{geoPointValue:{...e.geoPointValue}};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:{...e.timestampValue}};if(e.mapValue){let t={mapValue:{fields:{}}};return tA(e.mapValue.fields,(e,n)=>t.mapValue.fields[e]=nd(n)),t}if(e.arrayValue){let t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=nd(e.arrayValue.values[n]);return t}return{...e}}function nf(e){return(((e.mapValue||{}).fields||{}).__type__||{}).stringValue===t4}let nm={mapValue:{fields:{[t2]:{stringValue:t6},[t3]:{arrayValue:{}}}}};function ng(e,t){let n=nt(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function np(e,t){let n=nt(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class ny{constructor(e){this.value=e}static empty(){return new ny({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(!nh(t=(t.mapValue.fields||{})[e.get(n)]))return null;return(t=(t.mapValue.fields||{})[e.lastSegment()])||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=nd(t)}setAll(e){let t=j.emptyPath(),n={},r=[];e.forEach((e,i)=>{if(!t.isImmediateParentOf(i)){let e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=i.popLast()}e?n[i.lastSegment()]=nd(e):r.push(i.lastSegment())});let i=this.getFieldsMap(t);this.applyChanges(i,n,r)}delete(e){let t=this.field(e.popLast());nh(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return t7(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];nh(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){for(let r of(tA(t,(t,n)=>e[t]=n),n))delete e[r]}clone(){return new ny(nd(this.value))}}class nw{constructor(e,t,n,r,i,s,a){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=i,this.data=s,this.documentState=a}static newInvalidDocument(e){return new nw(e,0,er.min(),er.min(),er.min(),ny.empty(),0)}static newFoundDocument(e,t,n,r){return new nw(e,1,t,er.min(),n,r,0)}static newNoDocument(e,t){return new nw(e,2,t,er.min(),er.min(),ny.empty(),0)}static newUnknownDocument(e,t){return new nw(e,3,t,er.min(),er.min(),ny.empty(),2)}convertToFoundDocument(e,t){return this.createTime.isEqual(er.min())&&(2===this.documentType||0===this.documentType)&&(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=ny.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=ny.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=er.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof nw&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new nw(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class nv{constructor(e,t){this.position=e,this.inclusive=t}}function nI(e,t,n){let r=0;for(let i=0;i<e.position.length;i++){let s=t[i],a=e.position[i];if(r=s.field.isKeyField()?Q.comparator(Q.fromName(a.referenceValue),n.key):nt(a,n.data.field(s.field)),"desc"===s.dir&&(r*=-1),0!==r)break}return r}function nT(e,t){if(null===e)return null===t;if(null===t||e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!t7(e.position[n],t.position[n]))return!1;return!0}class nE{constructor(e,t="asc"){this.field=e,this.dir=t}}class nb{}class nS extends nb{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new nk(e,t,n):"array-contains"===t?new nF(e,n):"in"===t?new nM(e,n):"not-in"===t?new nP(e,n):"array-contains-any"===t?new nL(e,n):new nS(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new nV(e,n):new nR(e,n)}matches(e){let t=e.data.field(this.field);return"!="===this.op?null!==t&&void 0===t.nullValue&&this.matchesComparison(nt(t,this.value)):null!==t&&t9(this.value)===t9(t)&&this.matchesComparison(nt(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return b(47266,{operator:this.op})}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class nx extends nb{constructor(e,t){super(),this.filters=e,this.op=t,this.Pe=null}static create(e,t){return new nx(e,t)}matches(e){return n_(this)?void 0===this.filters.find(t=>!t.matches(e)):void 0!==this.filters.find(t=>t.matches(e))}getFlattenedFilters(){return null!==this.Pe||(this.Pe=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.Pe}getFilters(){return Object.assign([],this.filters)}}function n_(e){return"and"===e.op}function nC(e){return"or"===e.op}function nN(e){return nD(e)&&n_(e)}function nD(e){for(let t of e.filters)if(t instanceof nx)return!1;return!0}function nA(e,t){let n=e.filters.concat(t);return nx.create(n,e.op)}class nk extends nS{constructor(e,t,n){super(e,t,n),this.key=Q.fromName(n.referenceValue)}matches(e){let t=Q.comparator(e.key,this.key);return this.matchesComparison(t)}}class nV extends nS{constructor(e,t){super(e,"in",t),this.keys=nO("in",t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class nR extends nS{constructor(e,t){super(e,"not-in",t),this.keys=nO("not-in",t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function nO(e,t){return(t.arrayValue?.values||[]).map(e=>Q.fromName(e.referenceValue))}class nF extends nS{constructor(e,t){super(e,"array-contains",t)}matches(e){let t=e.data.field(this.field);return no(t)&&ne(t.arrayValue,this.value)}}class nM extends nS{constructor(e,t){super(e,"in",t)}matches(e){let t=e.data.field(this.field);return null!==t&&ne(this.value.arrayValue,t)}}class nP extends nS{constructor(e,t){super(e,"not-in",t)}matches(e){if(ne(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let t=e.data.field(this.field);return null!==t&&void 0===t.nullValue&&!ne(this.value.arrayValue,t)}}class nL extends nS{constructor(e,t){super(e,"array-contains-any",t)}matches(e){let t=e.data.field(this.field);return!(!no(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>ne(this.value.arrayValue,e))}}class nU{constructor(e,t=null,n=[],r=[],i=null,s=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=a,this.Te=null}}function nq(e,t=null,n=[],r=[],i=null,s=null,a=null){return new nU(e,t,n,r,i,s,a)}function nB(e){if(null===e.Te){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(e=>(function e(t){if(t instanceof nS)return t.field.canonicalString()+t.op.toString()+ni(t.value);if(nN(t))return t.filters.map(t=>e(t)).join(",");{let n=t.filters.map(t=>e(t)).join(",");return`${t.op}(${n})`}})(e)).join(","),t+="|ob:",t+=e.orderBy.map(e=>e.field.canonicalString()+e.dir).join(","),null==e.limit||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>ni(e)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>ni(e)).join(",")),e.Te=t}return e.Te}function nz(e,t){if(e.limit!==t.limit||e.orderBy.length!==t.orderBy.length)return!1;for(let i=0;i<e.orderBy.length;i++){var n,r;if(n=e.orderBy[i],r=t.orderBy[i],!(n.dir===r.dir&&n.field.isEqual(r.field)))return!1}if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!function e(t,n){return t instanceof nS?n instanceof nS&&t.op===n.op&&t.field.isEqual(n.field)&&t7(t.value,n.value):t instanceof nx?n instanceof nx&&t.op===n.op&&t.filters.length===n.filters.length&&t.filters.reduce((t,r,i)=>t&&e(r,n.filters[i]),!0):void b(19439)}(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!nT(e.startAt,t.startAt)&&nT(e.endAt,t.endAt)}function nK(e){return Q.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function n$(e,t){return e.filters.filter(e=>e instanceof nS&&e.field.isEqual(t))}function nG(e,t,n){let r=t8,i=!0;for(let n of n$(e,t)){let e=t8,t=!0;switch(n.op){case"<":case"<=":var s;e="nullValue"in(s=n.value)?t8:"booleanValue"in s?{booleanValue:!1}:"integerValue"in s||"doubleValue"in s?{doubleValue:NaN}:"timestampValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in s?{stringValue:""}:"bytesValue"in s?{bytesValue:""}:"referenceValue"in s?ns(t0.empty(),Q.empty()):"geoPointValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in s?{arrayValue:{}}:"mapValue"in s?nc(s)?nm:{mapValue:{}}:b(35942,{value:s});break;case"==":case"in":case">=":e=n.value;break;case">":e=n.value,t=!1;break;case"!=":case"not-in":e=t8}0>ng({value:r,inclusive:i},{value:e,inclusive:t})&&(r=e,i=t)}if(null!==n){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=n.position[s];0>ng({value:r,inclusive:i},{value:e,inclusive:n.inclusive})&&(r=e,i=n.inclusive);break}}return{value:r,inclusive:i}}function nj(e,t,n){let r=t5,i=!0;for(let n of n$(e,t)){let e=t5,t=!0;switch(n.op){case">=":case">":var s;e="nullValue"in(s=n.value)?{booleanValue:!1}:"booleanValue"in s?{doubleValue:NaN}:"integerValue"in s||"doubleValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in s?{stringValue:""}:"stringValue"in s?{bytesValue:""}:"bytesValue"in s?ns(t0.empty(),Q.empty()):"referenceValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in s?{arrayValue:{}}:"arrayValue"in s?nm:"mapValue"in s?nc(s)?{mapValue:{}}:t5:b(61959,{value:s}),t=!1;break;case"==":case"in":case"<=":e=n.value;break;case"<":e=n.value,t=!1;break;case"!=":case"not-in":e=t5}np({value:r,inclusive:i},{value:e,inclusive:t})>0&&(r=e,i=t)}if(null!==n){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=n.position[s];np({value:r,inclusive:i},{value:e,inclusive:n.inclusive})>0&&(r=e,i=n.inclusive);break}}return{value:r,inclusive:i}}class nQ{constructor(e,t=null,n=[],r=[],i=null,s="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=s,this.startAt=a,this.endAt=o,this.Ie=null,this.Ee=null,this.Re=null,this.startAt,this.endAt}}function nH(e){return new nQ(e)}function nY(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function nW(e){return null!==e.collectionGroup}function nJ(e){if(null===e.Ie){let t;e.Ie=[];let n=new Set;for(let t of e.explicitOrderBy)e.Ie.push(t),n.add(t.field.canonicalString());let r=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(t=new tF(j.comparator),e.filters.forEach(e=>{e.getFlattenedFilters().forEach(e=>{e.isInequality()&&(t=t.add(e.field))})}),t).forEach(t=>{n.has(t.canonicalString())||t.isKeyField()||e.Ie.push(new nE(t,r))}),n.has(j.keyField().canonicalString())||e.Ie.push(new nE(j.keyField(),r))}return e.Ie}function nX(e){return e.Ee||(e.Ee=function(e,t){if("F"===e.limitType)return nq(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map(e=>{let t="desc"===e.dir?"asc":"desc";return new nE(e.field,t)});let n=e.endAt?new nv(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new nv(e.startAt.position,e.startAt.inclusive):null;return nq(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}}(e,nJ(e))),e.Ee}function nZ(e,t){let n=e.filters.concat([t]);return new nQ(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function n0(e,t){let n=e.explicitOrderBy.concat([t]);return new nQ(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}function n1(e,t,n){return new nQ(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function n2(e,t){return new nQ(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,t,e.endAt)}function n4(e,t){return new nQ(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,t)}function n5(e,t){return nz(nX(e),nX(t))&&e.limitType===t.limitType}function n6(e){return`${nB(nX(e))}|lt:${e.limitType}`}function n3(e){var t;let n;return`Query(target=${n=(t=nX(e)).path.canonicalString(),null!==t.collectionGroup&&(n+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(n+=`, filters: [${t.filters.map(e=>(function e(t){return t instanceof nS?`${t.field.canonicalString()} ${t.op} ${ni(t.value)}`:t instanceof nx?t.op.toString()+" {"+t.getFilters().map(e).join(" ,")+"}":"Filter"})(e)).join(", ")}]`),null==t.limit||(n+=", limit: "+t.limit),t.orderBy.length>0&&(n+=`, orderBy: [${t.orderBy.map(e=>`${e.field.canonicalString()} (${e.dir})`).join(", ")}]`),t.startAt&&(n+=", startAt: ",n+=t.startAt.inclusive?"b:":"a:",n+=t.startAt.position.map(e=>ni(e)).join(",")),t.endAt&&(n+=", endAt: ",n+=t.endAt.inclusive?"a:":"b:",n+=t.endAt.position.map(e=>ni(e)).join(",")),`Target(${n})`}; limitType=${e.limitType})`}function n8(e,t){return t.isFoundDocument()&&function(e,t){let n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):Q.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(let n of nJ(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(let n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&(!e.startAt||!!function(e,t,n){let r=nI(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,nJ(e),t))&&(!e.endAt||!!function(e,t,n){let r=nI(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,nJ(e),t))}function n9(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function n7(e){return(t,n)=>{let r=!1;for(let i of nJ(e)){let e=function(e,t,n){let r=e.field.isKeyField()?Q.comparator(t.key,n.key):function(e,t,n){let r=t.data.field(e),i=n.data.field(e);return null!==r&&null!==i?nt(r,i):b(42886)}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return -1*r;default:return b(19790,{direction:e.dir})}}(i,t,n);if(0!==e)return e;r=r||i.field.isKeyField()}return 0}}class re{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){let t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n){for(let[t,r]of n)if(this.equalsFn(t,e))return r}}has(e){return void 0!==this.get(e)}set(e,t){let n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return void(r[n]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){let t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){tA(this.inner,(t,n)=>{for(let[t,r]of n)e(t,r)})}isEmpty(){return tk(this.inner)}size(){return this.innerSize}}let rt=new tV(Q.comparator),rn=new tV(Q.comparator);function rr(...e){let t=rn;for(let n of e)t=t.insert(n.key,n);return t}function ri(e){let t=rn;return e.forEach((e,n)=>t=t.insert(e,n.overlayedDocument)),t}function rs(){return new re(e=>e.toString(),(e,t)=>e.isEqual(t))}let ra=new tV(Q.comparator),ro=new tF(Q.comparator);function rl(...e){let t=ro;for(let n of e)t=t.add(n);return t}let ru=new tF(L);function rh(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:eR(t)?"-0":t}}function rc(e){return{integerValue:""+e}}function rd(e,t){return eO(t)?rc(t):rh(e,t)}class rf{constructor(){this._=void 0}}function rm(e,t){return e instanceof rI?na(t)||t&&"doubleValue"in t?t:{integerValue:0}:null}class rg extends rf{}class rp extends rf{constructor(e){super(),this.elements=e}}function ry(e,t){let n=rE(t);for(let t of e.elements)n.some(e=>t7(e,t))||n.push(t);return{arrayValue:{values:n}}}class rw extends rf{constructor(e){super(),this.elements=e}}function rv(e,t){let n=rE(t);for(let t of e.elements)n=n.filter(e=>!t7(e,t));return{arrayValue:{values:n}}}class rI extends rf{constructor(e,t){super(),this.serializer=e,this.Ae=t}}function rT(e){return tK(e.integerValue||e.doubleValue)}function rE(e){return no(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class rb{constructor(e,t){this.field=e,this.transform=t}}class rS{constructor(e,t){this.version=e,this.transformResults=t}}class rx{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new rx}static exists(e){return new rx(void 0,e)}static updateTime(e){return new rx(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function r_(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class rC{}function rN(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new rM(e.key,rx.none()):new rk(e.key,e.data,rx.none());{let n=e.data,r=ny.empty(),i=new tF(j.comparator);for(let e of t.fields)if(!i.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),i=i.add(e)}return new rV(e.key,r,new tL(i.toArray()),rx.none())}}function rD(e,t,n,r){return e instanceof rk?function(e,t,n,r){if(!r_(e.precondition,t))return n;let i=e.value.clone(),s=rF(e.fieldTransforms,r,t);return i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,n,r):e instanceof rV?function(e,t,n,r){if(!r_(e.precondition,t))return n;let i=rF(e.fieldTransforms,r,t),s=t.data;return(s.setAll(rR(e)),s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null===n)?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,n,r):r_(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}function rA(e,t){var n,r;return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||!(!n||!r)&&B(n,r,(e,t)=>{var n,r;return e.field.isEqual(t.field)&&(n=e.transform,r=t.transform,n instanceof rp&&r instanceof rp||n instanceof rw&&r instanceof rw?B(n.elements,r.elements,t7):n instanceof rI&&r instanceof rI?t7(n.Ae,r.Ae):n instanceof rg&&r instanceof rg)})))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class rk extends rC{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class rV extends rC{constructor(e,t,n,r,i=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function rR(e){let t=new Map;return e.fieldMask.fields.forEach(n=>{if(!n.isEmpty()){let r=e.data.field(n);t.set(n,r)}}),t}function rO(e,t,n){let r=new Map;x(e.length===n.length,32656,{Ve:n.length,de:e.length});for(let s=0;s<n.length;s++){var i;let a=e[s],o=a.transform,l=t.data.field(a.field);r.set(a.field,(i=n[s],o instanceof rp?ry(o,l):o instanceof rw?rv(o,l):i))}return r}function rF(e,t,n){let r=new Map;for(let i of e){let e=i.transform,s=n.data.field(i.field);r.set(i.field,e instanceof rg?function(e,t){let n={fields:{[tj]:{stringValue:tG},[tH]:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&tY(t)&&(t=tW(t)),t&&(n.fields[tQ]=t),{mapValue:n}}(t,s):e instanceof rp?ry(e,s):e instanceof rw?rv(e,s):function(e,t){let n=rm(e,t),r=rT(n)+rT(e.Ae);return na(n)&&na(e.Ae)?rc(r):rh(e.serializer,r)}(e,s))}return r}class rM extends rC{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class rP extends rC{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class rL{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){let n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){let i=this.mutations[t];if(i.key.isEqual(e.key)){var r;r=n[t],i instanceof rk?function(e,t,n){let r=e.value.clone(),i=rO(e.fieldTransforms,t,n.transformResults);r.setAll(i),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(i,e,r):i instanceof rV?function(e,t,n){if(!r_(e.precondition,t))return void t.convertToUnknownDocument(n.version);let r=rO(e.fieldTransforms,t,n.transformResults),i=t.data;i.setAll(rR(e)),i.setAll(r),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(i,e,r):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,r)}}}applyToLocalView(e,t){for(let n of this.baseMutations)n.key.isEqual(e.key)&&(t=rD(n,e,t,this.localWriteTime));for(let n of this.mutations)n.key.isEqual(e.key)&&(t=rD(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){let n=rs();return this.mutations.forEach(r=>{let i=e.get(r.key),s=i.overlayedDocument,a=this.applyToLocalView(s,i.mutatedFields),o=rN(s,a=t.has(r.key)?null:a);null!==o&&n.set(r.key,o),s.isValidDocument()||s.convertToNoDocument(er.min())}),n}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),rl())}isEqual(e){return this.batchId===e.batchId&&B(this.mutations,e.mutations,(e,t)=>rA(e,t))&&B(this.baseMutations,e.baseMutations,(e,t)=>rA(e,t))}}class rU{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){x(e.mutations.length===n.length,58842,{me:e.mutations.length,fe:n.length});let r=ra,i=e.mutations;for(let e=0;e<i.length;e++)r=r.insert(i[e].key,n[e].version);return new rU(e,t,n,r)}}class rq{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}class rB{constructor(e,t){this.count=e,this.unchangedNames=t}}function rz(e){if(void 0===e)return I("GRPC error has no .code"),_.UNKNOWN;switch(e){case r.OK:return _.OK;case r.CANCELLED:return _.CANCELLED;case r.UNKNOWN:return _.UNKNOWN;case r.DEADLINE_EXCEEDED:return _.DEADLINE_EXCEEDED;case r.RESOURCE_EXHAUSTED:return _.RESOURCE_EXHAUSTED;case r.INTERNAL:return _.INTERNAL;case r.UNAVAILABLE:return _.UNAVAILABLE;case r.UNAUTHENTICATED:return _.UNAUTHENTICATED;case r.INVALID_ARGUMENT:return _.INVALID_ARGUMENT;case r.NOT_FOUND:return _.NOT_FOUND;case r.ALREADY_EXISTS:return _.ALREADY_EXISTS;case r.PERMISSION_DENIED:return _.PERMISSION_DENIED;case r.FAILED_PRECONDITION:return _.FAILED_PRECONDITION;case r.ABORTED:return _.ABORTED;case r.OUT_OF_RANGE:return _.OUT_OF_RANGE;case r.UNIMPLEMENTED:return _.UNIMPLEMENTED;case r.DATA_LOSS:return _.DATA_LOSS;default:return b(39323,{code:e})}}(i=r||(r={}))[i.OK=0]="OK",i[i.CANCELLED=1]="CANCELLED",i[i.UNKNOWN=2]="UNKNOWN",i[i.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",i[i.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",i[i.NOT_FOUND=5]="NOT_FOUND",i[i.ALREADY_EXISTS=6]="ALREADY_EXISTS",i[i.PERMISSION_DENIED=7]="PERMISSION_DENIED",i[i.UNAUTHENTICATED=16]="UNAUTHENTICATED",i[i.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",i[i.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",i[i.ABORTED=10]="ABORTED",i[i.OUT_OF_RANGE=11]="OUT_OF_RANGE",i[i.UNIMPLEMENTED=12]="UNIMPLEMENTED",i[i.INTERNAL=13]="INTERNAL",i[i.UNAVAILABLE=14]="UNAVAILABLE",i[i.DATA_LOSS=15]="DATA_LOSS";let rK=new u.jz([0xffffffff,0xffffffff],0);function r$(e){let t=(new TextEncoder).encode(e),n=new u.VV;return n.update(t),new Uint8Array(n.digest())}function rG(e){let t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new u.jz([n,r],0),new u.jz([i,s],0)]}class rj{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new rQ(`Invalid padding: ${t}`);if(n<0||e.length>0&&0===this.hashCount)throw new rQ(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new rQ(`Invalid padding when bitmap length is 0: ${t}`);this.ge=8*e.length-t,this.pe=u.jz.fromNumber(this.ge)}ye(e,t,n){let r=e.add(t.multiply(u.jz.fromNumber(n)));return 1===r.compare(rK)&&(r=new u.jz([r.getBits(0),r.getBits(1)],0)),r.modulo(this.pe).toNumber()}we(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.ge)return!1;let[t,n]=rG(r$(e));for(let e=0;e<this.hashCount;e++){let r=this.ye(t,n,e);if(!this.we(r))return!1}return!0}static create(e,t,n){let r=new rj(new Uint8Array(Math.ceil(e/8)),e%8==0?0:8-e%8,t);return n.forEach(e=>r.insert(e)),r}insert(e){if(0===this.ge)return;let[t,n]=rG(r$(e));for(let e=0;e<this.hashCount;e++){let r=this.ye(t,n,e);this.be(r)}}be(e){let t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class rQ extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class rH{constructor(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,n){let r=new Map;return r.set(e,rY.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new rH(er.min(),r,new tV(L),rt,rl())}}class rY{constructor(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new rY(n,t,rl(),rl(),rl())}}class rW{constructor(e,t,n,r){this.Se=e,this.removedTargetIds=t,this.key=n,this.De=r}}class rJ{constructor(e,t){this.targetId=e,this.Ce=t}}class rX{constructor(e,t,n=tq.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class rZ{constructor(){this.ve=0,this.Fe=r2(),this.Me=tq.EMPTY_BYTE_STRING,this.xe=!1,this.Oe=!0}get current(){return this.xe}get resumeToken(){return this.Me}get Ne(){return 0!==this.ve}get Be(){return this.Oe}Le(e){e.approximateByteSize()>0&&(this.Oe=!0,this.Me=e)}ke(){let e=rl(),t=rl(),n=rl();return this.Fe.forEach((r,i)=>{switch(i){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:b(38017,{changeType:i})}}),new rY(this.Me,this.xe,e,t,n)}Ke(){this.Oe=!1,this.Fe=r2()}qe(e,t){this.Oe=!0,this.Fe=this.Fe.insert(e,t)}Ue(e){this.Oe=!0,this.Fe=this.Fe.remove(e)}$e(){this.ve+=1}We(){this.ve-=1,x(this.ve>=0,3241,{ve:this.ve})}Qe(){this.Oe=!0,this.xe=!0}}class r0{constructor(e){this.Ge=e,this.ze=new Map,this.je=rt,this.He=r1(),this.Je=r1(),this.Ze=new tV(L)}Xe(e){for(let t of e.Se)e.De&&e.De.isFoundDocument()?this.Ye(t,e.De):this.et(t,e.key,e.De);for(let t of e.removedTargetIds)this.et(t,e.key,e.De)}tt(e){this.forEachTarget(e,t=>{let n=this.nt(t);switch(e.state){case 0:this.rt(t)&&n.Le(e.resumeToken);break;case 1:n.We(),n.Ne||n.Ke(),n.Le(e.resumeToken);break;case 2:n.We(),n.Ne||this.removeTarget(t);break;case 3:this.rt(t)&&(n.Qe(),n.Le(e.resumeToken));break;case 4:this.rt(t)&&(this.it(t),n.Le(e.resumeToken));break;default:b(56790,{state:e.state})}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.ze.forEach((e,n)=>{this.rt(n)&&t(n)})}st(e){let t=e.targetId,n=e.Ce.count,r=this.ot(t);if(r){let i=r.target;if(nK(i)){if(0===n){let e=new Q(i.path);this.et(t,e,nw.newNoDocument(e,er.min()))}else x(1===n,20013,{expectedCount:n})}else{let r=this._t(t);if(r!==n){let n=this.ut(e),i=n?this.ct(n,e,r):1;0!==i&&(this.it(t),this.Ze=this.Ze.insert(t,2===i?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch"))}}}}ut(e){let t,n;let r=e.Ce.unchangedNames;if(!r||!r.bits)return null;let{bits:{bitmap:i="",padding:s=0},hashCount:a=0}=r;try{t=t$(i).toUint8Array()}catch(e){if(e instanceof tU)return T("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{n=new rj(t,s,a)}catch(e){return T(e instanceof rQ?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===n.ge?null:n}ct(e,t,n){return t.Ce.count===n-this.Pt(e,t.targetId)?0:2}Pt(e,t){let n=this.Ge.getRemoteKeysForTarget(t),r=0;return n.forEach(n=>{let i=this.Ge.ht(),s=`projects/${i.projectId}/databases/${i.database}/documents/${n.path.canonicalString()}`;e.mightContain(s)||(this.et(t,n,null),r++)}),r}Tt(e){let t=new Map;this.ze.forEach((n,r)=>{let i=this.ot(r);if(i){if(n.current&&nK(i.target)){let t=new Q(i.target.path);this.It(t).has(r)||this.Et(r,t)||this.et(r,t,nw.newNoDocument(t,e))}n.Be&&(t.set(r,n.ke()),n.Ke())}});let n=rl();this.Je.forEach((e,t)=>{let r=!0;t.forEachWhile(e=>{let t=this.ot(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(r=!1,!1)}),r&&(n=n.add(e))}),this.je.forEach((t,n)=>n.setReadTime(e));let r=new rH(e,t,this.Ze,this.je,n);return this.je=rt,this.He=r1(),this.Je=r1(),this.Ze=new tV(L),r}Ye(e,t){if(!this.rt(e))return;let n=this.Et(e,t.key)?2:0;this.nt(e).qe(t.key,n),this.je=this.je.insert(t.key,t),this.He=this.He.insert(t.key,this.It(t.key).add(e)),this.Je=this.Je.insert(t.key,this.Rt(t.key).add(e))}et(e,t,n){if(!this.rt(e))return;let r=this.nt(e);this.Et(e,t)?r.qe(t,1):r.Ue(t),this.Je=this.Je.insert(t,this.Rt(t).delete(e)),this.Je=this.Je.insert(t,this.Rt(t).add(e)),n&&(this.je=this.je.insert(t,n))}removeTarget(e){this.ze.delete(e)}_t(e){let t=this.nt(e).ke();return this.Ge.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}$e(e){this.nt(e).$e()}nt(e){let t=this.ze.get(e);return t||(t=new rZ,this.ze.set(e,t)),t}Rt(e){let t=this.Je.get(e);return t||(t=new tF(L),this.Je=this.Je.insert(e,t)),t}It(e){let t=this.He.get(e);return t||(t=new tF(L),this.He=this.He.insert(e,t)),t}rt(e){let t=null!==this.ot(e);return t||v("WatchChangeAggregator","Detected inactive target",e),t}ot(e){let t=this.ze.get(e);return t&&t.Ne?null:this.Ge.At(e)}it(e){this.ze.set(e,new rZ),this.Ge.getRemoteKeysForTarget(e).forEach(t=>{this.et(e,t,null)})}Et(e,t){return this.Ge.getRemoteKeysForTarget(e).has(t)}}function r1(){return new tV(Q.comparator)}function r2(){return new tV(Q.comparator)}let r4={asc:"ASCENDING",desc:"DESCENDING"},r5={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},r6={and:"AND",or:"OR"};class r3{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function r8(e,t){return e.useProto3Json||null==t?t:{value:t}}function r9(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function r7(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function ie(e){return x(!!e,49232),er.fromTimestamp(function(e){let t=tz(e);return new en(t.seconds,t.nanos)}(e))}function it(e,t){return ir(e,t).canonicalString()}function ir(e,t){let n=new $(["projects",e.projectId,"databases",e.database]).child("documents");return void 0===t?n:n.child(t)}function ii(e){let t=$.fromString(e);return x(iT(t),10190,{key:t.toString()}),t}function is(e,t){return it(e.databaseId,t.path)}function ia(e,t){let n=ii(t);if(n.get(1)!==e.databaseId.projectId)throw new C(_.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new C(_.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new Q(ih(n))}function io(e,t){return it(e.databaseId,t)}function il(e){let t=ii(e);return 4===t.length?$.emptyPath():ih(t)}function iu(e){return new $(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function ih(e){return x(e.length>4&&"documents"===e.get(4),29091,{key:e.toString()}),e.popFirst(5)}function ic(e,t,n){return{name:is(e,t),fields:n.value.mapValue.fields}}function id(e,t,n){let r=ia(e,t.name),i=ie(t.updateTime),s=t.createTime?ie(t.createTime):er.min(),a=new ny({mapValue:{fields:t.fields}}),o=nw.newFoundDocument(r,i,s,a);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function im(e,t){var n;let r;if(t instanceof rk)r={update:ic(e,t.key,t.value)};else if(t instanceof rM)r={delete:is(e,t.key)};else if(t instanceof rV)r={update:ic(e,t.key,t.data),updateMask:function(e){let t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof rP))return b(16599,{dt:t.type});r={verify:is(e,t.key)}}return t.fieldTransforms.length>0&&(r.updateTransforms=t.fieldTransforms.map(e=>(function(e,t){let n=t.transform;if(n instanceof rg)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof rp)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof rw)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof rI)return{fieldPath:t.field.canonicalString(),increment:n.Ae};throw b(20930,{transform:t.transform})})(0,e))),t.precondition.isNone||(r.currentDocument=void 0!==(n=t.precondition).updateTime?{updateTime:r9(e,n.updateTime.toTimestamp())}:void 0!==n.exists?{exists:n.exists}:b(27497)),r}function ig(e,t){var n;let r=t.currentDocument?void 0!==(n=t.currentDocument).updateTime?rx.updateTime(ie(n.updateTime)):void 0!==n.exists?rx.exists(n.exists):rx.none():rx.none(),i=t.updateTransforms?t.updateTransforms.map(t=>{let n;return n=null,"setToServerValue"in t?(x("REQUEST_TIME"===t.setToServerValue,16630,{proto:t}),n=new rg):"appendMissingElements"in t?n=new rp(t.appendMissingElements.values||[]):"removeAllFromArray"in t?n=new rw(t.removeAllFromArray.values||[]):"increment"in t?n=new rI(e,t.increment):b(16584,{proto:t}),new rb(j.fromServerFormat(t.fieldPath),n)}):[];if(t.update){t.update.name;let n=ia(e,t.update.name),s=new ny({mapValue:{fields:t.update.fields}});return t.updateMask?new rV(n,s,new tL((t.updateMask.fieldPaths||[]).map(e=>j.fromServerFormat(e))),r,i):new rk(n,s,r,i)}return t.delete?new rM(ia(e,t.delete),r):t.verify?new rP(ia(e,t.verify),r):b(1463,{proto:t})}function ip(e,t){return{documents:[io(e,t.path)]}}function iy(e,t){var n,r;let i;let s={structuredQuery:{}},a=t.path;null!==t.collectionGroup?(i=a,s.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(i=a.popLast(),s.structuredQuery.from=[{collectionId:a.lastSegment()}]),s.parent=io(e,i);let o=function(e){if(0!==e.length)return function e(t){return t instanceof nS?function(e){if("=="===e.op){if(nu(e.value))return{unaryFilter:{field:iv(e.field),op:"IS_NAN"}};if(nl(e.value))return{unaryFilter:{field:iv(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(nu(e.value))return{unaryFilter:{field:iv(e.field),op:"IS_NOT_NAN"}};if(nl(e.value))return{unaryFilter:{field:iv(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:iv(e.field),op:r5[e.op],value:e.value}}}(t):t instanceof nx?function(t){let n=t.getFilters().map(t=>e(t));return 1===n.length?n[0]:{compositeFilter:{op:r6[t.op],filters:n}}}(t):b(54877,{filter:t})}(nx.create(e,"and"))}(t.filters);o&&(s.structuredQuery.where=o);let l=function(e){if(0!==e.length)return e.map(e=>({field:iv(e.field),direction:r4[e.dir]}))}(t.orderBy);l&&(s.structuredQuery.orderBy=l);let u=r8(e,t.limit);return null!==u&&(s.structuredQuery.limit=u),t.startAt&&(s.structuredQuery.startAt={before:(n=t.startAt).inclusive,values:n.position}),t.endAt&&(s.structuredQuery.endAt={before:!(r=t.endAt).inclusive,values:r.position}),{ft:s,parent:i}}function iw(e){var t;let n,r=il(e.parent),i=e.structuredQuery,s=i.from?i.from.length:0,a=null;if(s>0){x(1===s,65062);let e=i.from[0];e.allDescendants?a=e.collectionId:r=r.child(e.collectionId)}let o=[];i.where&&(o=function(e){let t=function e(t){return void 0!==t.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":let t=iI(e.unaryFilter.field);return nS.create(t,"==",{doubleValue:NaN});case"IS_NULL":let n=iI(e.unaryFilter.field);return nS.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let r=iI(e.unaryFilter.field);return nS.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let i=iI(e.unaryFilter.field);return nS.create(i,"!=",{nullValue:"NULL_VALUE"});case"OPERATOR_UNSPECIFIED":return b(61313);default:return b(60726)}}(t):void 0!==t.fieldFilter?nS.create(iI(t.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";case"OPERATOR_UNSPECIFIED":return b(58110);default:return b(50506)}}(t.fieldFilter.op),t.fieldFilter.value):void 0!==t.compositeFilter?nx.create(t.compositeFilter.filters.map(t=>e(t)),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return b(1026)}}(t.compositeFilter.op)):b(30097,{filter:t})}(e);return t instanceof nx&&nN(t)?t.getFilters():[t]}(i.where));let l=[];i.orderBy&&(l=i.orderBy.map(e=>new nE(iI(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))));let u=null;i.limit&&(u=null==(n="object"==typeof(t=i.limit)?t.value:t)?null:n);let h=null;i.startAt&&(h=function(e){let t=!!e.before;return new nv(e.values||[],t)}(i.startAt));let c=null;return i.endAt&&(c=function(e){let t=!e.before;return new nv(e.values||[],t)}(i.endAt)),new nQ(r,a,l,o,u,"F",h,c)}function iv(e){return{fieldPath:e.canonicalString()}}function iI(e){return j.fromServerFormat(e.fieldPath)}function iT(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}function iE(e){return!!e&&"function"==typeof e._toProto&&"ProtoValue"===e._protoValueType}class ib{constructor(e,t,n,r,i=er.min(),s=er.min(),a=tq.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new ib(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new ib(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new ib(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new ib(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class iS{constructor(e){this.yt=e}}function ix(e,t){let n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:i_(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument()){var i;r.document={name:is(i=e.yt,t.key),fields:t.data.value.mapValue.fields,updateTime:r9(i,t.version.toTimestamp()),createTime:r9(i,t.createTime.toTimestamp())}}else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:iC(t.version)};else{if(!t.isUnknownDocument())return b(57904,{document:t});r.unknownDocument={path:n.path.toArray(),version:iC(t.version)}}return r}function i_(e){let t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function iC(e){let t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function iN(e){let t=new en(e.seconds,e.nanoseconds);return er.fromTimestamp(t)}function iD(e,t){let n=(t.baseMutations||[]).map(t=>ig(e.yt,t));for(let e=0;e<t.mutations.length-1;++e){let n=t.mutations[e];if(e+1<t.mutations.length&&void 0!==t.mutations[e+1].transform){let r=t.mutations[e+1];n.updateTransforms=r.transform.fieldTransforms,t.mutations.splice(e+1,1),++e}}let r=t.mutations.map(t=>ig(e.yt,t)),i=en.fromMillis(t.localWriteTimeMs);return new rL(t.batchId,i,n,r)}function iA(e){let t=iN(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?iN(e.lastLimboFreeSnapshotVersion):er.min();return new ib(void 0!==e.query.documents?function(e){let t=e.documents.length;return x(1===t,1966,{count:t}),nX(nH(il(e.documents[0])))}(e.query):nX(iw(e.query)),e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,t,n,tq.fromBase64String(e.resumeToken))}function ik(e,t){let n;let r=iC(t.snapshotVersion),i=iC(t.lastLimboFreeSnapshotVersion);n=nK(t.target)?ip(e.yt,t.target):iy(e.yt,t.target).ft;let s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:nB(t.target),readTime:r,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:i,query:n}}function iV(e){let t=iw({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?n1(t,t.limit,"L"):t}function iR(e,t){return new rq(t.largestBatchId,ig(e.yt,t.overlayMutation))}function iO(e,t){let n=t.path.lastSegment();return[e,eF(t.path.popLast()),n]}function iF(e,t,n,r){return{indexId:e,uid:t,sequenceNumber:n,readTime:iC(r.readTime),documentKey:eF(r.documentKey.path),largestBatchId:r.largestBatchId}}class iM{getBundleMetadata(e,t){return tN(e,tr).get(t).next(e=>{if(e)return{id:e.bundleId,createTime:iN(e.createTime),version:e.version}})}saveBundleMetadata(e,t){return tN(e,tr).put({bundleId:t.id,createTime:iC(ie(t.createTime)),version:t.version})}getNamedQuery(e,t){return tN(e,ti).get(t).next(e=>{if(e)return{name:e.name,query:iV(e.bundledQuery),readTime:iN(e.readTime)}})}saveNamedQuery(e,t){return tN(e,ti).put({name:t.name,readTime:iC(ie(t.readTime)),bundledQuery:t.bundledQuery})}}class iP{constructor(e,t){this.serializer=e,this.userId=t}static wt(e,t){return new iP(e,t.uid||"")}getOverlay(e,t){return tN(e,tg).get(iO(this.userId,t)).next(e=>e?iR(this.serializer,e):null)}getOverlays(e,t){let n=rs();return ep.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){let r=[];return n.forEach((n,i)=>{let s=new rq(t,i);r.push(this.bt(e,s))}),ep.waitFor(r)}removeOverlaysForBatchId(e,t,n){let r=new Set;t.forEach(e=>r.add(eF(e.getCollectionPath())));let i=[];return r.forEach(t=>{let r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);i.push(tN(e,tg).X(ty,r))}),ep.waitFor(i)}getOverlaysForCollection(e,t,n){let r=rs(),i=eF(t),s=IDBKeyRange.bound([this.userId,i,n],[this.userId,i,Number.POSITIVE_INFINITY],!0);return tN(e,tg).H(ty,s).next(e=>{for(let t of e){let e=iR(this.serializer,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,r){let i;let s=rs(),a=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return tN(e,tg).ee({index:tv,range:a},(e,t,n)=>{let a=iR(this.serializer,t);s.size()<r||a.largestBatchId===i?(s.set(a.getKey(),a),i=a.largestBatchId):n.done()}).next(()=>s)}bt(e,t){return tN(e,tg).put(function(e,t,n){let[r,i,s]=iO(t,n.mutation.key);return{userId:t,collectionPath:i,documentId:s,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:im(e.yt,n.mutation)}}(this.serializer,this.userId,t))}}class iL{St(e){return tN(e,tT)}getSessionToken(e){return this.St(e).get("sessionToken").next(e=>{let t=e?.value;return t?tq.fromUint8Array(t):tq.EMPTY_BYTE_STRING})}setSessionToken(e,t){return this.St(e).put({name:"sessionToken",value:t.toUint8Array()})}}class iU{constructor(){}Dt(e,t){this.Ct(e,t),t.vt()}Ct(e,t){if("nullValue"in e)this.Ft(t,5);else if("booleanValue"in e)this.Ft(t,10),t.Mt(e.booleanValue?1:0);else if("integerValue"in e)this.Ft(t,15),t.Mt(tK(e.integerValue));else if("doubleValue"in e){let n=tK(e.doubleValue);isNaN(n)?this.Ft(t,13):(this.Ft(t,15),eR(n)?t.Mt(0):t.Mt(n))}else if("timestampValue"in e){let n=e.timestampValue;this.Ft(t,20),"string"==typeof n&&(n=tz(n)),t.xt(`${n.seconds||""}`),t.Mt(n.nanos||0)}else if("stringValue"in e)this.Ot(e.stringValue,t),this.Nt(t);else if("bytesValue"in e)this.Ft(t,30),t.Bt(t$(e.bytesValue)),this.Nt(t);else if("referenceValue"in e)this.Lt(e.referenceValue,t);else if("geoPointValue"in e){let n=e.geoPointValue;this.Ft(t,45),t.Mt(n.latitude||0),t.Mt(n.longitude||0)}else"mapValue"in e?nf(e)?this.Ft(t,Number.MAX_SAFE_INTEGER):nc(e)?this.kt(e.mapValue,t):(this.Kt(e.mapValue,t),this.Nt(t)):"arrayValue"in e?(this.qt(e.arrayValue,t),this.Nt(t)):b(19022,{Ut:e})}Ot(e,t){this.Ft(t,25),this.$t(e,t)}$t(e,t){t.xt(e)}Kt(e,t){let n=e.fields||{};for(let e of(this.Ft(t,55),Object.keys(n)))this.Ot(e,t),this.Ct(n[e],t)}kt(e,t){let n=e.fields||{};this.Ft(t,53);let r=n[t3].arrayValue?.values?.length||0;this.Ft(t,15),t.Mt(tK(r)),this.Ot(t3,t),this.Ct(n[t3],t)}qt(e,t){let n=e.values||[];for(let e of(this.Ft(t,50),n))this.Ct(e,t)}Lt(e,t){this.Ft(t,37),Q.fromName(e).path.forEach(e=>{this.Ft(t,60),this.$t(e,t)})}Ft(e,t){e.Mt(t)}Nt(e){e.Mt(2)}}function iq(e){return Math.ceil((64-function(e){let t=0;for(let n=0;n<8;++n){let r=function(e){if(0===e)return 8;let t=0;return e>>4||(t+=4,e<<=4),e>>6||(t+=2,e<<=2),e>>7||(t+=1),t}(255&e[n]);if(t+=r,8!==r)break}return t}(e))/8)}iU.Wt=new iU;class iB{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Qt(e){let t=e[Symbol.iterator](),n=t.next();for(;!n.done;)this.Gt(n.value),n=t.next();this.zt()}jt(e){let t=e[Symbol.iterator](),n=t.next();for(;!n.done;)this.Ht(n.value),n=t.next();this.Jt()}Zt(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.Gt(e);else if(e<2048)this.Gt(960|e>>>6),this.Gt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Gt(480|e>>>12),this.Gt(128|63&e>>>6),this.Gt(128|63&e);else{let e=t.codePointAt(0);this.Gt(240|e>>>18),this.Gt(128|63&e>>>12),this.Gt(128|63&e>>>6),this.Gt(128|63&e)}}this.zt()}Xt(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.Ht(e);else if(e<2048)this.Ht(960|e>>>6),this.Ht(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ht(480|e>>>12),this.Ht(128|63&e>>>6),this.Ht(128|63&e);else{let e=t.codePointAt(0);this.Ht(240|e>>>18),this.Ht(128|63&e>>>12),this.Ht(128|63&e>>>6),this.Ht(128|63&e)}}this.Jt()}Yt(e){let t=this.en(e),n=iq(t);this.tn(1+n),this.buffer[this.position++]=255&n;for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=255&t[e]}nn(e){let t=this.en(e),n=iq(t);this.tn(1+n),this.buffer[this.position++]=~(255&n);for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=~(255&t[e])}rn(){this.sn(255),this.sn(255)}_n(){this.an(255),this.an(255)}reset(){this.position=0}seed(e){this.tn(e.length),this.buffer.set(e,this.position),this.position+=e.length}un(){return this.buffer.slice(0,this.position)}en(e){let t=function(e){let t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=!!(128&t[0]);t[0]^=n?255:128;for(let e=1;e<t.length;++e)t[e]^=n?255:0;return t}Gt(e){let t=255&e;0===t?(this.sn(0),this.sn(255)):255===t?(this.sn(255),this.sn(0)):this.sn(t)}Ht(e){let t=255&e;0===t?(this.an(0),this.an(255)):255===t?(this.an(255),this.an(0)):this.an(e)}zt(){this.sn(0),this.sn(1)}Jt(){this.an(0),this.an(1)}sn(e){this.tn(1),this.buffer[this.position++]=e}an(e){this.tn(1),this.buffer[this.position++]=~e}tn(e){let t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);let r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class iz{constructor(e){this.cn=e}Bt(e){this.cn.Qt(e)}xt(e){this.cn.Zt(e)}Mt(e){this.cn.Yt(e)}vt(){this.cn.rn()}}class iK{constructor(e){this.cn=e}Bt(e){this.cn.jt(e)}xt(e){this.cn.Xt(e)}Mt(e){this.cn.nn(e)}vt(){this.cn._n()}}class i${constructor(){this.cn=new iB,this.ascending=new iz(this.cn),this.descending=new iK(this.cn)}seed(e){this.cn.seed(e)}ln(e){return 0===e?this.ascending:this.descending}un(){return this.cn.un()}reset(){this.cn.reset()}}class iG{constructor(e,t,n,r){this.hn=e,this.Pn=t,this.Tn=n,this.In=r}En(){let e=this.In.length,t=0===e||255===this.In[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.In,0),t!==e?n.set([0],this.In.length):++n[n.length-1],new iG(this.hn,this.Pn,this.Tn,n)}Rn(e,t,n){return{indexId:this.hn,uid:e,arrayValue:iH(this.Tn),directionalValue:iH(this.In),orderedDocumentKey:iH(t),documentKey:n.path.toArray()}}An(e,t,n){let r=this.Rn(e,t,n);return[r.indexId,r.uid,r.arrayValue,r.directionalValue,r.orderedDocumentKey,r.documentKey]}}function ij(e,t){let n=e.hn-t.hn;return 0!==n?n:0!==(n=iQ(e.Tn,t.Tn))?n:0!==(n=iQ(e.In,t.In))?n:Q.comparator(e.Pn,t.Pn)}function iQ(e,t){for(let n=0;n<e.length&&n<t.length;++n){let r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}function iH(e){return(0,l.Ov)()?function(e){let t="";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t}(e):e}function iY(e){return"string"!=typeof e?e:function(e){let t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(e)}class iW{constructor(e){for(let t of(this.Vn=new tF((e,t)=>j.comparator(e.field,t.field)),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.dn=e.orderBy,this.mn=[],e.filters))t.isInequality()?this.Vn=this.Vn.add(t):this.mn.push(t)}get fn(){return this.Vn.size>1}gn(e){if(x(e.collectionGroup===this.collectionId,49279),this.fn)return!1;let t=es(e);if(void 0!==t&&!this.pn(t))return!1;let n=ea(e),r=new Set,i=0,s=0;for(;i<n.length&&this.pn(n[i]);++i)r=r.add(n[i].fieldPath.canonicalString());if(i===n.length)return!0;if(this.Vn.size>0){let e=this.Vn.getIterator().getNext();if(!r.has(e.field.canonicalString())){let t=n[i];if(!this.yn(e,t)||!this.wn(this.dn[s++],t))return!1}++i}for(;i<n.length;++i){let e=n[i];if(s>=this.dn.length||!this.wn(this.dn[s++],e))return!1}return!0}bn(){if(this.fn)return null;let e=new tF(j.comparator),t=[];for(let n of this.mn)if(!n.field.isKeyField()){if("array-contains"===n.op||"array-contains-any"===n.op)t.push(new eo(n.field,2));else{if(e.has(n.field))continue;e=e.add(n.field),t.push(new eo(n.field,0))}}for(let n of this.dn)n.field.isKeyField()||e.has(n.field)||(e=e.add(n.field),t.push(new eo(n.field,"asc"===n.dir?0:1)));return new ei(ei.UNKNOWN_ID,this.collectionId,t,el.empty())}pn(e){for(let t of this.mn)if(this.yn(t,e))return!0;return!1}yn(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;let n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}wn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function iJ(e){return e instanceof nS}function iX(e){return e instanceof nx&&nN(e)}function iZ(e){return iJ(e)||iX(e)||function(e){if(e instanceof nx&&nC(e)){for(let t of e.getFilters())if(!iJ(t)&&!iX(t))return!1;return!0}return!1}(e)}function i0(e,t){return x(e instanceof nS||e instanceof nx,38388),x(t instanceof nS||t instanceof nx,25473),i2(e instanceof nS?t instanceof nS?nx.create([e,t],"and"):i1(e,t):t instanceof nS?i1(t,e):function(e,t){if(x(e.filters.length>0&&t.filters.length>0,48005),n_(e)&&n_(t))return nA(e,t.getFilters());let n=nC(e)?e:t,r=nC(e)?t:e,i=n.filters.map(e=>i0(e,r));return nx.create(i,"or")}(e,t))}function i1(e,t){if(n_(t))return nA(t,e.getFilters());{let n=t.filters.map(t=>i0(e,t));return nx.create(n,"or")}}function i2(e){if(x(e instanceof nS||e instanceof nx,11850),e instanceof nS)return e;let t=e.getFilters();if(1===t.length)return i2(t[0]);if(nD(e))return e;let n=t.map(e=>i2(e)),r=[];return n.forEach(t=>{t instanceof nS?r.push(t):t instanceof nx&&(t.op===e.op?r.push(...t.filters):r.push(t))}),1===r.length?r[0]:nx.create(r,e.op)}class i4{constructor(){this.Sn=new i5}addToCollectionParentIndex(e,t){return this.Sn.add(t),ep.resolve()}getCollectionParents(e,t){return ep.resolve(this.Sn.getEntries(t))}addFieldIndex(e,t){return ep.resolve()}deleteFieldIndex(e,t){return ep.resolve()}deleteAllFieldIndexes(e){return ep.resolve()}createTargetIndexes(e,t){return ep.resolve()}getDocumentsMatchingTarget(e,t){return ep.resolve(null)}getIndexType(e,t){return ep.resolve(0)}getFieldIndexes(e,t){return ep.resolve([])}getNextCollectionGroupToUpdate(e){return ep.resolve(null)}getMinOffset(e,t){return ep.resolve(ec.min())}getMinOffsetFromCollectionGroup(e,t){return ep.resolve(ec.min())}updateCollectionGroup(e,t,n){return ep.resolve()}updateIndexEntries(e,t){return ep.resolve()}}class i5{constructor(){this.index={}}add(e){let t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new tF($.comparator),i=!r.has(n);return this.index[t]=r.add(n),i}has(e){let t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new tF($.comparator)).toArray()}}let i6="IndexedDbIndexManager",i3=new Uint8Array(0);class i8{constructor(e,t){this.databaseId=t,this.Dn=new i5,this.Cn=new re(e=>nB(e),(e,t)=>nz(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.Dn.has(t)){let n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener(()=>{this.Dn.add(t)});let i={collectionId:n,parent:eF(r)};return tN(e,te).put(i)}return ep.resolve()}getCollectionParents(e,t){let n=[],r=IDBKeyRange.bound([t,""],[t+"\0",""],!1,!0);return tN(e,te).H(r).next(e=>{for(let r of e){if(r.collectionId!==t)break;n.push(eM(r.parent))}return n})}addFieldIndex(e,t){let n=tN(e,ts),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete r.indexId;let i=n.add(r);if(t.indexState){let n=tN(e,to);return i.next(e=>{n.put(iF(e,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return i.next()}deleteFieldIndex(e,t){let n=tN(e,ts),r=tN(e,to),i=tN(e,tc);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){let t=tN(e,ts),n=tN(e,tc),r=tN(e,to);return t.X().next(()=>n.X()).next(()=>r.X())}createTargetIndexes(e,t){return ep.forEach(this.vn(t),t=>this.getIndexType(e,t).next(n=>{if(0===n||1===n){let n=new iW(t).bn();if(null!=n)return this.addFieldIndex(e,n)}}))}getDocumentsMatchingTarget(e,t){let n=tN(e,tc),r=!0,i=new Map;return ep.forEach(this.vn(t),t=>this.Fn(e,t).next(e=>{r&&(r=!!e),i.set(t,e)})).next(()=>{if(r){let e=rl(),r=[];return ep.forEach(i,(i,s)=>{v(i6,`Using index id=${i.indexId}|cg=${i.collectionGroup}|f=${i.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")} to execute ${nB(t)}`);let a=function(e,t){let n=es(t);if(void 0===n)return null;for(let t of n$(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(s,i),o=function(e,t){let n=new Map;for(let r of ea(t))for(let t of n$(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(s,i),l=function(e,t){let n=[],r=!0;for(let i of ea(t)){let t=0===i.kind?nG(e,i.fieldPath,e.startAt):nj(e,i.fieldPath,e.startAt);n.push(t.value),r&&(r=t.inclusive)}return new nv(n,r)}(s,i),u=function(e,t){let n=[],r=!0;for(let i of ea(t)){let t=0===i.kind?nj(e,i.fieldPath,e.endAt):nG(e,i.fieldPath,e.endAt);n.push(t.value),r&&(r=t.inclusive)}return new nv(n,r)}(s,i),h=this.Mn(i,s,l),c=this.Mn(i,s,u),d=this.xn(i,s,o),f=this.On(i.indexId,a,h,l.inclusive,c,u.inclusive,d);return ep.forEach(f,i=>n.Z(i,t.limit).next(t=>{t.forEach(t=>{let n=Q.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))})}))}).next(()=>r)}return ep.resolve(null)})}vn(e){let t=this.Cn.get(e);return t||(t=0===e.filters.length?[e]:(function(e){if(0===e.getFilters().length)return[];let t=function e(t){if(x(t instanceof nS||t instanceof nx,34018),t instanceof nS)return t;if(1===t.filters.length)return e(t.filters[0]);let n=t.filters.map(t=>e(t)),r=nx.create(n,t.op);return iZ(r=i2(r))?r:(x(r instanceof nx,64498),x(n_(r),40251),x(r.filters.length>1,57927),r.filters.reduce((e,t)=>i0(e,t)))}(function e(t){if(x(t instanceof nS||t instanceof nx,20012),t instanceof nS){if(t instanceof nM){let e=t.value.arrayValue?.values?.map(e=>nS.create(t.field,"==",e))||[];return nx.create(e,"or")}return t}let n=t.filters.map(t=>e(t));return nx.create(n,t.op)}(e));return x(iZ(t),7391),iJ(t)||iX(t)?[t]:t.getFilters()})(nx.create(e.filters,"and")).map(t=>nq(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt)),this.Cn.set(e,t)),t}On(e,t,n,r,i,s,a){let o=(null!=t?t.length:1)*Math.max(n.length,i.length),l=o/(null!=t?t.length:1),u=[];for(let h=0;h<o;++h){let o=t?this.Nn(t[h/l]):i3,c=this.Bn(e,o,n[h%l],r),d=this.Ln(e,o,i[h%l],s),f=a.map(t=>this.Bn(e,o,t,!0));u.push(...this.createRange(c,d,f))}return u}Bn(e,t,n,r){let i=new iG(e,Q.empty(),t,n);return r?i:i.En()}Ln(e,t,n,r){let i=new iG(e,Q.empty(),t,n);return r?i.En():i}Fn(e,t){let n=new iW(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next(e=>{let t=null;for(let r of e)n.gn(r)&&(!t||r.fields.length>t.fields.length)&&(t=r);return t})}getIndexType(e,t){let n=2,r=this.vn(t);return ep.forEach(r,t=>this.Fn(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new tF(j.comparator),n=!1;for(let r of e.filters)for(let e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(let n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})).next(()=>null!==t.limit&&r.length>1&&2===n?1:n)}kn(e,t){let n=new i$;for(let r of ea(e)){let e=t.data.field(r.fieldPath);if(null==e)return null;let i=n.ln(r.kind);iU.Wt.Dt(e,i)}return n.un()}Nn(e){let t=new i$;return iU.Wt.Dt(e,t.ln(0)),t.un()}Kn(e,t){let n=new i$;return iU.Wt.Dt(ns(this.databaseId,t),n.ln(function(e){let t=ea(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.un()}xn(e,t,n){if(null===n)return[];let r=[];r.push(new i$);let i=0;for(let s of ea(e)){let e=n[i++];for(let n of r)if(this.qn(t,s.fieldPath)&&no(e))r=this.Un(r,s,e);else{let t=n.ln(s.kind);iU.Wt.Dt(e,t)}}return this.$n(r)}Mn(e,t,n){return this.xn(e,t,n.position)}$n(e){let t=[];for(let n=0;n<e.length;++n)t[n]=e[n].un();return t}Un(e,t,n){let r=[...e],i=[];for(let e of n.arrayValue.values||[])for(let n of r){let r=new i$;r.seed(n.un()),iU.Wt.Dt(e,r.ln(t.kind)),i.push(r)}return i}qn(e,t){return!!e.filters.find(e=>e instanceof nS&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){let n=tN(e,ts),r=tN(e,to);return(t?n.H(ta,IDBKeyRange.bound(t,t)):n.H()).next(e=>{let t=[];return ep.forEach(e,e=>r.get([e.indexId,this.uid]).next(n=>{t.push(function(e,t){let n=t?new el(t.sequenceNumber,new ec(iN(t.readTime),new Q(eM(t.documentKey)),t.largestBatchId)):el.empty(),r=e.fields.map(([e,t])=>new eo(j.fromServerFormat(e),t));return new ei(e.indexId,e.collectionGroup,r,n)}(e,n))})).next(()=>t)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{let n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:L(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,t,n){let r=tN(e,ts),i=tN(e,to);return this.Wn(e).next(e=>r.H(ta,IDBKeyRange.bound(t,t)).next(t=>ep.forEach(t,t=>i.put(iF(t.indexId,this.uid,e,n)))))}updateIndexEntries(e,t){let n=new Map;return ep.forEach(t,(t,r)=>{let i=n.get(t.collectionGroup);return(i?ep.resolve(i):this.getFieldIndexes(e,t.collectionGroup)).next(i=>(n.set(t.collectionGroup,i),ep.forEach(i,n=>this.Qn(e,t,n).next(t=>{let i=this.Gn(r,n);return t.isEqual(i)?ep.resolve():this.zn(e,r,n,t,i)}))))})}jn(e,t,n,r){return tN(e,tc).put(r.Rn(this.uid,this.Kn(n,t.key),t.key))}Hn(e,t,n,r){return tN(e,tc).delete(r.An(this.uid,this.Kn(n,t.key),t.key))}Qn(e,t,n){let r=tN(e,tc),i=new tF(ij);return r.ee({index:tf,range:IDBKeyRange.only([n.indexId,this.uid,iH(this.Kn(n,t))])},(e,r)=>{i=i.add(new iG(n.indexId,t,iY(r.arrayValue),iY(r.directionalValue)))}).next(()=>i)}Gn(e,t){let n=new tF(ij),r=this.kn(t,e);if(null==r)return n;let i=es(t);if(null!=i){let s=e.data.field(i.fieldPath);if(no(s))for(let i of s.arrayValue.values||[])n=n.add(new iG(t.indexId,e.key,this.Nn(i),r))}else n=n.add(new iG(t.indexId,e.key,i3,r));return n}zn(e,t,n,r,i){v(i6,"Updating index entries for document '%s'",t.key);let s=[];return function(e,t,n,r,i){let s=e.getIterator(),a=t.getIterator(),o=tP(s),l=tP(a);for(;o||l;){let e=!1,t=!1;if(o&&l){let r=n(o,l);r<0?t=!0:r>0&&(e=!0)}else null!=o?t=!0:e=!0;e?(r(l),l=tP(a)):t?(i(o),o=tP(s)):(o=tP(s),l=tP(a))}}(r,i,ij,r=>{s.push(this.jn(e,t,n,r))},r=>{s.push(this.Hn(e,t,n,r))}),ep.waitFor(s)}Wn(e){let t=1;return tN(e,to).ee({index:tu,reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,n,r)=>{r.done(),t=n.sequenceNumber+1}).next(()=>t)}createRange(e,t,n){n=n.sort((e,t)=>ij(e,t)).filter((e,t,n)=>!t||0!==ij(e,n[t-1]));let r=[];for(let i of(r.push(e),n)){let n=ij(i,e),s=ij(i,t);if(0===n)r[0]=e.En();else if(n>0&&s<0)r.push(i),r.push(i.En());else if(s>0)break}r.push(t);let i=[];for(let e=0;e<r.length;e+=2){if(this.Jn(r[e],r[e+1]))return[];let t=r[e].An(this.uid,i3,Q.empty()),n=r[e+1].An(this.uid,i3,Q.empty());i.push(IDBKeyRange.bound(t,n))}return i}Jn(e,t){return ij(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(i9)}getMinOffset(e,t){return ep.mapArray(this.vn(t),t=>this.Fn(e,t).next(e=>e||b(44426))).next(i9)}}function i9(e){x(0!==e.length,28825);let t=e[0].indexState.offset,n=t.largestBatchId;for(let r=1;r<e.length;r++){let i=e[r].indexState.offset;0>ed(i,t)&&(t=i),n<i.largestBatchId&&(n=i.largestBatchId)}return new ec(t.readTime,t.documentKey,n)}let i7={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class se{static withCacheSize(e){return new se(e,se.DEFAULT_COLLECTION_PERCENTILE,se.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}}function st(e,t,n){let r=e.store(eB),i=e.store(ej),s=[],a=IDBKeyRange.only(n.batchId),o=0,l=r.ee({range:a},(e,t,n)=>(o++,n.delete()));s.push(l.next(()=>{x(1===o,47070,{batchId:n.batchId})}));let u=[];for(let e of n.mutations){var h,c;let r=(h=e.key.path,c=n.batchId,[t,eF(h),c]);s.push(i.delete(r)),u.push(e.key)}return ep.waitFor(s).next(()=>u)}function sn(e){let t;if(!e)return 0;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw b(14731);t=e.noDocument}return JSON.stringify(t).length}se.DEFAULT_COLLECTION_PERCENTILE=10,se.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,se.DEFAULT=new se(0x2800000,se.DEFAULT_COLLECTION_PERCENTILE,se.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),se.DISABLED=new se(-1,0,0);class sr{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.Zn={}}static wt(e,t,n,r){return x(""!==e.uid,64387),new sr(e.isAuthenticated()?e.uid:"",t,n,r)}checkEmpty(e){let t=!0,n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return ss(e).ee({index:eK,range:n},(e,n,r)=>{t=!1,r.done()}).next(()=>t)}addMutationBatch(e,t,n,r){let i=tN(e,ej),s=ss(e);return s.add({}).next(a=>{x("number"==typeof a,49019);let o=new rL(a,t,n,r),l=function(e,t,n){let r=n.baseMutations.map(t=>im(e.yt,t)),i=n.mutations.map(t=>im(e.yt,t));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:i}}(this.serializer,this.userId,o),u=[],h=new tF((e,t)=>L(e.canonicalString(),t.canonicalString()));for(let e of r){let t=[this.userId,eF(e.key.path),a];h=h.add(e.key.path.popLast()),u.push(s.put(l)),u.push(i.put(t,eG))}return h.forEach(t=>{u.push(this.indexManager.addToCollectionParentIndex(e,t))}),e.addOnCommittedListener(()=>{this.Zn[a]=o.keys()}),ep.waitFor(u).next(()=>o)})}lookupMutationBatch(e,t){return ss(e).get(t).next(e=>e?(x(e.userId===this.userId,48,"Unexpected user for mutation batch",{userId:e.userId,batchId:t}),iD(this.serializer,e)):null)}Xn(e,t){return this.Zn[t]?ep.resolve(this.Zn[t]):this.lookupMutationBatch(e,t).next(e=>{if(e){let n=e.keys();return this.Zn[t]=n,n}return null})}getNextMutationBatchAfterBatchId(e,t){let n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]),i=null;return ss(e).ee({index:eK,range:r},(e,t,r)=>{t.userId===this.userId&&(x(t.batchId>=n,47524,{Yn:n}),i=iD(this.serializer,t)),r.done()}).next(()=>i)}getHighestUnacknowledgedBatchId(e){let t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),n=-1;return ss(e).ee({index:eK,range:t,reverse:!0},(e,t,r)=>{n=t.batchId,r.done()}).next(()=>n)}getAllMutationBatches(e){let t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return ss(e).H(eK,t).next(e=>e.map(e=>iD(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(e,t){let n=[this.userId,eF(t.path)],r=IDBKeyRange.lowerBound(n),i=[];return tN(e,ej).ee({range:r},(n,r,s)=>{let[a,o,l]=n,u=eM(o);if(a===this.userId&&t.path.isEqual(u))return ss(e).get(l).next(e=>{if(!e)throw b(61480,{er:n,batchId:l});x(e.userId===this.userId,10503,"Unexpected user for mutation batch",{userId:e.userId,batchId:l}),i.push(iD(this.serializer,e))});s.done()}).next(()=>i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new tF(L),r=[];return t.forEach(t=>{let i=[this.userId,eF(t.path)],s=IDBKeyRange.lowerBound(i),a=tN(e,ej).ee({range:s},(e,r,i)=>{let[s,a,o]=e,l=eM(a);s===this.userId&&t.path.isEqual(l)?n=n.add(o):i.done()});r.push(a)}),ep.waitFor(r).next(()=>this.tr(e,n))}getAllMutationBatchesAffectingQuery(e,t){let n=t.path,r=n.length+1,i=[this.userId,eF(n)],s=IDBKeyRange.lowerBound(i),a=new tF(L);return tN(e,ej).ee({range:s},(e,t,i)=>{let[s,o,l]=e,u=eM(o);s===this.userId&&n.isPrefixOf(u)?u.length===r&&(a=a.add(l)):i.done()}).next(()=>this.tr(e,a))}tr(e,t){let n=[],r=[];return t.forEach(t=>{r.push(ss(e).get(t).next(e=>{if(null===e)throw b(35274,{batchId:t});x(e.userId===this.userId,9748,"Unexpected user for mutation batch",{userId:e.userId,batchId:t}),n.push(iD(this.serializer,e))}))}),ep.waitFor(r).next(()=>n)}removeMutationBatch(e,t){return st(e.le,this.userId,t).next(n=>(e.addOnCommittedListener(()=>{this.nr(t.batchId)}),ep.forEach(n,t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))}nr(e){delete this.Zn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return ep.resolve();let n=IDBKeyRange.lowerBound([this.userId]),r=[];return tN(e,ej).ee({range:n},(e,t,n)=>{if(e[0]===this.userId){let t=eM(e[1]);r.push(t)}else n.done()}).next(()=>{x(0===r.length,56720,{rr:r.map(e=>e.canonicalString())})})})}containsKey(e,t){return si(e,this.userId,t)}ir(e){return tN(e,eq).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function si(e,t,n){let r=[t,eF(n.path)],i=r[1],s=IDBKeyRange.lowerBound(r),a=!1;return tN(e,ej).ee({range:s,Y:!0},(e,n,r)=>{let[s,o,l]=e;s===t&&o===i&&(a=!0),r.done()}).next(()=>a)}function ss(e){return tN(e,eB)}class sa{constructor(e){this.sr=e}next(){return this.sr+=2,this.sr}static _r(){return new sa(0)}static ar(){return new sa(-1)}}class so{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.ur(e).next(t=>{let n=new sa(t.highestTargetId);return t.highestTargetId=n.next(),this.cr(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.ur(e).next(e=>er.fromTimestamp(new en(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.ur(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(e,t,n){return this.ur(e).next(r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.cr(e,r)))}addTargetData(e,t){return this.lr(e,t).next(()=>this.ur(e).next(n=>(n.targetCount+=1,this.hr(t,n),this.cr(e,n))))}updateTargetData(e,t){return this.lr(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>tN(e,e1).delete(t.targetId)).next(()=>this.ur(e)).next(t=>(x(t.targetCount>0,8065),t.targetCount-=1,this.cr(e,t)))}removeTargets(e,t,n){let r=0,i=[];return tN(e,e1).ee((s,a)=>{let o=iA(a);o.sequenceNumber<=t&&null===n.get(o.targetId)&&(r++,i.push(this.removeTargetData(e,o)))}).next(()=>ep.waitFor(i)).next(()=>r)}forEachTarget(e,t){return tN(e,e1).ee((e,n)=>{t(iA(n))})}ur(e){return tN(e,e7).get(e9).next(e=>(x(null!==e,2888),e))}cr(e,t){return tN(e,e7).put(e9,t)}lr(e,t){return tN(e,e1).put(ik(this.serializer,t))}hr(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.ur(e).next(e=>e.targetCount)}getTargetData(e,t){let n=nB(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]),i=null;return tN(e,e1).ee({range:r,index:e2},(e,n,r)=>{let s=iA(n);nz(t,s.target)&&(i=s,r.done())}).next(()=>i)}addMatchingKeys(e,t,n){let r=[],i=sl(e);return t.forEach(t=>{let s=eF(t.path);r.push(i.put({targetId:n,path:s})),r.push(this.referenceDelegate.addReference(e,n,t))}),ep.waitFor(r)}removeMatchingKeys(e,t,n){let r=sl(e);return ep.forEach(t,t=>{let i=eF(t.path);return ep.waitFor([r.delete([n,i]),this.referenceDelegate.removeReference(e,n,t)])})}removeMatchingKeysForTargetId(e,t){let n=sl(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){let n=IDBKeyRange.bound([t],[t+1],!1,!0),r=sl(e),i=rl();return r.ee({range:n,Y:!0},(e,t,n)=>{let r=new Q(eM(e[1]));i=i.add(r)}).next(()=>i)}containsKey(e,t){let n=eF(t.path),r=IDBKeyRange.bound([n],[n+"\0"],!1,!0),i=0;return sl(e).ee({index:e3,Y:!0,range:r},([e,t],n,r)=>{0!==e&&(i++,r.done())}).next(()=>i>0)}At(e,t){return tN(e,e1).get(t).next(e=>e?iA(e):null)}}function sl(e){return tN(e,e5)}let su="LruGarbageCollector";function sh([e,t],[n,r]){let i=L(e,n);return 0===i?L(t,r):i}class sc{constructor(e){this.Pr=e,this.buffer=new tF(sh),this.Tr=0}Ir(){return++this.Tr}Er(e){let t=[e,this.Ir()];if(this.buffer.size<this.Pr)this.buffer=this.buffer.add(t);else{let e=this.buffer.last();0>sh(t,e)&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class sd{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Rr=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Ar(6e4)}stop(){this.Rr&&(this.Rr.cancel(),this.Rr=null)}get started(){return null!==this.Rr}Ar(e){v(su,`Garbage collection scheduled in ${e}ms`),this.Rr=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Rr=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){eb(e)?v(su,"Ignoring IndexedDB error during garbage collection: ",e):await eg(e)}await this.Ar(3e5)})}}class sf{constructor(e,t){this.Vr=e,this.params=t}calculateTargetCount(e,t){return this.Vr.dr(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return ep.resolve(ek.ce);let n=new sc(t);return this.Vr.forEachTarget(e,e=>n.Er(e.sequenceNumber)).next(()=>this.Vr.mr(e,e=>n.Er(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.Vr.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.Vr.removeOrphanedDocuments(e,t)}collect(e,t){return -1===this.params.cacheSizeCollectionThreshold?(v("LruGarbageCollector","Garbage collection skipped; disabled"),ep.resolve(i7)):this.getCacheSize(e).next(n=>n<this.params.cacheSizeCollectionThreshold?(v("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),i7):this.gr(e,t))}getCacheSize(e){return this.Vr.getCacheSize(e)}gr(e,t){let n,r,i,s,a,o,l;let u=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(t=>(t>this.params.maximumSequenceNumbersToCollect?(v("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,s=Date.now(),this.nthSequenceNumber(e,r))).next(r=>(n=r,a=Date.now(),this.removeTargets(e,n,t))).next(t=>(i=t,o=Date.now(),this.removeOrphanedDocuments(e,n))).next(e=>(l=Date.now(),w()<=h.$b.DEBUG&&v("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${s-u}ms
	Determined least recently used ${r} in `+(a-s)+"ms\n"+`	Removed ${i} targets in `+(o-a)+"ms\n"+`	Removed ${e} documents in `+(l-o)+"ms\n"+`Total Duration: ${l-u}ms`),ep.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:i,documentsRemoved:e})))}}class sm{constructor(e,t){this.db=e,this.garbageCollector=new sf(this,t)}dr(e){let t=this.pr(e);return this.db.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}pr(e){let t=0;return this.mr(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}mr(e,t){return this.yr(e,(e,n)=>t(n))}addReference(e,t,n){return sg(e,n)}removeReference(e,t,n){return sg(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return sg(e,t)}wr(e,t){let n;return n=!1,tN(e,eq).te(r=>si(e,r,t).next(e=>(e&&(n=!0),ep.resolve(!e)))).next(()=>n)}removeOrphanedDocuments(e,t){let n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[],i=0;return this.yr(e,(s,a)=>{if(a<=t){let t=this.wr(e,s).next(t=>{if(!t)return i++,n.getEntry(e,s).next(()=>(n.removeEntry(s,er.min()),sl(e).delete([0,eF(s.path)])))});r.push(t)}}).next(()=>ep.waitFor(r)).next(()=>n.apply(e)).next(()=>i)}removeTarget(e,t){let n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return sg(e,t)}yr(e,t){let n=sl(e),r,i=ek.ce;return n.ee({index:e3},([e,n],{path:s,sequenceNumber:a})=>{0===e?(i!==ek.ce&&t(new Q(eM(r)),i),i=a,r=s):i=ek.ce}).next(()=>{i!==ek.ce&&t(new Q(eM(r)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function sg(e,t){var n;return sl(e).put((n=e.currentSequenceNumber,{targetId:0,path:eF(t.path),sequenceNumber:n}))}class sp{constructor(){this.changes=new re(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,nw.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();let n=this.changes.get(t);return void 0!==n?ep.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class sy{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return tN(e,eQ).put(n)}removeEntry(e,t,n){return tN(e,eQ).delete(function(e,t){let n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],i_(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next(n=>(n.byteSize+=t,this.br(e,n)))}getEntry(e,t){let n=nw.newInvalidDocument(t);return tN(e,eQ).ee({index:eY,range:IDBKeyRange.only(sv(t))},(e,r)=>{n=this.Sr(t,r)}).next(()=>n)}Dr(e,t){let n={size:0,document:nw.newInvalidDocument(t)};return tN(e,eQ).ee({index:eY,range:IDBKeyRange.only(sv(t))},(e,r)=>{n={document:this.Sr(t,r),size:sn(r)}}).next(()=>n)}getEntries(e,t){let n=rt;return this.Cr(e,t,(e,t)=>{let r=this.Sr(e,t);n=n.insert(e,r)}).next(()=>n)}vr(e,t){let n=rt,r=new tV(Q.comparator);return this.Cr(e,t,(e,t)=>{let i=this.Sr(e,t);n=n.insert(e,i),r=r.insert(e,sn(t))}).next(()=>({documents:n,Fr:r}))}Cr(e,t,n){if(t.isEmpty())return ep.resolve();let r=new tF(sT);t.forEach(e=>r=r.add(e));let i=IDBKeyRange.bound(sv(r.first()),sv(r.last())),s=r.getIterator(),a=s.getNext();return tN(e,eQ).ee({index:eY,range:i},(e,t,r)=>{let i=Q.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;a&&0>sT(a,i);)n(a,null),a=s.getNext();a&&a.isEqual(i)&&(n(a,t),a=s.hasNext()?s.getNext():null),a?r.j(sv(a)):r.done()}).next(()=>{for(;a;)n(a,null),a=s.hasNext()?s.getNext():null})}getDocumentsMatchingQuery(e,t,n,r,i){let s=t.path,a=[s.popLast().toArray(),s.lastSegment(),i_(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],o=[s.popLast().toArray(),s.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return tN(e,eQ).H(IDBKeyRange.bound(a,o,!0)).next(e=>{i?.incrementDocumentReadCount(e.length);let n=rt;for(let i of e){let e=this.Sr(Q.fromSegments(i.prefixPath.concat(i.collectionGroup,i.documentId)),i);e.isFoundDocument()&&(n8(t,e)||r.has(e.key))&&(n=n.insert(e.key,e))}return n})}getAllFromCollectionGroup(e,t,n,r){let i=rt,s=sI(t,n),a=sI(t,ec.max());return tN(e,eQ).ee({index:eJ,range:IDBKeyRange.bound(s,a,!0)},(e,t,n)=>{let s=this.Sr(Q.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);(i=i.insert(s.key,s)).size===r&&n.done()}).next(()=>i)}newChangeBuffer(e){return new sw(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return tN(e,eZ).get(e0).next(e=>(x(!!e,20021),e))}br(e,t){return tN(e,eZ).put(e0,t)}Sr(e,t){if(t){let e=function(e,t){let n;if(t.document)n=id(e.yt,t.document,!!t.hasCommittedMutations);else if(t.noDocument){let e=Q.fromSegments(t.noDocument.path),r=iN(t.noDocument.readTime);n=nw.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return b(56709);{let e=Q.fromSegments(t.unknownDocument.path),r=iN(t.unknownDocument.version);n=nw.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime(function(e){let t=new en(e[0],e[1]);return er.fromTimestamp(t)}(t.readTime)),n}(this.serializer,t);if(!(e.isNoDocument()&&e.version.isEqual(er.min())))return e}return nw.newInvalidDocument(e)}}class sw extends sp{constructor(e,t){super(),this.Mr=e,this.trackRemovals=t,this.Or=new re(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(e){let t=[],n=0,r=new tF((e,t)=>L(e.canonicalString(),t.canonicalString()));return this.changes.forEach((i,s)=>{let a=this.Or.get(i);if(t.push(this.Mr.removeEntry(e,i,a.readTime)),s.isValidDocument()){let o=ix(this.Mr.serializer,s);r=r.add(i.path.popLast());let l=sn(o);n+=l-a.size,t.push(this.Mr.addEntry(e,i,o))}else if(n-=a.size,this.trackRemovals){let n=ix(this.Mr.serializer,s.convertToNoDocument(er.min()));t.push(this.Mr.addEntry(e,i,n))}}),r.forEach(n=>{t.push(this.Mr.indexManager.addToCollectionParentIndex(e,n))}),t.push(this.Mr.updateMetadata(e,n)),ep.waitFor(t)}getFromCache(e,t){return this.Mr.Dr(e,t).next(e=>(this.Or.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.Mr.vr(e,t).next(({documents:e,Fr:t})=>(t.forEach((t,n)=>{this.Or.set(t,{size:n,readTime:e.get(t).readTime})}),e))}}function sv(e){let t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function sI(e,t){let n=t.documentKey.path.toArray();return[e,i_(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function sT(e,t){let n=e.path.toArray(),r=t.path.toArray(),i=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(i=L(n[e],r[e]))return i;return(i=L(n.length,r.length))||(i=L(n[n.length-2],r[r.length-2]))||L(n[n.length-1],r[r.length-1])}class sE{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class sb{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next(r=>(n=r,this.remoteDocumentCache.getEntry(e,t))).next(e=>(null!==n&&rD(n.mutation,e,tL.empty(),en.now()),e))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.getLocalViewOfDocuments(e,t,rl()).next(()=>t))}getLocalViewOfDocuments(e,t,n=rl()){let r=rs();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let t=rr();return e.forEach((e,n)=>{t=t.insert(e,n.overlayedDocument)}),t}))}getOverlayedDocuments(e,t){let n=rs();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,rl()))}populateOverlays(e,t,n){let r=[];return n.forEach(e=>{t.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,n)=>{t.set(e,n)})})}computeViews(e,t,n,r){let i=rt,s=rs(),a=rs();return t.forEach((e,t)=>{let a=n.get(t.key);r.has(t.key)&&(void 0===a||a.mutation instanceof rV)?i=i.insert(t.key,t):void 0!==a?(s.set(t.key,a.mutation.getFieldMask()),rD(a.mutation,t,a.mutation.getFieldMask(),en.now())):s.set(t.key,tL.empty())}),this.recalculateAndSaveOverlays(e,i).next(e=>(e.forEach((e,t)=>s.set(e,t)),t.forEach((e,t)=>a.set(e,new sE(t,s.get(e)??null))),a))}recalculateAndSaveOverlays(e,t){let n=rs(),r=new tV((e,t)=>e-t),i=rl();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(e=>{for(let i of e)i.keys().forEach(e=>{let s=t.get(e);if(null===s)return;let a=n.get(e)||tL.empty();a=i.applyToLocalView(s,a),n.set(e,a);let o=(r.get(i.batchId)||rl()).add(e);r=r.insert(i.batchId,o)})}).next(()=>{let s=[],a=r.getReverseIterator();for(;a.hasNext();){let r=a.getNext(),o=r.key,l=r.value,u=rs();l.forEach(e=>{if(!i.has(e)){let r=rN(t.get(e),n.get(e));null!==r&&u.set(e,r),i=i.add(e)}}),s.push(this.documentOverlayCache.saveOverlays(e,o,u))}return ep.waitFor(s)}).next(()=>n)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.recalculateAndSaveOverlays(e,t))}getDocumentsMatchingQuery(e,t,n,r){return Q.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):nW(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next(i=>{let s=r-i.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-i.size):ep.resolve(rs()),a=-1,o=i;return s.next(t=>ep.forEach(t,(t,n)=>(a<n.largestBatchId&&(a=n.largestBatchId),i.get(t)?ep.resolve():this.remoteDocumentCache.getEntry(e,t).next(e=>{o=o.insert(t,e)}))).next(()=>this.populateOverlays(e,t,i)).next(()=>this.computeViews(e,o,t,rl())).next(e=>({batchId:a,changes:ri(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new Q(t)).next(e=>{let t=rr();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(e,t,n,r){let i=t.collectionGroup,s=rr();return this.indexManager.getCollectionParents(e,i).next(a=>ep.forEach(a,a=>{let o=new nQ(a.child(i),null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt);return this.getDocumentsMatchingCollectionQuery(e,o,n,r).next(e=>{e.forEach((e,t)=>{s=s.insert(e,t)})})}).next(()=>s))}getDocumentsMatchingCollectionQuery(e,t,n,r){let i;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next(s=>(i=s,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,i,r))).next(e=>{i.forEach((t,n)=>{let r=n.getKey();null===e.get(r)&&(e=e.insert(r,nw.newInvalidDocument(r)))});let n=rr();return e.forEach((e,r)=>{let s=i.get(e);void 0!==s&&rD(s.mutation,r,tL.empty(),en.now()),n8(t,r)&&(n=n.insert(e,r))}),n})}}class sS{constructor(e){this.serializer=e,this.Nr=new Map,this.Br=new Map}getBundleMetadata(e,t){return ep.resolve(this.Nr.get(t))}saveBundleMetadata(e,t){return this.Nr.set(t.id,{id:t.id,version:t.version,createTime:ie(t.createTime)}),ep.resolve()}getNamedQuery(e,t){return ep.resolve(this.Br.get(t))}saveNamedQuery(e,t){return this.Br.set(t.name,{name:t.name,query:iV(t.bundledQuery),readTime:ie(t.readTime)}),ep.resolve()}}class sx{constructor(){this.overlays=new tV(Q.comparator),this.Lr=new Map}getOverlay(e,t){return ep.resolve(this.overlays.get(t))}getOverlays(e,t){let n=rs();return ep.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){return n.forEach((n,r)=>{this.bt(e,t,r)}),ep.resolve()}removeOverlaysForBatchId(e,t,n){let r=this.Lr.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.Lr.delete(n)),ep.resolve()}getOverlaysForCollection(e,t,n){let r=rs(),i=t.length+1,s=new Q(t.child("")),a=this.overlays.getIteratorFrom(s);for(;a.hasNext();){let e=a.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>n&&r.set(e.getKey(),e)}return ep.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let i=new tV((e,t)=>e-t),s=this.overlays.getIterator();for(;s.hasNext();){let e=s.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=i.get(e.largestBatchId);null===t&&(t=rs(),i=i.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}let a=rs(),o=i.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=r)););return ep.resolve(a)}bt(e,t,n){let r=this.overlays.get(n.key);if(null!==r){let e=this.Lr.get(r.largestBatchId).delete(n.key);this.Lr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new rq(t,n));let i=this.Lr.get(t);void 0===i&&(i=rl(),this.Lr.set(t,i)),this.Lr.set(t,i.add(n.key))}}class s_{constructor(){this.sessionToken=tq.EMPTY_BYTE_STRING}getSessionToken(e){return ep.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,ep.resolve()}}class sC{constructor(){this.kr=new tF(sN.Kr),this.qr=new tF(sN.Ur)}isEmpty(){return this.kr.isEmpty()}addReference(e,t){let n=new sN(e,t);this.kr=this.kr.add(n),this.qr=this.qr.add(n)}$r(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.Wr(new sN(e,t))}Qr(e,t){e.forEach(e=>this.removeReference(e,t))}Gr(e){let t=new Q(new $([])),n=new sN(t,e),r=new sN(t,e+1),i=[];return this.qr.forEachInRange([n,r],e=>{this.Wr(e),i.push(e.key)}),i}zr(){this.kr.forEach(e=>this.Wr(e))}Wr(e){this.kr=this.kr.delete(e),this.qr=this.qr.delete(e)}jr(e){let t=new Q(new $([])),n=new sN(t,e),r=new sN(t,e+1),i=rl();return this.qr.forEachInRange([n,r],e=>{i=i.add(e.key)}),i}containsKey(e){let t=new sN(e,0),n=this.kr.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class sN{constructor(e,t){this.key=e,this.Hr=t}static Kr(e,t){return Q.comparator(e.key,t.key)||L(e.Hr,t.Hr)}static Ur(e,t){return L(e.Hr,t.Hr)||Q.comparator(e.key,t.key)}}class sD{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.Yn=1,this.Jr=new tF(sN.Kr)}checkEmpty(e){return ep.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){let i=this.Yn;this.Yn++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let s=new rL(i,t,n,r);for(let t of(this.mutationQueue.push(s),r))this.Jr=this.Jr.add(new sN(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return ep.resolve(s)}lookupMutationBatch(e,t){return ep.resolve(this.Zr(t))}getNextMutationBatchAfterBatchId(e,t){let n=this.Xr(t+1),r=n<0?0:n;return ep.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return ep.resolve(0===this.mutationQueue.length?-1:this.Yn-1)}getAllMutationBatches(e){return ep.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){let n=new sN(t,0),r=new sN(t,Number.POSITIVE_INFINITY),i=[];return this.Jr.forEachInRange([n,r],e=>{let t=this.Zr(e.Hr);i.push(t)}),ep.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new tF(L);return t.forEach(e=>{let t=new sN(e,0),r=new sN(e,Number.POSITIVE_INFINITY);this.Jr.forEachInRange([t,r],e=>{n=n.add(e.Hr)})}),ep.resolve(this.Yr(n))}getAllMutationBatchesAffectingQuery(e,t){let n=t.path,r=n.length+1,i=n;Q.isDocumentKey(i)||(i=i.child(""));let s=new sN(new Q(i),0),a=new tF(L);return this.Jr.forEachWhile(e=>{let t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e.Hr)),!0)},s),ep.resolve(this.Yr(a))}Yr(e){let t=[];return e.forEach(e=>{let n=this.Zr(e);null!==n&&t.push(n)}),t}removeMutationBatch(e,t){x(0===this.ei(t.batchId,"removed"),55003),this.mutationQueue.shift();let n=this.Jr;return ep.forEach(t.mutations,r=>{let i=new sN(r.key,t.batchId);return n=n.delete(i),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)}).next(()=>{this.Jr=n})}nr(e){}containsKey(e,t){let n=new sN(t,0),r=this.Jr.firstAfterOrEqual(n);return ep.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,ep.resolve()}ei(e,t){return this.Xr(e)}Xr(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Zr(e){let t=this.Xr(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class sA{constructor(e){this.ti=e,this.docs=new tV(Q.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){let n=t.key,r=this.docs.get(n),i=r?r.size:0,s=this.ti(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){let t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){let n=this.docs.get(t);return ep.resolve(n?n.document.mutableCopy():nw.newInvalidDocument(t))}getEntries(e,t){let n=rt;return t.forEach(e=>{let t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():nw.newInvalidDocument(e))}),ep.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let i=rt,s=t.path,a=new Q(s.child("__id-9223372036854775808__")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){let{key:e,value:{document:a}}=o.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||0>=ed(eh(a),n)||(r.has(a.key)||n8(t,a))&&(i=i.insert(a.key,a.mutableCopy()))}return ep.resolve(i)}getAllFromCollectionGroup(e,t,n,r){b(9500)}ni(e,t){return ep.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new sk(this)}getSize(e){return ep.resolve(this.size)}}class sk extends sp{constructor(e){super(),this.Mr=e}applyChanges(e){let t=[];return this.changes.forEach((n,r)=>{r.isValidDocument()?t.push(this.Mr.addEntry(e,r)):this.Mr.removeEntry(n)}),ep.waitFor(t)}getFromCache(e,t){return this.Mr.getEntry(e,t)}getAllFromCache(e,t){return this.Mr.getEntries(e,t)}}class sV{constructor(e){this.persistence=e,this.ri=new re(e=>nB(e),nz),this.lastRemoteSnapshotVersion=er.min(),this.highestTargetId=0,this.ii=0,this.si=new sC,this.targetCount=0,this.oi=sa._r()}forEachTarget(e,t){return this.ri.forEach((e,n)=>t(n)),ep.resolve()}getLastRemoteSnapshotVersion(e){return ep.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return ep.resolve(this.ii)}allocateTargetId(e){return this.highestTargetId=this.oi.next(),ep.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.ii&&(this.ii=t),ep.resolve()}lr(e){this.ri.set(e.target,e);let t=e.targetId;t>this.highestTargetId&&(this.oi=new sa(t),this.highestTargetId=t),e.sequenceNumber>this.ii&&(this.ii=e.sequenceNumber)}addTargetData(e,t){return this.lr(t),this.targetCount+=1,ep.resolve()}updateTargetData(e,t){return this.lr(t),ep.resolve()}removeTargetData(e,t){return this.ri.delete(t.target),this.si.Gr(t.targetId),this.targetCount-=1,ep.resolve()}removeTargets(e,t,n){let r=0,i=[];return this.ri.forEach((s,a)=>{a.sequenceNumber<=t&&null===n.get(a.targetId)&&(this.ri.delete(s),i.push(this.removeMatchingKeysForTargetId(e,a.targetId)),r++)}),ep.waitFor(i).next(()=>r)}getTargetCount(e){return ep.resolve(this.targetCount)}getTargetData(e,t){let n=this.ri.get(t)||null;return ep.resolve(n)}addMatchingKeys(e,t,n){return this.si.$r(t,n),ep.resolve()}removeMatchingKeys(e,t,n){this.si.Qr(t,n);let r=this.persistence.referenceDelegate,i=[];return r&&t.forEach(t=>{i.push(r.markPotentiallyOrphaned(e,t))}),ep.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this.si.Gr(t),ep.resolve()}getMatchingKeysForTargetId(e,t){let n=this.si.jr(t);return ep.resolve(n)}containsKey(e,t){return ep.resolve(this.si.containsKey(t))}}class sR{constructor(e,t){this._i={},this.overlays={},this.ai=new ek(0),this.ui=!1,this.ui=!0,this.ci=new s_,this.referenceDelegate=e(this),this.li=new sV(this),this.indexManager=new i4,this.remoteDocumentCache=new sA(e=>this.referenceDelegate.hi(e)),this.serializer=new iS(t),this.Pi=new sS(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.ui=!1,Promise.resolve()}get started(){return this.ui}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new sx,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this._i[e.toKey()];return n||(n=new sD(t,this.referenceDelegate),this._i[e.toKey()]=n),n}getGlobalsCache(){return this.ci}getTargetCache(){return this.li}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Pi}runTransaction(e,t,n){v("MemoryPersistence","Starting transaction:",e);let r=new sO(this.ai.next());return this.referenceDelegate.Ti(),n(r).next(e=>this.referenceDelegate.Ii(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Ei(e,t){return ep.or(Object.values(this._i).map(n=>()=>n.containsKey(e,t)))}}class sO extends em{constructor(e){super(),this.currentSequenceNumber=e}}class sF{constructor(e){this.persistence=e,this.Ri=new sC,this.Ai=null}static Vi(e){return new sF(e)}get di(){if(this.Ai)return this.Ai;throw b(60996)}addReference(e,t,n){return this.Ri.addReference(n,t),this.di.delete(n.toString()),ep.resolve()}removeReference(e,t,n){return this.Ri.removeReference(n,t),this.di.add(n.toString()),ep.resolve()}markPotentiallyOrphaned(e,t){return this.di.add(t.toString()),ep.resolve()}removeTarget(e,t){this.Ri.Gr(t.targetId).forEach(e=>this.di.add(e.toString()));let n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.di.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}Ti(){this.Ai=new Set}Ii(e){let t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return ep.forEach(this.di,n=>{let r=Q.fromPath(n);return this.mi(e,r).next(e=>{e||t.removeEntry(r,er.min())})}).next(()=>(this.Ai=null,t.apply(e)))}updateLimboDocument(e,t){return this.mi(e,t).next(e=>{e?this.di.delete(t.toString()):this.di.add(t.toString())})}hi(e){return 0}mi(e,t){return ep.or([()=>ep.resolve(this.Ri.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ei(e,t)])}}class sM{constructor(e,t){this.persistence=e,this.fi=new re(e=>eF(e.path),(e,t)=>e.isEqual(t)),this.garbageCollector=new sf(this,t)}static Vi(e,t){return new sM(e,t)}Ti(){}Ii(e){return ep.resolve()}forEachTarget(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)}dr(e){let t=this.pr(e);return this.persistence.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}pr(e){let t=0;return this.mr(e,e=>{t++}).next(()=>t)}mr(e,t){return ep.forEach(this.fi,(n,r)=>this.wr(e,n,r).next(e=>e?ep.resolve():t(r)))}removeTargets(e,t,n){return this.persistence.getTargetCache().removeTargets(e,t,n)}removeOrphanedDocuments(e,t){let n=0,r=this.persistence.getRemoteDocumentCache(),i=r.newChangeBuffer();return r.ni(e,r=>this.wr(e,r,t).next(e=>{e||(n++,i.removeEntry(r,er.min()))})).next(()=>i.apply(e)).next(()=>n)}markPotentiallyOrphaned(e,t){return this.fi.set(t,e.currentSequenceNumber),ep.resolve()}removeTarget(e,t){let n=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,n)}addReference(e,t,n){return this.fi.set(n,e.currentSequenceNumber),ep.resolve()}removeReference(e,t,n){return this.fi.set(n,e.currentSequenceNumber),ep.resolve()}updateLimboDocument(e,t){return this.fi.set(t,e.currentSequenceNumber),ep.resolve()}hi(e){let t=e.key.toString().length;return e.isFoundDocument()&&(t+=function e(t){switch(t9(t)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:let n=tW(t);return n?16+e(n):16;case 5:return 2*t.stringValue.length;case 6:return t$(t.bytesValue).approximateByteSize();case 7:return t.referenceValue.length;case 9:return(t.arrayValue.values||[]).reduce((t,n)=>t+e(n),0);case 10:case 11:var r;let i;return r=t.mapValue,i=0,tA(r.fields,(t,n)=>{i+=t.length+e(n)}),i;default:throw b(13486,{value:t})}}(e.data.value)),t}wr(e,t,n){return ep.or([()=>this.persistence.Ei(e,t),()=>this.persistence.getTargetCache().containsKey(e,t),()=>{let e=this.fi.get(t);return ep.resolve(void 0!==e&&e>n)}])}getCacheSize(e){return this.persistence.getRemoteDocumentCache().getSize(e)}}class sP{constructor(e){this.serializer=e}k(e,t,n,r){let i=new ew("createOrUpgrade",t);n<1&&r>=1&&(!function(e){e.createObjectStore(eL)}(e),e.createObjectStore(eq,{keyPath:"userId"}),e.createObjectStore(eB,{keyPath:ez,autoIncrement:!0}).createIndex(eK,e$,{unique:!0}),e.createObjectStore(ej),sL(e),function(e){e.createObjectStore(eP)}(e));let s=ep.resolve();return n<3&&r>=3&&(0!==n&&(e.deleteObjectStore(e5),e.deleteObjectStore(e1),e.deleteObjectStore(e7),sL(e)),s=s.next(()=>(function(e){let t=e.store(e7),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:er.min().toTimestamp(),targetCount:0};return t.put(e9,n)})(i))),n<4&&r>=4&&(0!==n&&(s=s.next(()=>i.store(eB).H().next(t=>{e.deleteObjectStore(eB),e.createObjectStore(eB,{keyPath:ez,autoIncrement:!0}).createIndex(eK,e$,{unique:!0});let n=i.store(eB),r=t.map(e=>n.put(e));return ep.waitFor(r)}))),s=s.next(()=>{!function(e){e.createObjectStore(tn,{keyPath:"clientId"})}(e)})),n<5&&r>=5&&(s=s.next(()=>this.gi(i))),n<6&&r>=6&&(s=s.next(()=>((function(e){e.createObjectStore(eZ)})(e),this.pi(i)))),n<7&&r>=7&&(s=s.next(()=>this.yi(i))),n<8&&r>=8&&(s=s.next(()=>this.wi(e,i))),n<9&&r>=9&&(s=s.next(()=>{e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&r>=10&&(s=s.next(()=>this.bi(i))),n<11&&r>=11&&(s=s.next(()=>{(function(e){e.createObjectStore(tr,{keyPath:"bundleId"})})(e),function(e){e.createObjectStore(ti,{keyPath:"name"})}(e)})),n<12&&r>=12&&(s=s.next(()=>{!function(e){let t=e.createObjectStore(tg,{keyPath:tp});t.createIndex(ty,tw,{unique:!1}),t.createIndex(tv,tI,{unique:!1})}(e)})),n<13&&r>=13&&(s=s.next(()=>(function(e){let t=e.createObjectStore(eQ,{keyPath:eH});t.createIndex(eY,eW),t.createIndex(eJ,eX)})(e)).next(()=>this.Si(e,i)).next(()=>e.deleteObjectStore(eP))),n<14&&r>=14&&(s=s.next(()=>this.Di(e,i))),n<15&&r>=15&&(s=s.next(()=>{e.createObjectStore(ts,{keyPath:"indexId",autoIncrement:!0}).createIndex(ta,"collectionGroup",{unique:!1}),e.createObjectStore(to,{keyPath:tl}).createIndex(tu,th,{unique:!1}),e.createObjectStore(tc,{keyPath:td}).createIndex(tf,tm,{unique:!1})})),n<16&&r>=16&&(s=s.next(()=>{t.objectStore(to).clear()}).next(()=>{t.objectStore(tc).clear()})),n<17&&r>=17&&(s=s.next(()=>{!function(e){e.createObjectStore(tT,{keyPath:"name"})}(e)})),n<18&&r>=18&&(0,l.Ov)()&&(s=s.next(()=>{t.objectStore(to).clear()}).next(()=>{t.objectStore(tc).clear()})),s}pi(e){let t=0;return e.store(eP).ee((e,n)=>{t+=sn(n)}).next(()=>{let n={byteSize:t};return e.store(eZ).put(e0,n)})}gi(e){let t=e.store(eq),n=e.store(eB);return t.H().next(t=>ep.forEach(t,t=>{let r=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.H(eK,r).next(n=>ep.forEach(n,n=>{x(n.userId===t.userId,18650,"Cannot process batch from unexpected user",{batchId:n.batchId});let r=iD(this.serializer,n);return st(e,t.userId,r).next(()=>{})}))}))}yi(e){let t=e.store(e5),n=e.store(eP);return e.store(e7).get(e9).next(e=>{let r=[];return n.ee((n,i)=>{let s=new $(n),a=[0,eF(s)];r.push(t.get(a).next(n=>n?ep.resolve():t.put({targetId:0,path:eF(s),sequenceNumber:e.highestListenSequenceNumber})))}).next(()=>ep.waitFor(r))})}wi(e,t){e.createObjectStore(te,{keyPath:tt});let n=t.store(te),r=new i5,i=e=>{if(r.add(e)){let t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:eF(r)})}};return t.store(eP).ee({Y:!0},(e,t)=>i(new $(e).popLast())).next(()=>t.store(ej).ee({Y:!0},([e,t,n],r)=>i(eM(t).popLast())))}bi(e){let t=e.store(e1);return t.ee((e,n)=>{let r=iA(n),i=ik(this.serializer,r);return t.put(i)})}Si(e,t){let n=t.store(eP),r=[];return n.ee((e,n)=>{let i=t.store(eQ),s=(n.document?new Q($.fromString(n.document.name).popFirst(5)):n.noDocument?Q.fromSegments(n.noDocument.path):n.unknownDocument?Q.fromSegments(n.unknownDocument.path):b(36783)).path.toArray(),a={prefixPath:s.slice(0,s.length-2),collectionGroup:s[s.length-2],documentId:s[s.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(i.put(a))}).next(()=>ep.waitFor(r))}Di(e,t){let n=t.store(eB),r=new sy(this.serializer),i=new sR(sF.Vi,this.serializer.yt);return n.H().next(e=>{let n=new Map;return e.forEach(e=>{let t=n.get(e.userId)??rl();iD(this.serializer,e).keys().forEach(e=>t=t.add(e)),n.set(e.userId,t)}),ep.forEach(n,(e,n)=>{let s=new m(n),a=iP.wt(this.serializer,s),o=i.getIndexManager(s);return new sb(r,sr.wt(s,this.serializer,o,i.referenceDelegate),a,o).recalculateAndSaveOverlaysForDocumentKeys(new tC(t,ek.ce),e).next()})})}}function sL(e){e.createObjectStore(e5,{keyPath:e6}).createIndex(e3,e8,{unique:!0}),e.createObjectStore(e1,{keyPath:"targetId"}).createIndex(e2,e4,{unique:!0}),e.createObjectStore(e7)}let sU="IndexedDbPersistence",sq="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class sB{constructor(e,t,n,r,i,s,a,o,l,u,h=18){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.Ci=i,this.window=s,this.document=a,this.Fi=l,this.Mi=u,this.xi=h,this.ai=null,this.ui=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Oi=null,this.inForeground=!1,this.Ni=null,this.Bi=null,this.Li=Number.NEGATIVE_INFINITY,this.ki=e=>Promise.resolve(),!sB.v())throw new C(_.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new sm(this,r),this.Ki=t+"main",this.serializer=new iS(o),this.qi=new ev(this.Ki,this.xi,new sP(this.serializer)),this.ci=new iL,this.li=new so(this.referenceDelegate,this.serializer),this.remoteDocumentCache=new sy(this.serializer),this.Pi=new iM,this.window&&this.window.localStorage?this.Ui=this.window.localStorage:(this.Ui=null,!1===u&&I(sU,"LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.$i().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new C(_.FAILED_PRECONDITION,sq);return this.Wi(),this.Qi(),this.Gi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.li.getHighestSequenceNumber(e))}).then(e=>{this.ai=new ek(e,this.Fi)}).then(()=>{this.ui=!0}).catch(e=>(this.qi&&this.qi.close(),Promise.reject(e)))}zi(e){return this.ki=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.qi.q(async t=>{null===t.newVersion&&await e()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Ci.enqueueAndForget(async()=>{this.started&&await this.$i()}))}$i(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>tN(e,tn).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.ji(e).next(e=>{e||(this.isPrimary=!1,this.Ci.enqueueRetryable(()=>this.ki(!1)))})}).next(()=>this.Hi(e)).next(t=>this.isPrimary&&!t?this.Ji(e).next(()=>!1):!!t&&this.Zi(e).next(()=>!0))).catch(e=>{if(eb(e))return v(sU,"Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return v(sU,"Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.Ci.enqueueRetryable(()=>this.ki(e)),this.isPrimary=e})}ji(e){return tN(e,eL).get(eU).next(e=>ep.resolve(this.Xi(e)))}Yi(e){return tN(e,tn).delete(this.clientId)}async es(){if(this.isPrimary&&!this.ts(this.Li,18e5)){this.Li=Date.now();let e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{let t=tN(e,tn);return t.H().next(e=>{let n=this.ns(e,18e5),r=e.filter(e=>-1===n.indexOf(e));return ep.forEach(r,e=>t.delete(e.clientId)).next(()=>r)})}).catch(()=>[]);if(this.Ui)for(let t of e)this.Ui.removeItem(this.rs(t.clientId))}}Gi(){this.Bi=this.Ci.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.$i().then(()=>this.es()).then(()=>this.Gi()))}Xi(e){return!!e&&e.ownerId===this.clientId}Hi(e){return this.Mi?ep.resolve(!0):tN(e,eL).get(eU).next(t=>{if(null!==t&&this.ts(t.leaseTimestampMs,5e3)&&!this.ss(t.ownerId)){if(this.Xi(t)&&this.networkEnabled)return!0;if(!this.Xi(t)){if(!t.allowTabSynchronization)throw new C(_.FAILED_PRECONDITION,sq);return!1}}return!(!this.networkEnabled||!this.inForeground)||tN(e,tn).H().next(e=>void 0===this.ns(e,5e3).find(e=>{if(this.clientId!==e.clientId){let t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&v(sU,`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.ui=!1,this._s(),this.Bi&&(this.Bi.cancel(),this.Bi=null),this.us(),this.cs(),await this.qi.runTransaction("shutdown","readwrite",[eL,tn],e=>{let t=new tC(e,ek.ce);return this.Ji(t).next(()=>this.Yi(t))}),this.qi.close(),this.ls()}ns(e,t){return e.filter(e=>this.ts(e.updateTimeMs,t)&&!this.ss(e.clientId))}hs(){return this.runTransaction("getActiveClients","readonly",e=>tN(e,tn).H().next(e=>this.ns(e,18e5).map(e=>e.clientId)))}get started(){return this.ui}getGlobalsCache(){return this.ci}getMutationQueue(e,t){return sr.wt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.li}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new i8(e,this.serializer.yt.databaseId)}getDocumentOverlayCache(e){return iP.wt(this.serializer,e)}getBundleCache(){return this.Pi}runTransaction(e,t,n){var r;let i;v(sU,"Starting transaction:",e);let s=18===(r=this.xi)?t_:17===r?t_:16===r?tx:15===r?tx:14===r?tS:13===r?tS:12===r?tb:11===r?tE:void b(60245);return this.qi.runTransaction(e,"readonly"===t?"readonly":"readwrite",s,r=>(i=new tC(r,this.ai?this.ai.next():ek.ce),"readwrite-primary"===t?this.ji(i).next(e=>!!e||this.Hi(i)).next(t=>{if(!t)throw I(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.Ci.enqueueRetryable(()=>this.ki(!1)),new C(_.FAILED_PRECONDITION,ef);return n(i)}).next(e=>this.Zi(i).next(()=>e)):this.Ps(i).next(()=>n(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}Ps(e){return tN(e,eL).get(eU).next(e=>{if(null!==e&&this.ts(e.leaseTimestampMs,5e3)&&!this.ss(e.ownerId)&&!this.Xi(e)&&!(this.Mi||this.allowTabSynchronization&&e.allowTabSynchronization))throw new C(_.FAILED_PRECONDITION,sq)})}Zi(e){let t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return tN(e,eL).put(eU,t)}static v(){return ev.v()}Ji(e){let t=tN(e,eL);return t.get(eU).next(e=>this.Xi(e)?(v(sU,"Releasing primary lease."),t.delete(eU)):ep.resolve())}ts(e,t){let n=Date.now();return!(e<n-t)&&(!(e>n)||(I(`Detected an update time that is in the future: ${e} > ${n}`),!1))}Wi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ni=()=>{this.Ci.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.$i()))},this.document.addEventListener("visibilitychange",this.Ni),this.inForeground="visible"===this.document.visibilityState)}us(){this.Ni&&(this.document.removeEventListener("visibilitychange",this.Ni),this.Ni=null)}Qi(){"function"==typeof this.window?.addEventListener&&(this.Oi=()=>{this._s();let e=/(?:Version|Mobile)\/1[456]/;(0,l.nr)()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.Ci.enterRestrictedMode(!0),this.Ci.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Oi))}cs(){this.Oi&&(this.window.removeEventListener("pagehide",this.Oi),this.Oi=null)}ss(e){try{let t=null!==this.Ui?.getItem(this.rs(e));return v(sU,`Client '${e}' ${t?"is":"is not"} zombied in LocalStorage`),t}catch(e){return I(sU,"Failed to get zombied client id.",e),!1}}_s(){if(this.Ui)try{this.Ui.setItem(this.rs(this.clientId),String(Date.now()))}catch(e){I("Failed to set zombie client id.",e)}}ls(){if(this.Ui)try{this.Ui.removeItem(this.rs(this.clientId))}catch(e){}}rs(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}class sz{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Ts=n,this.Is=r}static Es(e,t){let n=rl(),r=rl();for(let e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new sz(e,t.fromCache,n,r)}}class sK{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class s${constructor(){this.Rs=!1,this.As=!1,this.Vs=100,this.ds=(0,l.nr)()?8:eI((0,l.ZQ)())>0?6:4}initialize(e,t){this.fs=e,this.indexManager=t,this.Rs=!0}getDocumentsMatchingQuery(e,t,n,r){let i={result:null};return this.gs(e,t).next(e=>{i.result=e}).next(()=>{if(!i.result)return this.ps(e,t,r,n).next(e=>{i.result=e})}).next(()=>{if(i.result)return;let n=new sK;return this.ys(e,t,n).next(r=>{if(i.result=r,this.As)return this.ws(e,t,n,r.size)})}).next(()=>i.result)}ws(e,t,n,r){return n.documentReadCount<this.Vs?(w()<=h.$b.DEBUG&&v("QueryEngine","SDK will not create cache indexes for query:",n3(t),"since it only creates cache indexes for collection contains","more than or equal to",this.Vs,"documents"),ep.resolve()):(w()<=h.$b.DEBUG&&v("QueryEngine","Query:",n3(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.ds*r?(w()<=h.$b.DEBUG&&v("QueryEngine","The SDK decides to create cache indexes for query:",n3(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,nX(t))):ep.resolve())}gs(e,t){if(nY(t))return ep.resolve(null);let n=nX(t);return this.indexManager.getIndexType(e,n).next(r=>0===r?null:(null!==t.limit&&1===r&&(n=nX(t=n1(t,null,"F"))),this.indexManager.getDocumentsMatchingTarget(e,n).next(r=>{let i=rl(...r);return this.fs.getDocuments(e,i).next(r=>this.indexManager.getMinOffset(e,n).next(n=>{let s=this.bs(t,r);return this.Ss(t,s,i,n.readTime)?this.gs(e,n1(t,null,"F")):this.Ds(e,s,t,n)}))})))}ps(e,t,n,r){return nY(t)||r.isEqual(er.min())?ep.resolve(null):this.fs.getDocuments(e,n).next(i=>{let s=this.bs(t,i);return this.Ss(t,s,n,r)?ep.resolve(null):(w()<=h.$b.DEBUG&&v("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),n3(t)),this.Ds(e,s,t,eu(r,-1)).next(e=>e))})}bs(e,t){let n=new tF(n7(e));return t.forEach((t,r)=>{n8(e,r)&&(n=n.add(r))}),n}Ss(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;let i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(r)>0)}ys(e,t,n){return w()<=h.$b.DEBUG&&v("QueryEngine","Using full collection scan to execute query:",n3(t)),this.fs.getDocumentsMatchingQuery(e,t,ec.min(),n)}Ds(e,t,n,r){return this.fs.getDocumentsMatchingQuery(e,n,r).next(e=>(t.forEach(t=>{e=e.insert(t.key,t)}),e))}}let sG="LocalStore";class sj{constructor(e,t,n,r){this.persistence=e,this.Cs=t,this.serializer=r,this.vs=new tV(L),this.Fs=new re(e=>nB(e),nz),this.Ms=new Map,this.xs=e.getRemoteDocumentCache(),this.li=e.getTargetCache(),this.Pi=e.getBundleCache(),this.Os(n)}Os(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new sb(this.xs,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.xs.setIndexManager(this.indexManager),this.Cs.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.vs))}}async function sQ(e,t){return await e.persistence.runTransaction("Handle user change","readonly",n=>{let r;return e.mutationQueue.getAllMutationBatches(n).next(i=>(r=i,e.Os(t),e.mutationQueue.getAllMutationBatches(n))).next(t=>{let i=[],s=[],a=rl();for(let e of r)for(let t of(i.push(e.batchId),e.mutations))a=a.add(t.key);for(let e of t)for(let t of(s.push(e.batchId),e.mutations))a=a.add(t.key);return e.localDocuments.getDocuments(n,a).next(e=>({Ns:e,removedBatchIds:i,addedBatchIds:s}))})})}function sH(e){return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.li.getLastRemoteSnapshotVersion(t))}function sY(e,t,n){let r=rl(),i=rl();return n.forEach(e=>r=r.add(e)),t.getEntries(e,r).next(e=>{let r=rt;return n.forEach((n,s)=>{let a=e.get(n);s.isFoundDocument()!==a.isFoundDocument()&&(i=i.add(n)),s.isNoDocument()&&s.version.isEqual(er.min())?(t.removeEntry(n,s.readTime),r=r.insert(n,s)):!a.isValidDocument()||s.version.compareTo(a.version)>0||0===s.version.compareTo(a.version)&&a.hasPendingWrites?(t.addEntry(s),r=r.insert(n,s)):v(sG,"Ignoring outdated watch update for ",n,". Current version:",a.version," Watch version:",s.version)}),{Bs:r,Ls:i}})}function sW(e,t){return e.persistence.runTransaction("Allocate target","readwrite",n=>{let r;return e.li.getTargetData(n,t).next(i=>i?(r=i,ep.resolve(r)):e.li.allocateTargetId(n).next(i=>(r=new ib(t,i,"TargetPurposeListen",n.currentSequenceNumber),e.li.addTargetData(n,r).next(()=>r))))}).then(n=>{let r=e.vs.get(n.targetId);return(null===r||n.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(e.vs=e.vs.insert(n.targetId,n),e.Fs.set(t,n.targetId)),n})}async function sJ(e,t,n){let r=e.vs.get(t);try{n||await e.persistence.runTransaction("Release target",n?"readwrite":"readwrite-primary",t=>e.persistence.referenceDelegate.removeTarget(t,r))}catch(e){if(!eb(e))throw e;v(sG,`Failed to update sequence numbers for target ${t}: ${e}`)}e.vs=e.vs.remove(t),e.Fs.delete(r.target)}function sX(e,t,n){let r=er.min(),i=rl();return e.persistence.runTransaction("Execute query","readwrite",s=>(function(e,t,n){let r=e.Fs.get(n);return void 0!==r?ep.resolve(e.vs.get(r)):e.li.getTargetData(t,n)})(e,s,nX(t)).next(t=>{if(t)return r=t.lastLimboFreeSnapshotVersion,e.li.getMatchingKeysForTargetId(s,t.targetId).next(e=>{i=e})}).next(()=>e.Cs.getDocumentsMatchingQuery(s,t,n?r:er.min(),n?i:rl())).next(n=>(s1(e,n9(t),n),{documents:n,ks:i})))}function sZ(e,t){let n=e.li,r=e.vs.get(t);return r?Promise.resolve(r.target):e.persistence.runTransaction("Get target data","readonly",e=>n.At(e,t).next(e=>e?e.target:null))}function s0(e,t){let n=e.Ms.get(t)||er.min();return e.persistence.runTransaction("Get new document changes","readonly",r=>e.xs.getAllFromCollectionGroup(r,t,eu(n,-1),Number.MAX_SAFE_INTEGER)).then(n=>(s1(e,t,n),n))}function s1(e,t,n){let r=e.Ms.get(t)||er.min();n.forEach((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)}),e.Ms.set(t,r)}let s2="firestore_clients";function s4(e,t){return`${s2}_${e}_${t}`}let s5="firestore_mutations";function s6(e,t,n){let r=`${s5}_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}let s3="firestore_targets";function s8(e,t){return`${s3}_${e}_${t}`}let s9="SharedClientState";class s7{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static $s(e,t,n){let r=JSON.parse(n),i,s="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return s&&r.error&&(s="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(i=new C(r.error.code,r.error.message)),s?new s7(e,t,r.state,i):(I(s9,`Failed to parse mutation state for ID '${t}': ${n}`),null)}Ws(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class ae{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static $s(e,t){let n=JSON.parse(t),r,i="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return i&&n.error&&(i="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(r=new C(n.error.code,n.error.message)),i?new ae(e,n.state,r):(I(s9,`Failed to parse target state for ID '${e}': ${t}`),null)}Ws(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class at{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static $s(e,t){let n=JSON.parse(t),r="object"==typeof n&&n.activeTargetIds instanceof Array,i=ru;for(let e=0;r&&e<n.activeTargetIds.length;++e)r=eO(n.activeTargetIds[e]),i=i.add(n.activeTargetIds[e]);return r?new at(e,i):(I(s9,`Failed to parse client data for instance '${e}': ${t}`),null)}}class an{constructor(e,t){this.clientId=e,this.onlineState=t}static $s(e){let t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new an(t.clientId,t.onlineState):(I(s9,`Failed to parse online state: ${e}`),null)}}class ar{constructor(){this.activeTargetIds=ru}Qs(e){this.activeTargetIds=this.activeTargetIds.add(e)}Gs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Ws(){return JSON.stringify({activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()})}}class ai{constructor(){this.vo=new ar,this.Fo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e,t=!0){return t&&this.vo.Qs(e),this.Fo[e]||"not-current"}updateQueryState(e,t,n){this.Fo[e]=t}removeLocalQueryTarget(e){this.vo.Gs(e)}isLocalQueryTarget(e){return this.vo.activeTargetIds.has(e)}clearQueryState(e){delete this.Fo[e]}getAllActiveQueryTargets(){return this.vo.activeTargetIds}isActiveQueryTarget(e){return this.vo.activeTargetIds.has(e)}start(){return this.vo=new ar,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class as{Mo(e){}shutdown(){}}let aa="ConnectivityMonitor";class ao{constructor(){this.xo=()=>this.Oo(),this.No=()=>this.Bo(),this.Lo=[],this.ko()}Mo(e){this.Lo.push(e)}shutdown(){window.removeEventListener("online",this.xo),window.removeEventListener("offline",this.No)}ko(){window.addEventListener("online",this.xo),window.addEventListener("offline",this.No)}Oo(){for(let e of(v(aa,"Network connectivity changed: AVAILABLE"),this.Lo))e(0)}Bo(){for(let e of(v(aa,"Network connectivity changed: UNAVAILABLE"),this.Lo))e(1)}static v(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let al=null;function au(){return null===al?al=0x10000000+Math.round(0x80000000*Math.random()):al++,"0x"+al.toString(16)}let ah="RestConnection",ac={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery",ExecutePipeline:"executePipeline"};class ad{get Ko(){return!1}constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;let t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.qo=t+"://"+e.host,this.Uo=`projects/${n}/databases/${r}`,this.$o=this.databaseId.database===tZ?`project_id=${n}`:`project_id=${n}&database_id=${r}`}Wo(e,t,n,r,i){let s=au(),a=this.Qo(e,t.toUriEncodedString());v(ah,`Sending RPC '${e}' ${s}:`,a,n);let o={"google-cloud-resource-prefix":this.Uo,"x-goog-request-params":this.$o};this.Go(o,r,i);let{host:u}=new URL(a),h=(0,l.zJ)(u);return this.zo(e,a,o,n,h).then(t=>(v(ah,`Received RPC '${e}' ${s}: `,t),t),t=>{throw T(ah,`RPC '${e}' ${s} failed with error: `,t,"url: ",a,"request:",n),t})}jo(e,t,n,r,i,s){return this.Wo(e,t,n,r,i)}Go(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+g,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach((t,n)=>e[n]=t),n&&n.headers.forEach((t,n)=>e[n]=t)}Qo(e,t){let n=ac[e],r=`${this.qo}/v1/${t}:${n}`;return this.databaseInfo.apiKey&&(r=`${r}?key=${encodeURIComponent(this.databaseInfo.apiKey)}`),r}terminate(){}}class af{constructor(e){this.Ho=e.Ho,this.Jo=e.Jo}Zo(e){this.Xo=e}Yo(e){this.e_=e}t_(e){this.n_=e}onMessage(e){this.r_=e}close(){this.Jo()}send(e){this.Ho(e)}i_(){this.Xo()}s_(){this.e_()}o_(e){this.n_(e)}__(e){this.r_(e)}}let am="WebChannelConnection",ag=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};class ap extends ad{constructor(e){super(e),this.a_=[],this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}static u_(){ap.c_||(ag((0,c.Ao)(),c.Jh.STAT_EVENT,e=>{e.stat===c.ro.PROXY?v(am,"STAT_EVENT: detected buffering proxy"):e.stat===c.ro.NOPROXY&&v(am,"STAT_EVENT: detected no buffering proxy")}),ap.c_=!0)}zo(e,t,n,r,i){let s=au();return new Promise((i,a)=>{let o=new c.ZS;o.setWithCredentials(!0),o.listenOnce(c.Bx.COMPLETE,()=>{try{switch(o.getLastErrorCode()){case c.O4.NO_ERROR:let t=o.getResponseJson();v(am,`XHR for RPC '${e}' ${s} received:`,JSON.stringify(t)),i(t);break;case c.O4.TIMEOUT:v(am,`RPC '${e}' ${s} timed out`),a(new C(_.DEADLINE_EXCEEDED,"Request time out"));break;case c.O4.HTTP_ERROR:let n=o.getStatus();if(v(am,`RPC '${e}' ${s} failed with status:`,n,"response text:",o.getResponseText()),n>0){let e=o.getResponseJson();Array.isArray(e)&&(e=e[0]);let t=e?.error;if(t&&t.status&&t.message){let e=function(e){let t=e.toLowerCase().replace(/_/g,"-");return Object.values(_).indexOf(t)>=0?t:_.UNKNOWN}(t.status);a(new C(e,t.message))}else a(new C(_.UNKNOWN,"Server responded with status "+o.getStatus()))}else a(new C(_.UNAVAILABLE,"Connection failed."));break;default:b(9055,{l_:e,streamId:s,h_:o.getLastErrorCode(),P_:o.getLastError()})}}finally{v(am,`RPC '${e}' ${s} completed.`)}});let l=JSON.stringify(r);v(am,`RPC '${e}' ${s} sending request:`,r),o.send(t,"POST",l,n,15)})}T_(e,t,n){let i=au(),s=[this.qo,"/","google.firestore.v1.Firestore","/",e,"/channel"],a=this.createWebChannelTransport(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},l=this.longPollingOptions.timeoutSeconds;void 0!==l&&(o.longPollingTimeout=Math.round(1e3*l)),this.useFetchStreams&&(o.useFetchStreams=!0),this.Go(o.initMessageHeaders,t,n),o.encodeInitMessageHeaders=!0;let u=s.join("");v(am,`Creating RPC '${e}' stream ${i}: ${u}`,o);let h=a.createWebChannel(u,o);this.I_(h);let d=!1,f=!1,m=new af({Ho:t=>{f?v(am,`Not sending because RPC '${e}' stream ${i} is closed:`,t):(d||(v(am,`Opening RPC '${e}' stream ${i} transport.`),h.open(),d=!0),v(am,`RPC '${e}' stream ${i} sending:`,t),h.send(t))},Jo:()=>h.close()});return ag(h,c.iO.EventType.OPEN,()=>{f||(v(am,`RPC '${e}' stream ${i} transport opened.`),m.i_())}),ag(h,c.iO.EventType.CLOSE,()=>{f||(f=!0,v(am,`RPC '${e}' stream ${i} transport closed`),m.o_(),this.E_(h))}),ag(h,c.iO.EventType.ERROR,t=>{f||(f=!0,T(am,`RPC '${e}' stream ${i} transport errored. Name:`,t.name,"Message:",t.message),m.o_(new C(_.UNAVAILABLE,"The operation could not be completed")))}),ag(h,c.iO.EventType.MESSAGE,t=>{if(!f){let n=t.data[0];x(!!n,16349);let s=n?.error||n[0]?.error;if(s){v(am,`RPC '${e}' stream ${i} received error:`,s);let t=s.status,n=function(e){let t=r[e];if(void 0!==t)return rz(t)}(t),a=s.message;"NOT_FOUND"===t&&a.includes("database")&&a.includes("does not exist")&&a.includes(this.databaseId.database)&&T(`Database '${this.databaseId.database}' not found. Please check your project configuration.`),void 0===n&&(n=_.INTERNAL,a="Unknown error status: "+t+" with message "+s.message),f=!0,m.o_(new C(n,a)),h.close()}else v(am,`RPC '${e}' stream ${i} received:`,n),m.__(n)}}),ap.u_(),setTimeout(()=>{m.s_()},0),m}terminate(){this.a_.forEach(e=>e.close()),this.a_=[]}I_(e){this.a_.push(e)}E_(e){this.a_=this.a_.filter(t=>t===e)}Go(e,t,n){super.Go(e,t,n),this.databaseInfo.apiKey&&(e["x-goog-api-key"]=this.databaseInfo.apiKey)}createWebChannelTransport(){return(0,c.fF)()}}function ay(){return"undefined"!=typeof document?document:null}function aw(e){return new r3(e,!0)}ap.c_=!1;class av{constructor(e,t,n=1e3,r=1.5,i=6e4){this.Ci=e,this.timerId=t,this.R_=n,this.A_=r,this.V_=i,this.d_=0,this.m_=null,this.f_=Date.now(),this.reset()}reset(){this.d_=0}g_(){this.d_=this.V_}p_(e){this.cancel();let t=Math.floor(this.d_+this.y_()),n=Math.max(0,Date.now()-this.f_),r=Math.max(0,t-n);r>0&&v("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.d_} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.m_=this.Ci.enqueueAfterDelay(this.timerId,r,()=>(this.f_=Date.now(),e())),this.d_*=this.A_,this.d_<this.R_&&(this.d_=this.R_),this.d_>this.V_&&(this.d_=this.V_)}w_(){null!==this.m_&&(this.m_.skipDelay(),this.m_=null)}cancel(){null!==this.m_&&(this.m_.cancel(),this.m_=null)}y_(){return(Math.random()-.5)*this.d_}}let aI="PersistentStream";class aT{constructor(e,t,n,r,i,s,a,o){this.Ci=e,this.b_=n,this.S_=r,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.D_=0,this.C_=null,this.v_=null,this.stream=null,this.F_=0,this.M_=new av(e,t)}x_(){return 1===this.state||5===this.state||this.O_()}O_(){return 2===this.state||3===this.state}start(){this.F_=0,4!==this.state?this.auth():this.N_()}async stop(){this.x_()&&await this.close(0)}B_(){this.state=0,this.M_.reset()}L_(){this.O_()&&null===this.C_&&(this.C_=this.Ci.enqueueAfterDelay(this.b_,6e4,()=>this.k_()))}K_(e){this.q_(),this.stream.send(e)}async k_(){if(this.O_())return this.close(0)}q_(){this.C_&&(this.C_.cancel(),this.C_=null)}U_(){this.v_&&(this.v_.cancel(),this.v_=null)}async close(e,t){this.q_(),this.U_(),this.M_.cancel(),this.D_++,4!==e?this.M_.reset():t&&t.code===_.RESOURCE_EXHAUSTED?(I(t.toString()),I("Using maximum backoff delay to prevent overloading the backend."),this.M_.g_()):t&&t.code===_.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.W_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.t_(t)}W_(){}auth(){this.state=1;let e=this.Q_(this.D_),t=this.D_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,n])=>{this.D_===t&&this.G_(e,n)},t=>{e(()=>{let e=new C(_.UNKNOWN,"Fetching auth token failed: "+t.message);return this.z_(e)})})}G_(e,t){let n=this.Q_(this.D_);this.stream=this.j_(e,t),this.stream.Zo(()=>{n(()=>this.listener.Zo())}),this.stream.Yo(()=>{n(()=>(this.state=2,this.v_=this.Ci.enqueueAfterDelay(this.S_,1e4,()=>(this.O_()&&(this.state=3),Promise.resolve())),this.listener.Yo()))}),this.stream.t_(e=>{n(()=>this.z_(e))}),this.stream.onMessage(e=>{n(()=>1==++this.F_?this.H_(e):this.onNext(e))})}N_(){this.state=5,this.M_.p_(async()=>{this.state=0,this.start()})}z_(e){return v(aI,`close with error: ${e}`),this.stream=null,this.close(4,e)}Q_(e){return t=>{this.Ci.enqueueAndForget(()=>this.D_===e?t():(v(aI,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class aE extends aT{constructor(e,t,n,r,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}j_(e,t){return this.connection.T_("Listen",e,t)}H_(e){return this.onNext(e)}onNext(e){this.M_.reset();let t=function(e,t){let n;if("targetChange"in t){var r,i;t.targetChange;let s="NO_CHANGE"===(r=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===r?1:"REMOVE"===r?2:"CURRENT"===r?3:"RESET"===r?4:b(39313,{state:r}),a=t.targetChange.targetIds||[],o=(i=t.targetChange.resumeToken,e.useProto3Json?(x(void 0===i||"string"==typeof i,58123),tq.fromBase64String(i||"")):(x(void 0===i||i instanceof f||i instanceof Uint8Array,16193),tq.fromUint8Array(i||new Uint8Array))),l=t.targetChange.cause;n=new rX(s,a,o,l&&new C(void 0===l.code?_.UNKNOWN:rz(l.code),l.message||"")||null)}else if("documentChange"in t){t.documentChange;let r=t.documentChange;r.document,r.document.name,r.document.updateTime;let i=ia(e,r.document.name),s=ie(r.document.updateTime),a=r.document.createTime?ie(r.document.createTime):er.min(),o=new ny({mapValue:{fields:r.document.fields}}),l=nw.newFoundDocument(i,s,a,o);n=new rW(r.targetIds||[],r.removedTargetIds||[],l.key,l)}else if("documentDelete"in t){t.documentDelete;let r=t.documentDelete;r.document;let i=ia(e,r.document),s=r.readTime?ie(r.readTime):er.min(),a=nw.newNoDocument(i,s);n=new rW([],r.removedTargetIds||[],a.key,a)}else if("documentRemove"in t){t.documentRemove;let r=t.documentRemove;r.document;let i=ia(e,r.document);n=new rW([],r.removedTargetIds||[],i,null)}else{if(!("filter"in t))return b(11601,{Vt:t});{t.filter;let e=t.filter;e.targetId;let{count:r=0,unchangedNames:i}=e,s=new rB(r,i);n=new rJ(e.targetId,s)}}return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return er.min();let t=e.targetChange;return t.targetIds&&t.targetIds.length?er.min():t.readTime?ie(t.readTime):er.min()}(e);return this.listener.J_(t,n)}Z_(e){let t={};t.database=iu(this.serializer),t.addTarget=function(e,t){let n;let r=t.target;if((n=nK(r)?{documents:ip(e,r)}:{query:iy(e,r).ft}).targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=r7(e,t.resumeToken);let r=r8(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(t.snapshotVersion.compareTo(er.min())>0){n.readTime=r9(e,t.snapshotVersion.toTimestamp());let r=r8(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);let n=function(e,t){let n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return b(28987,{purpose:e})}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,e);n&&(t.labels=n),this.K_(t)}X_(e){let t={};t.database=iu(this.serializer),t.removeTarget=e,this.K_(t)}}class ab extends aT{constructor(e,t,n,r,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}get Y_(){return this.F_>0}start(){this.lastStreamToken=void 0,super.start()}W_(){this.Y_&&this.ea([])}j_(e,t){return this.connection.T_("Write",e,t)}H_(e){return x(!!e.streamToken,31322),this.lastStreamToken=e.streamToken,x(!e.writeResults||0===e.writeResults.length,55816),this.listener.ta()}onNext(e){var t,n;x(!!e.streamToken,12678),this.lastStreamToken=e.streamToken,this.M_.reset();let r=(t=e.writeResults,n=e.commitTime,t&&t.length>0?(x(void 0!==n,14353),t.map(e=>{let t;return(t=e.updateTime?ie(e.updateTime):ie(n)).isEqual(er.min())&&(t=ie(n)),new rS(t,e.transformResults||[])})):[]),i=ie(e.commitTime);return this.listener.na(i,r)}ra(){let e={};e.database=iu(this.serializer),this.K_(e)}ea(e){let t={streamToken:this.lastStreamToken,writes:e.map(e=>im(this.serializer,e))};this.K_(t)}}class aS{}class ax extends aS{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.ia=!1}sa(){if(this.ia)throw new C(_.FAILED_PRECONDITION,"The client has already been terminated.")}Wo(e,t,n,r){return this.sa(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([i,s])=>this.connection.Wo(e,ir(t,n),r,i,s)).catch(e=>{throw"FirebaseError"===e.name?(e.code===_.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new C(_.UNKNOWN,e.toString())})}jo(e,t,n,r,i){return this.sa(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,a])=>this.connection.jo(e,ir(t,n),r,s,a,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===_.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new C(_.UNKNOWN,e.toString())})}terminate(){this.ia=!0,this.connection.terminate()}}class a_{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.oa=0,this._a=null,this.aa=!0}ua(){0===this.oa&&(this.ca("Unknown"),this._a=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this._a=null,this.la("Backend didn't respond within 10 seconds."),this.ca("Offline"),Promise.resolve())))}ha(e){"Online"===this.state?this.ca("Unknown"):(this.oa++,this.oa>=1&&(this.Pa(),this.la(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.ca("Offline")))}set(e){this.Pa(),this.oa=0,"Online"===e&&(this.aa=!1),this.ca(e)}ca(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}la(e){let t=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.aa?(I(t),this.aa=!1):v("OnlineStateTracker",t)}Pa(){null!==this._a&&(this._a.cancel(),this._a=null)}}let aC="RemoteStore";class aN{constructor(e,t,n,r,i){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.Ta=[],this.Ia=new Map,this.Ea=new Set,this.Ra=[],this.Aa=i,this.Aa.Mo(e=>{n.enqueueAndForget(async()=>{aP(this)&&(v(aC,"Restarting streams for network reachability change."),await async function(e){e.Ea.add(4),await aA(e),e.Va.set("Unknown"),e.Ea.delete(4),await aD(e)}(this))})}),this.Va=new a_(n,r)}}async function aD(e){if(aP(e))for(let t of e.Ra)await t(!0)}async function aA(e){for(let t of e.Ra)await t(!1)}function ak(e,t){e.Ia.has(t.targetId)||(e.Ia.set(t.targetId,t),aM(e)?aF(e):aZ(e).O_()&&aR(e,t))}function aV(e,t){let n=aZ(e);e.Ia.delete(t),n.O_()&&aO(e,t),0===e.Ia.size&&(n.O_()?n.L_():aP(e)&&e.Va.set("Unknown"))}function aR(e,t){if(e.da.$e(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(er.min())>0){let n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}aZ(e).Z_(t)}function aO(e,t){e.da.$e(t),aZ(e).X_(t)}function aF(e){e.da=new r0({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),At:t=>e.Ia.get(t)||null,ht:()=>e.datastore.serializer.databaseId}),aZ(e).start(),e.Va.ua()}function aM(e){return aP(e)&&!aZ(e).x_()&&e.Ia.size>0}function aP(e){return 0===e.Ea.size}async function aL(e){e.Va.set("Online")}async function aU(e){e.Ia.forEach((t,n)=>{aR(e,t)})}async function aq(e,t){e.da=void 0,aM(e)?(e.Va.ha(t),aF(e)):e.Va.set("Unknown")}async function aB(e,t,n){if(e.Va.set("Online"),t instanceof rX&&2===t.state&&t.cause)try{await async function(e,t){let n=t.cause;for(let r of t.targetIds)e.Ia.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.Ia.delete(r),e.da.removeTarget(r))}(e,t)}catch(n){v(aC,"Failed to remove targets %s: %s ",t.targetIds.join(","),n),await az(e,n)}else if(t instanceof rW?e.da.Xe(t):t instanceof rJ?e.da.st(t):e.da.tt(t),!n.isEqual(er.min()))try{let t=await sH(e.localStore);n.compareTo(t)>=0&&await function(e,t){let n=e.da.Tt(t);return n.targetChanges.forEach((n,r)=>{if(n.resumeToken.approximateByteSize()>0){let i=e.Ia.get(r);i&&e.Ia.set(r,i.withResumeToken(n.resumeToken,t))}}),n.targetMismatches.forEach((t,n)=>{let r=e.Ia.get(t);if(!r)return;e.Ia.set(t,r.withResumeToken(tq.EMPTY_BYTE_STRING,r.snapshotVersion)),aO(e,t);let i=new ib(r.target,t,n,r.sequenceNumber);aR(e,i)}),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){v(aC,"Failed to raise snapshot:",t),await az(e,t)}}async function az(e,t,n){if(!eb(t))throw t;e.Ea.add(1),await aA(e),e.Va.set("Offline"),n||(n=()=>sH(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{v(aC,"Retrying IndexedDB access"),await n(),e.Ea.delete(1),await aD(e)})}function aK(e,t){return t().catch(n=>az(e,n,t))}async function a$(e){let t=a0(e),n=e.Ta.length>0?e.Ta[e.Ta.length-1].batchId:-1;for(;aP(e)&&e.Ta.length<10;)try{let r=await function(e,t){return e.persistence.runTransaction("Get next mutation batch","readonly",n=>(void 0===t&&(t=-1),e.mutationQueue.getNextMutationBatchAfterBatchId(n,t)))}(e.localStore,n);if(null===r){0===e.Ta.length&&t.L_();break}n=r.batchId,function(e,t){e.Ta.push(t);let n=a0(e);n.O_()&&n.Y_&&n.ea(t.mutations)}(e,r)}catch(t){await az(e,t)}aG(e)&&aj(e)}function aG(e){return aP(e)&&!a0(e).x_()&&e.Ta.length>0}function aj(e){a0(e).start()}async function aQ(e){a0(e).ra()}async function aH(e){let t=a0(e);for(let n of e.Ta)t.ea(n.mutations)}async function aY(e,t,n){let r=e.Ta.shift(),i=rU.from(r,t,n);await aK(e,()=>e.remoteSyncer.applySuccessfulWrite(i)),await a$(e)}async function aW(e,t){t&&a0(e).Y_&&await async function(e,t){var n;if(function(e){switch(e){case _.OK:return b(64938);case _.CANCELLED:case _.UNKNOWN:case _.DEADLINE_EXCEEDED:case _.RESOURCE_EXHAUSTED:case _.INTERNAL:case _.UNAVAILABLE:case _.UNAUTHENTICATED:return!1;case _.INVALID_ARGUMENT:case _.NOT_FOUND:case _.ALREADY_EXISTS:case _.PERMISSION_DENIED:case _.FAILED_PRECONDITION:case _.ABORTED:case _.OUT_OF_RANGE:case _.UNIMPLEMENTED:case _.DATA_LOSS:return!0;default:return b(15467,{code:e})}}(n=t.code)&&n!==_.ABORTED){let n=e.Ta.shift();a0(e).B_(),await aK(e,()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t)),await a$(e)}}(e,t),aG(e)&&aj(e)}async function aJ(e,t){e.asyncQueue.verifyOperationInProgress(),v(aC,"RemoteStore received new credentials");let n=aP(e);e.Ea.add(3),await aA(e),n&&e.Va.set("Unknown"),await e.remoteSyncer.handleCredentialChange(t),e.Ea.delete(3),await aD(e)}async function aX(e,t){t?(e.Ea.delete(2),await aD(e)):t||(e.Ea.add(2),await aA(e),e.Va.set("Unknown"))}function aZ(e){var t,n,r;return e.ma||(e.ma=(t=e.datastore,n=e.asyncQueue,r={Zo:aL.bind(null,e),Yo:aU.bind(null,e),t_:aq.bind(null,e),J_:aB.bind(null,e)},t.sa(),new aE(n,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,r)),e.Ra.push(async t=>{t?(e.ma.B_(),aM(e)?aF(e):e.Va.set("Unknown")):(await e.ma.stop(),e.da=void 0)})),e.ma}function a0(e){var t,n,r;return e.fa||(e.fa=(t=e.datastore,n=e.asyncQueue,r={Zo:()=>Promise.resolve(),Yo:aQ.bind(null,e),t_:aW.bind(null,e),ta:aH.bind(null,e),na:aY.bind(null,e)},t.sa(),new ab(n,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,r)),e.Ra.push(async t=>{t?(e.fa.B_(),await a$(e)):(await e.fa.stop(),e.Ta.length>0&&(v(aC,`Stopping write stream with ${e.Ta.length} pending writes`),e.Ta=[]))})),e.fa}class a1{constructor(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new N,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,i){let s=new a1(e,t,Date.now()+n,r,i);return s.start(n),s}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new C(_.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function a2(e,t){if(I("AsyncQueue",`${t}: ${e}`),eb(e))return new C(_.UNAVAILABLE,`${t}: ${e}`);throw e}class a4{static emptySet(e){return new a4(e.comparator)}constructor(e){this.comparator=e?(t,n)=>e(t,n)||Q.comparator(t.key,n.key):(e,t)=>Q.comparator(e.key,t.key),this.keyedMap=rr(),this.sortedSet=new tV(this.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){let t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,n)=>(e(t),!1))}add(e){let t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){let t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof a4)||this.size!==e.size)return!1;let t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){let e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){let e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){let n=new a4;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class a5{constructor(){this.ga=new tV(Q.comparator)}track(e){let t=e.doc.key,n=this.ga.get(t);n?0!==e.type&&3===n.type?this.ga=this.ga.insert(t,e):3===e.type&&1!==n.type?this.ga=this.ga.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.ga=this.ga.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.ga=this.ga.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.ga=this.ga.remove(t):1===e.type&&2===n.type?this.ga=this.ga.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.ga=this.ga.insert(t,{type:2,doc:e.doc}):b(63341,{Vt:e,pa:n}):this.ga=this.ga.insert(t,e)}ya(){let e=[];return this.ga.inorderTraversal((t,n)=>{e.push(n)}),e}}class a6{constructor(e,t,n,r,i,s,a,o,l){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=l}static fromInitialDocuments(e,t,n,r,i){let s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new a6(e,t,a4.emptySet(t),s,n,r,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&n5(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;let t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class a3{constructor(){this.wa=void 0,this.ba=[]}Sa(){return this.ba.some(e=>e.Da())}}class a8{constructor(){this.queries=a9(),this.onlineState="Unknown",this.Ca=new Set}terminate(){!function(e,t){let n=e.queries;e.queries=a9(),n.forEach((e,n)=>{for(let e of n.ba)e.onError(t)})}(this,new C(_.ABORTED,"Firestore shutting down"))}}function a9(){return new re(e=>n6(e),n5)}async function a7(e,t){let n=3,r=t.query,i=e.queries.get(r);i?!i.Sa()&&t.Da()&&(n=2):(i=new a3,n=t.Da()?0:1);try{switch(n){case 0:i.wa=await e.onListen(r,!0);break;case 1:i.wa=await e.onListen(r,!1);break;case 2:await e.onFirstRemoteStoreListen(r)}}catch(n){let e=a2(n,`Initialization of query '${n3(t.query)}' failed`);return void t.onError(e)}e.queries.set(r,i),i.ba.push(t),t.va(e.onlineState),i.wa&&t.Fa(i.wa)&&or(e)}async function oe(e,t){let n=t.query,r=3,i=e.queries.get(n);if(i){let e=i.ba.indexOf(t);e>=0&&(i.ba.splice(e,1),0===i.ba.length?r=t.Da()?0:1:!i.Sa()&&t.Da()&&(r=2))}switch(r){case 0:return e.queries.delete(n),e.onUnlisten(n,!0);case 1:return e.queries.delete(n),e.onUnlisten(n,!1);case 2:return e.onLastRemoteStoreUnlisten(n);default:return}}function ot(e,t){let n=!1;for(let r of t){let t=r.query,i=e.queries.get(t);if(i){for(let e of i.ba)e.Fa(r)&&(n=!0);i.wa=r}}n&&or(e)}function on(e,t,n){let r=e.queries.get(t);if(r)for(let e of r.ba)e.onError(n);e.queries.delete(t)}function or(e){e.Ca.forEach(e=>{e.next()})}(a=s||(s={})).Ma="default",a.Cache="cache";class oi{constructor(e,t,n){this.query=e,this.xa=t,this.Oa=!1,this.Na=null,this.onlineState="Unknown",this.options=n||{}}Fa(e){if(!this.options.includeMetadataChanges){let t=[];for(let n of e.docChanges)3!==n.type&&t.push(n);e=new a6(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Oa?this.Ba(e)&&(this.xa.next(e),t=!0):this.La(e,this.onlineState)&&(this.ka(e),t=!0),this.Na=e,t}onError(e){this.xa.error(e)}va(e){this.onlineState=e;let t=!1;return this.Na&&!this.Oa&&this.La(this.Na,e)&&(this.ka(this.Na),t=!0),t}La(e,t){return!(e.fromCache&&this.Da())||(!this.options.Ka||!("Offline"!==t))&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}Ba(e){if(e.docChanges.length>0)return!0;let t=this.Na&&this.Na.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}ka(e){e=a6.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Oa=!0,this.xa.next(e)}Da(){return this.options.source!==s.Cache}}class os{constructor(e){this.key=e}}class oa{constructor(e){this.key=e}}class oo{constructor(e,t){this.query=e,this.Za=t,this.Xa=null,this.hasCachedResults=!1,this.current=!1,this.Ya=rl(),this.mutatedKeys=rl(),this.eu=n7(e),this.tu=new a4(this.eu)}get nu(){return this.Za}ru(e,t){let n=t?t.iu:new a5,r=t?t.tu:this.tu,i=t?t.mutatedKeys:this.mutatedKeys,s=r,a=!1,o="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,l="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal((e,t)=>{let u=r.get(e),h=n8(this.query,t)?t:null,c=!!u&&this.mutatedKeys.has(u.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations),f=!1;u&&h?u.data.isEqual(h.data)?c!==d&&(n.track({type:3,doc:h}),f=!0):this.su(u,h)||(n.track({type:2,doc:h}),f=!0,(o&&this.eu(h,o)>0||l&&0>this.eu(h,l))&&(a=!0)):!u&&h?(n.track({type:0,doc:h}),f=!0):u&&!h&&(n.track({type:1,doc:u}),f=!0,(o||l)&&(a=!0)),f&&(h?(s=s.add(h),i=d?i.add(e):i.delete(e)):(s=s.delete(e),i=i.delete(e)))}),null!==this.query.limit)for(;s.size>this.query.limit;){let e="F"===this.query.limitType?s.last():s.first();s=s.delete(e.key),i=i.delete(e.key),n.track({type:1,doc:e})}return{tu:s,iu:n,Ss:a,mutatedKeys:i}}su(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,r){let i=this.tu;this.tu=e.tu,this.mutatedKeys=e.mutatedKeys;let s=e.iu.ya();s.sort((e,t)=>(function(e,t){let n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return b(20277,{Vt:e})}};return n(e)-n(t)})(e.type,t.type)||this.eu(e.doc,t.doc)),this.ou(n),r=r??!1;let a=t&&!r?this._u():[],o=0===this.Ya.size&&this.current&&!r?1:0,l=o!==this.Xa;return(this.Xa=o,0!==s.length||l)?{snapshot:new a6(this.query,e.tu,i,s,e.mutatedKeys,0===o,l,!1,!!n&&n.resumeToken.approximateByteSize()>0),au:a}:{au:a}}va(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({tu:this.tu,iu:new a5,mutatedKeys:this.mutatedKeys,Ss:!1},!1)):{au:[]}}uu(e){return!this.Za.has(e)&&!!this.tu.has(e)&&!this.tu.get(e).hasLocalMutations}ou(e){e&&(e.addedDocuments.forEach(e=>this.Za=this.Za.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.Za=this.Za.delete(e)),this.current=e.current)}_u(){if(!this.current)return[];let e=this.Ya;this.Ya=rl(),this.tu.forEach(e=>{this.uu(e.key)&&(this.Ya=this.Ya.add(e.key))});let t=[];return e.forEach(e=>{this.Ya.has(e)||t.push(new oa(e))}),this.Ya.forEach(n=>{e.has(n)||t.push(new os(n))}),t}cu(e){this.Za=e.ks,this.Ya=rl();let t=this.ru(e.documents);return this.applyChanges(t,!0)}lu(){return a6.fromInitialDocuments(this.query,this.tu,this.mutatedKeys,0===this.Xa,this.hasCachedResults)}}let ol="SyncEngine";class ou{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class oh{constructor(e){this.key=e,this.hu=!1}}class oc{constructor(e,t,n,r,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.Pu={},this.Tu=new re(e=>n6(e),n5),this.Iu=new Map,this.Eu=new Set,this.Ru=new tV(Q.comparator),this.Au=new Map,this.Vu=new sC,this.du={},this.mu=new Map,this.fu=sa.ar(),this.onlineState="Unknown",this.gu=void 0}get isPrimaryClient(){return!0===this.gu}}async function od(e,t,n=!0){let r;let i=oM(e),s=i.Tu.get(t);return s?(i.sharedClientState.addLocalQueryTarget(s.targetId),r=s.view.lu()):r=await om(i,t,n,!0),r}async function of(e,t){let n=oM(e);await om(n,t,!0,!1)}async function om(e,t,n,r){let i;let s=await sW(e.localStore,nX(t)),a=s.targetId,o=e.sharedClientState.addLocalQueryTarget(a,n);return r&&(i=await og(e,t,a,"current"===o,s.resumeToken)),e.isPrimaryClient&&n&&ak(e.remoteStore,s),i}async function og(e,t,n,r,i){e.pu=(t,n,r)=>(async function(e,t,n,r){let i=t.view.ru(n);i.Ss&&(i=await sX(e.localStore,t.query,!1).then(({documents:e})=>t.view.ru(e,i)));let s=r&&r.targetChanges.get(t.targetId),a=r&&null!=r.targetMismatches.get(t.targetId),o=t.view.applyChanges(i,e.isPrimaryClient,s,a);return oN(e,t.targetId,o.au),o.snapshot})(e,t,n,r);let s=await sX(e.localStore,t,!0),a=new oo(t,s.ks),o=a.ru(s.documents),l=rY.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,i),u=a.applyChanges(o,e.isPrimaryClient,l);oN(e,n,u.au);let h=new ou(t,n,a);return e.Tu.set(t,h),e.Iu.has(n)?e.Iu.get(n).push(t):e.Iu.set(n,[t]),u.snapshot}async function op(e,t,n){let r=e.Tu.get(t),i=e.Iu.get(r.targetId);if(i.length>1)return e.Iu.set(r.targetId,i.filter(e=>!n5(e,t))),void e.Tu.delete(t);e.isPrimaryClient?(e.sharedClientState.removeLocalQueryTarget(r.targetId),e.sharedClientState.isActiveQueryTarget(r.targetId)||await sJ(e.localStore,r.targetId,!1).then(()=>{e.sharedClientState.clearQueryState(r.targetId),n&&aV(e.remoteStore,r.targetId),o_(e,r.targetId)}).catch(eg)):(o_(e,r.targetId),await sJ(e.localStore,r.targetId,!0))}async function oy(e,t){let n=e.Tu.get(t),r=e.Iu.get(n.targetId);e.isPrimaryClient&&1===r.length&&(e.sharedClientState.removeLocalQueryTarget(n.targetId),aV(e.remoteStore,n.targetId))}async function ow(e,t,n){let r=oP(e);try{var i;let e;let s=await function(e,t){let n,r;let i=en.now(),s=t.reduce((e,t)=>e.add(t.key),rl());return e.persistence.runTransaction("Locally write mutations","readwrite",a=>{let o=rt,l=rl();return e.xs.getEntries(a,s).next(e=>{(o=e).forEach((e,t)=>{t.isValidDocument()||(l=l.add(e))})}).next(()=>e.localDocuments.getOverlayedDocuments(a,o)).next(r=>{n=r;let s=[];for(let e of t){let t=function(e,t){let n=null;for(let r of e.fieldTransforms){let e=t.data.field(r.field),i=rm(r.transform,e||null);null!=i&&(null===n&&(n=ny.empty()),n.set(r.field,i))}return n||null}(e,n.get(e.key).overlayedDocument);null!=t&&s.push(new rV(e.key,t,function e(t){let n=[];return tA(t.fields,(t,r)=>{let i=new j([t]);if(nh(r)){let t=e(r.mapValue).fields;if(0===t.length)n.push(i);else for(let e of t)n.push(i.child(e))}else n.push(i)}),new tL(n)}(t.value.mapValue),rx.exists(!0)))}return e.mutationQueue.addMutationBatch(a,i,s,t)}).next(t=>{r=t;let i=t.applyToLocalDocumentSet(n,l);return e.documentOverlayCache.saveOverlays(a,t.batchId,i)})}).then(()=>({batchId:r.batchId,changes:ri(n)}))}(r.localStore,t);r.sharedClientState.addPendingMutation(s.batchId),i=s.batchId,(e=r.du[r.currentUser.toKey()])||(e=new tV(L)),e=e.insert(i,n),r.du[r.currentUser.toKey()]=e,await oA(r,s.changes),await a$(r.remoteStore)}catch(t){let e=a2(t,"Failed to persist write");n.reject(e)}}async function ov(e,t){try{let n=await function(e,t){let n=t.snapshotVersion,r=e.vs;return e.persistence.runTransaction("Apply remote event","readwrite-primary",i=>{let s=e.xs.newChangeBuffer({trackRemovals:!0});r=e.vs;let a=[];t.targetChanges.forEach((s,o)=>{var l;let u=r.get(o);if(!u)return;a.push(e.li.removeMatchingKeys(i,s.removedDocuments,o).next(()=>e.li.addMatchingKeys(i,s.addedDocuments,o)));let h=u.withSequenceNumber(i.currentSequenceNumber);null!==t.targetMismatches.get(o)?h=h.withResumeToken(tq.EMPTY_BYTE_STRING,er.min()).withLastLimboFreeSnapshotVersion(er.min()):s.resumeToken.approximateByteSize()>0&&(h=h.withResumeToken(s.resumeToken,n)),r=r.insert(o,h),l=h,(0===u.resumeToken.approximateByteSize()||l.snapshotVersion.toMicroseconds()-u.snapshotVersion.toMicroseconds()>=3e8||s.addedDocuments.size+s.modifiedDocuments.size+s.removedDocuments.size>0)&&a.push(e.li.updateTargetData(i,h))});let o=rt,l=rl();if(t.documentUpdates.forEach(n=>{t.resolvedLimboDocuments.has(n)&&a.push(e.persistence.referenceDelegate.updateLimboDocument(i,n))}),a.push(sY(i,s,t.documentUpdates).next(e=>{o=e.Bs,l=e.Ls})),!n.isEqual(er.min())){let t=e.li.getLastRemoteSnapshotVersion(i).next(t=>e.li.setTargetsMetadata(i,i.currentSequenceNumber,n));a.push(t)}return ep.waitFor(a).next(()=>s.apply(i)).next(()=>e.localDocuments.getLocalViewOfDocuments(i,o,l)).next(()=>o)}).then(t=>(e.vs=r,t))}(e.localStore,t);t.targetChanges.forEach((t,n)=>{let r=e.Au.get(n);r&&(x(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1,22616),t.addedDocuments.size>0?r.hu=!0:t.modifiedDocuments.size>0?x(r.hu,14607):t.removedDocuments.size>0&&(x(r.hu,42227),r.hu=!1))}),await oA(e,n,t)}catch(e){await eg(e)}}function oI(e,t,n){var r;if(e.isPrimaryClient&&0===n||!e.isPrimaryClient&&1===n){let n;let i=[];e.Tu.forEach((e,n)=>{let r=n.view.va(t);r.snapshot&&i.push(r.snapshot)}),(r=e.eventManager).onlineState=t,n=!1,r.queries.forEach((e,r)=>{for(let e of r.ba)e.va(t)&&(n=!0)}),n&&or(r),i.length&&e.Pu.J_(i),e.onlineState=t,e.isPrimaryClient&&e.sharedClientState.setOnlineState(t)}}async function oT(e,t,n){e.sharedClientState.updateQueryState(t,"rejected",n);let r=e.Au.get(t),i=r&&r.key;if(i){let n=new tV(Q.comparator);n=n.insert(i,nw.newNoDocument(i,er.min()));let r=rl().add(i),s=new rH(er.min(),new Map,new tV(L),n,r);await ov(e,s),e.Ru=e.Ru.remove(i),e.Au.delete(t),oD(e)}else await sJ(e.localStore,t,!1).then(()=>o_(e,t,n)).catch(eg)}async function oE(e,t){var n;let r=t.batch.batchId;try{let i=await (n=e.localStore).persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{let r=t.batch.keys(),i=n.xs.newChangeBuffer({trackRemovals:!0});return(function(e,t,n,r){let i=n.batch,s=i.keys(),a=ep.resolve();return s.forEach(e=>{a=a.next(()=>r.getEntry(t,e)).next(t=>{let s=n.docVersions.get(e);x(null!==s,48541),0>t.version.compareTo(s)&&(i.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,i))})(n,e,t,i).next(()=>i.apply(e)).next(()=>n.mutationQueue.performConsistencyCheck(e)).next(()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId)).next(()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=rl();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t))).next(()=>n.localDocuments.getDocuments(e,r))});ox(e,r,null),oS(e,r),e.sharedClientState.updateMutationState(r,"acknowledged"),await oA(e,i)}catch(e){await eg(e)}}async function ob(e,t,n){var r;try{let i=await (r=e.localStore).persistence.runTransaction("Reject batch","readwrite-primary",e=>{let n;return r.mutationQueue.lookupMutationBatch(e,t).next(t=>(x(null!==t,37113),n=t.keys(),r.mutationQueue.removeMutationBatch(e,t))).next(()=>r.mutationQueue.performConsistencyCheck(e)).next(()=>r.documentOverlayCache.removeOverlaysForBatchId(e,n,t)).next(()=>r.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,n)).next(()=>r.localDocuments.getDocuments(e,n))});ox(e,t,n),oS(e,t),e.sharedClientState.updateMutationState(t,"rejected",n),await oA(e,i)}catch(e){await eg(e)}}function oS(e,t){(e.mu.get(t)||[]).forEach(e=>{e.resolve()}),e.mu.delete(t)}function ox(e,t,n){let r=e.du[e.currentUser.toKey()];if(r){let i=r.get(t);i&&(n?i.reject(n):i.resolve(),r=r.remove(t)),e.du[e.currentUser.toKey()]=r}}function o_(e,t,n=null){for(let r of(e.sharedClientState.removeLocalQueryTarget(t),e.Iu.get(t)))e.Tu.delete(r),n&&e.Pu.yu(r,n);e.Iu.delete(t),e.isPrimaryClient&&e.Vu.Gr(t).forEach(t=>{e.Vu.containsKey(t)||oC(e,t)})}function oC(e,t){e.Eu.delete(t.path.canonicalString());let n=e.Ru.get(t);null!==n&&(aV(e.remoteStore,n),e.Ru=e.Ru.remove(t),e.Au.delete(n),oD(e))}function oN(e,t,n){for(let r of n)r instanceof os?(e.Vu.addReference(r.key,t),function(e,t){let n=t.key,r=n.path.canonicalString();e.Ru.get(n)||e.Eu.has(r)||(v(ol,"New document in limbo: "+n),e.Eu.add(r),oD(e))}(e,r)):r instanceof oa?(v(ol,"Document no longer in limbo: "+r.key),e.Vu.removeReference(r.key,t),e.Vu.containsKey(r.key)||oC(e,r.key)):b(19791,{wu:r})}function oD(e){for(;e.Eu.size>0&&e.Ru.size<e.maxConcurrentLimboResolutions;){let t=e.Eu.values().next().value;e.Eu.delete(t);let n=new Q($.fromString(t)),r=e.fu.next();e.Au.set(r,new oh(n)),e.Ru=e.Ru.insert(n,r),ak(e.remoteStore,new ib(nX(nH(n.path)),r,"TargetPurposeLimboResolution",ek.ce))}}async function oA(e,t,n){let r=[],i=[],s=[];e.Tu.isEmpty()||(e.Tu.forEach((a,o)=>{s.push(e.pu(o,t,n).then(t=>{if((t||n)&&e.isPrimaryClient){let r=t?!t.fromCache:n?.targetChanges.get(o.targetId)?.current;e.sharedClientState.updateQueryState(o.targetId,r?"current":"not-current")}if(t){r.push(t);let e=sz.Es(o.targetId,t);i.push(e)}}))}),await Promise.all(s),e.Pu.J_(r),await async function(e,t){try{await e.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>ep.forEach(t,t=>ep.forEach(t.Ts,r=>e.persistence.referenceDelegate.addReference(n,t.targetId,r)).next(()=>ep.forEach(t.Is,r=>e.persistence.referenceDelegate.removeReference(n,t.targetId,r)))))}catch(e){if(!eb(e))throw e;v(sG,"Failed to update sequence numbers: "+e)}for(let n of t){let t=n.targetId;if(!n.fromCache){let n=e.vs.get(t),r=n.snapshotVersion,i=n.withLastLimboFreeSnapshotVersion(r);e.vs=e.vs.insert(t,i)}}}(e.localStore,i))}async function ok(e,t){var n;if(!e.currentUser.isEqual(t)){v(ol,"User change. New user:",t.toKey());let r=await sQ(e.localStore,t);e.currentUser=t,n="'waitForPendingWrites' promise is rejected due to a user change.",e.mu.forEach(e=>{e.forEach(e=>{e.reject(new C(_.CANCELLED,n))})}),e.mu.clear(),e.sharedClientState.handleUserChange(t,r.removedBatchIds,r.addedBatchIds),await oA(e,r.Ns)}}function oV(e,t){let n=e.Au.get(t);if(n&&n.hu)return rl().add(n.key);{let n=rl(),r=e.Iu.get(t);if(!r)return n;for(let t of r){let r=e.Tu.get(t);n=n.unionWith(r.view.nu)}return n}}async function oR(e,t){let n=await sX(e.localStore,t.query,!0),r=t.view.cu(n);return e.isPrimaryClient&&oN(e,t.targetId,r.au),r}async function oO(e,t,n){let r=[],i=[];for(let n of t){let t;let s=e.Iu.get(n);if(s&&0!==s.length)for(let n of(t=await sW(e.localStore,nX(s[0])),s)){let t=e.Tu.get(n),r=await oR(e,t);r.snapshot&&i.push(r.snapshot)}else{let r=await sZ(e.localStore,n);t=await sW(e.localStore,r),await og(e,oF(r),n,!1,t.resumeToken)}r.push(t)}return e.Pu.J_(i),r}function oF(e){var t,n,r,i;return t=e.path,n=e.collectionGroup,r=e.orderBy,i=e.filters,new nQ(t,n,r,i,e.limit,"F",e.startAt,e.endAt)}function oM(e){return e.remoteStore.remoteSyncer.applyRemoteEvent=ov.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=oV.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=oT.bind(null,e),e.Pu.J_=ot.bind(null,e.eventManager),e.Pu.yu=on.bind(null,e.eventManager),e}function oP(e){return e.remoteStore.remoteSyncer.applySuccessfulWrite=oE.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=ob.bind(null,e),e}class oL{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(e){this.serializer=aw(e.databaseInfo.databaseId),this.sharedClientState=this.Du(e),this.persistence=this.Cu(e),await this.persistence.start(),this.localStore=this.vu(e),this.gcScheduler=this.Fu(e,this.localStore),this.indexBackfillerScheduler=this.Mu(e,this.localStore)}Fu(e,t){return null}Mu(e,t){return null}vu(e){var t;return t=this.persistence,new sj(t,new s$,e.initialUser,this.serializer)}Cu(e){return new sR(sF.Vi,this.serializer)}Du(e){return new ai}async terminate(){this.gcScheduler?.stop(),this.indexBackfillerScheduler?.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}oL.provider={build:()=>new oL};class oU extends oL{constructor(e){super(),this.cacheSizeBytes=e}Fu(e,t){return x(this.persistence.referenceDelegate instanceof sM,46915),new sd(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}Cu(e){let t=void 0!==this.cacheSizeBytes?se.withCacheSize(this.cacheSizeBytes):se.DEFAULT;return new sR(e=>sM.Vi(e,t),this.serializer)}}class oq{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>oI(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=ok.bind(null,this.syncEngine),await aX(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new a8}createDatastore(e){let t=aw(e.databaseInfo.databaseId),n=new ap(e.databaseInfo);return new ax(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){var t;return t=this.localStore,new aN(t,this.datastore,e.asyncQueue,e=>oI(this.syncEngine,e,0),ao.v()?new ao:new as)}createSyncEngine(e,t){return function(e,t,n,r,i,s,a){let o=new oc(e,t,n,r,i,s);return a&&(o.gu=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){await async function(e){v(aC,"RemoteStore shutting down."),e.Ea.add(5),await aA(e),e.Aa.shutdown(),e.Va.set("Unknown")}(this.remoteStore),this.datastore?.terminate(),this.eventManager?.terminate()}}oq.provider={build:()=>new oq};class oB{constructor(e){this.observer=e,this.muted=!1}next(e){this.muted||this.observer.next&&this.Ou(this.observer.next,e)}error(e){this.muted||(this.observer.error?this.Ou(this.observer.error,e):I("Uncaught Error in snapshot listener:",e.toString()))}Nu(){this.muted=!0}Ou(e,t){setTimeout(()=>{this.muted||e(t)},0)}}let oz="FirestoreClient";class oK{constructor(e,t,n,r,i){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this._databaseInfo=r,this.user=m.UNAUTHENTICATED,this.clientId=P.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=i,this.authCredentials.start(n,async e=>{v(oz,"Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(v(oz,"Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this._databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();let e=new N;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(n){let t=a2(n,"Failed to shutdown persistence");e.reject(t)}}),e.promise}}async function o$(e,t){e.asyncQueue.verifyOperationInProgress(),v(oz,"Initializing OfflineComponentProvider");let n=e.configuration;await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await sQ(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function oG(e,t){e.asyncQueue.verifyOperationInProgress();let n=await oj(e);v(oz,"Initializing OnlineComponentProvider"),await t.initialize(n,e.configuration),e.setCredentialChangeListener(e=>aJ(t.remoteStore,e)),e.setAppCheckTokenChangeListener((e,n)=>aJ(t.remoteStore,n)),e._onlineComponents=t}async function oj(e){if(!e._offlineComponents){if(e._uninitializedComponentsProvider){v(oz,"Using user provided OfflineComponentProvider");try{await o$(e,e._uninitializedComponentsProvider._offline)}catch(t){if(!("FirebaseError"===t.name?t.code===_.FAILED_PRECONDITION||t.code===_.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code))throw t;T("Error using user provided cache. Falling back to memory cache: "+t),await o$(e,new oL)}}else v(oz,"Using default OfflineComponentProvider"),await o$(e,new oU(void 0))}return e._offlineComponents}async function oQ(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(v(oz,"Using user provided OnlineComponentProvider"),await oG(e,e._uninitializedComponentsProvider._online)):(v(oz,"Using default OnlineComponentProvider"),await oG(e,new oq))),e._onlineComponents}async function oH(e){let t=await oQ(e),n=t.eventManager;return n.onListen=od.bind(null,t.syncEngine),n.onUnlisten=op.bind(null,t.syncEngine),n.onFirstRemoteStoreListen=of.bind(null,t.syncEngine),n.onLastRemoteStoreUnlisten=oy.bind(null,t.syncEngine),n}function oY(e,t,n,r){let i=new oB(r),s=new oi(t,i,n);return e.asyncQueue.enqueueAndForget(async()=>a7(await oH(e),s)),()=>{i.Nu(),e.asyncQueue.enqueueAndForget(async()=>oe(await oH(e),s))}}function oW(e,t,n={}){let r=new N;return e.asyncQueue.enqueueAndForget(async()=>(function(e,t,n,r,i){let s=new oB({next:o=>{s.Nu(),t.enqueueAndForget(()=>oe(e,a));let l=o.docs.has(n);!l&&o.fromCache?i.reject(new C(_.UNAVAILABLE,"Failed to get document because the client is offline.")):l&&o.fromCache&&r&&"server"===r.source?i.reject(new C(_.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):i.resolve(o)},error:e=>i.reject(e)}),a=new oi(nH(n.path),s,{includeMetadataChanges:!0,Ka:!0});return a7(e,a)})(await oH(e),e.asyncQueue,t,n,r)),r.promise}function oJ(e,t){let n=new N;return e.asyncQueue.enqueueAndForget(async()=>ow(await oQ(e).then(e=>e.syncEngine),t,n)),n.promise}function oX(e){let t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}let oZ=new Map,o0="firestore.googleapis.com";class o1{constructor(e){if(void 0===e.host){if(void 0!==e.ssl)throw new C(_.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=o0,this.ssl=!0}else this.host=e.host,this.ssl=e.ssl??!0;if(this.isUsingEmulator=void 0!==e.emulatorOptions,this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=0x2800000;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new C(_.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}(function(e,t,n,r){if(!0===t&&!0===r)throw new C(_.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)})("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=oX(e.experimentalLongPollingOptions??{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new C(_.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new C(_.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new C(_.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){var t,n;return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class o2{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new o1({}),this._settingsFrozen=!1,this._emulatorOptions={},this._terminateTask="notTerminated"}get app(){if(!this._app)throw new C(_.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return"notTerminated"!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new C(_.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new o1(e),this._emulatorOptions=e.emulatorOptions||{},void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new A;switch(e.type){case"firstParty":return new O(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new C(_.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_getEmulatorOptions(){return this._emulatorOptions}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return"notTerminated"===this._terminateTask&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){"notTerminated"===this._terminateTask?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){let t=oZ.get(e);t&&(v("ComponentProvider","Removing Datastore"),oZ.delete(e),t.terminate())}(this),Promise.resolve()}}class o4{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new o4(this.firestore,e,this._query)}}class o5{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new o6(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new o5(this.firestore,e,this._key)}toJSON(){return{type:o5._jsonSchemaVersion,referencePath:this._key.toString()}}static fromJSON(e,t,n){if(et(t,o5._jsonSchema))return new o5(e,n||null,new Q($.fromString(t.referencePath)))}}o5._jsonSchemaVersion="firestore/documentReference/1.0",o5._jsonSchema={type:ee("string",o5._jsonSchemaVersion),referencePath:ee("string")};class o6 extends o4{constructor(e,t,n){super(e,t,nH(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let e=this._path.popLast();return e.isEmpty()?null:new o5(this.firestore,null,new Q(e))}withConverter(e){return new o6(this.firestore,e,this._path)}}function o3(e,t,...n){if(e=(0,l.Ku)(e),H("collection","path",t),e instanceof o2){let r=$.fromString(t,...n);return W(r),new o6(e,null,r)}{if(!(e instanceof o5||e instanceof o6))throw new C(_.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=e._path.child($.fromString(t,...n));return W(r),new o6(e.firestore,null,r)}}function o8(e,t,...n){if(e=(0,l.Ku)(e),1==arguments.length&&(t=P.newId()),H("doc","path",t),e instanceof o2){let r=$.fromString(t,...n);return Y(r),new o5(e,null,new Q(r))}{if(!(e instanceof o5||e instanceof o6))throw new C(_.INVALID_ARGUMENT,"Expected first argument to doc() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=e._path.child($.fromString(t,...n));return Y(r),new o5(e.firestore,e instanceof o6?e.converter:null,new Q(r))}}let o9="AsyncQueue";class o7{constructor(e=Promise.resolve()){this.Yu=[],this.ec=!1,this.tc=[],this.nc=null,this.rc=!1,this.sc=!1,this.oc=[],this.M_=new av(this,"async_queue_retry"),this._c=()=>{let e=ay();e&&v(o9,"Visibility state changed to "+e.visibilityState),this.M_.w_()},this.ac=e;let t=ay();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this._c)}get isShuttingDown(){return this.ec}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.uc(),this.cc(e)}enterRestrictedMode(e){if(!this.ec){this.ec=!0,this.sc=e||!1;let t=ay();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this._c)}}enqueue(e){if(this.uc(),this.ec)return new Promise(()=>{});let t=new N;return this.cc(()=>this.ec&&this.sc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Yu.push(e),this.lc()))}async lc(){if(0!==this.Yu.length){try{await this.Yu[0](),this.Yu.shift(),this.M_.reset()}catch(e){if(!eb(e))throw e;v(o9,"Operation failed with retryable error: "+e)}this.Yu.length>0&&this.M_.p_(()=>this.lc())}}cc(e){let t=this.ac.then(()=>(this.rc=!0,e().catch(e=>{throw this.nc=e,this.rc=!1,I("INTERNAL UNHANDLED ERROR: ",le(e)),e}).then(e=>(this.rc=!1,e))));return this.ac=t,t}enqueueAfterDelay(e,t,n){this.uc(),this.oc.indexOf(e)>-1&&(t=0);let r=a1.createAndSchedule(this,e,t,n,e=>this.hc(e));return this.tc.push(r),r}uc(){this.nc&&b(47125,{Pc:le(this.nc)})}verifyOperationInProgress(){}async Tc(){let e;do e=this.ac,await e;while(e!==this.ac)}Ic(e){for(let t of this.tc)if(t.timerId===e)return!0;return!1}Ec(e){return this.Tc().then(()=>{for(let t of(this.tc.sort((e,t)=>e.targetTimeMs-t.targetTimeMs),this.tc))if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.Tc()})}Rc(e){this.oc.push(e)}hc(e){let t=this.tc.indexOf(e);this.tc.splice(t,1)}}function le(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}class lt extends o2{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new o7,this._persistenceKey=r?.name||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){let e=this._firestoreClient.terminate();this._queue=new o7(e),this._firestoreClient=void 0,await e}}}function ln(e,t){let n="object"==typeof e?e:(0,o.Sx)(),r=(0,o.j6)(n,"firestore").getImmediate({identifier:"string"==typeof e?e:t||tZ});if(!r._initialized){let e=(0,l.yU)("firestore");e&&function(e,t,n,r={}){e=Z(e,o2);let i=(0,l.zJ)(t),s=e._getSettings(),a={...s,emulatorOptions:e._getEmulatorOptions()},o=`${t}:${n}`;i&&((0,l.gE)(`https://${o}`),(0,l.P1)("Firestore",!0)),s.host!==o0&&s.host!==o&&T("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used.");let u={...s,host:o,ssl:i,emulatorOptions:r};if(!(0,l.bD)(u,a)&&(e._setSettings(u),r.mockUserToken)){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=m.MOCK_USER;else{t=(0,l.Fy)(r.mockUserToken,e._app?.options.projectId);let i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new C(_.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new m(i)}e._authCredentials=new k(new D(t,n))}}(r,...e)}return r}function lr(e){if(e._terminated)throw new C(_.FAILED_PRECONDITION,"The client has already been terminated.");return e._firestoreClient||function(e){var t,n,r,i;let s=e._freezeSettings(),a=(t=e._databaseId,n=e._app?.options.appId||"",r=e._persistenceKey,i=e._app?.options.apiKey,new tX(t,n,r,s.host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,oX(s.experimentalLongPollingOptions),s.useFetchStreams,s.isUsingEmulator,i));e._componentsProvider||s.localCache?._offlineComponentProvider&&s.localCache?._onlineComponentProvider&&(e._componentsProvider={_offline:s.localCache._offlineComponentProvider,_online:s.localCache._onlineComponentProvider}),e._firestoreClient=new oK(e._authCredentials,e._appCheckCredentials,e._queue,a,e._componentsProvider&&function(e){let t=e?._online.build();return{_offline:e?._offline.build(t),_online:t}}(e._componentsProvider))}(e),e._firestoreClient}class li{constructor(e){this._byteString=e}static fromBase64String(e){try{return new li(tq.fromBase64String(e))}catch(e){throw new C(_.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new li(tq.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}toJSON(){return{type:li._jsonSchemaVersion,bytes:this.toBase64()}}static fromJSON(e){if(et(e,li._jsonSchema))return li.fromBase64String(e.bytes)}}li._jsonSchemaVersion="firestore/bytes/1.0",li._jsonSchema={type:ee("string",li._jsonSchemaVersion),bytes:ee("string")};class ls{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new C(_.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new j(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class la{constructor(e){this._methodName=e}}class lo{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new C(_.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new C(_.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}_compareTo(e){return L(this._lat,e._lat)||L(this._long,e._long)}toJSON(){return{latitude:this._lat,longitude:this._long,type:lo._jsonSchemaVersion}}static fromJSON(e){if(et(e,lo._jsonSchema))return new lo(e.latitude,e.longitude)}}lo._jsonSchemaVersion="firestore/geoPoint/1.0",lo._jsonSchema={type:ee("string",lo._jsonSchemaVersion),latitude:ee("number"),longitude:ee("number")};class ll{constructor(e){this._values=(e||[]).map(e=>e)}toArray(){return this._values.map(e=>e)}isEqual(e){return function(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}(this._values,e._values)}toJSON(){return{type:ll._jsonSchemaVersion,vectorValues:this._values}}static fromJSON(e){if(et(e,ll._jsonSchema)){if(Array.isArray(e.vectorValues)&&e.vectorValues.every(e=>"number"==typeof e))return new ll(e.vectorValues);throw new C(_.INVALID_ARGUMENT,"Expected 'vectorValues' field to be a number array")}}}ll._jsonSchemaVersion="firestore/vectorValue/1.0",ll._jsonSchema={type:ee("string",ll._jsonSchemaVersion),vectorValues:ee("object")};let lu=/^__.*__$/;class lh{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new rV(e,this.data,this.fieldMask,t,this.fieldTransforms):new rk(e,this.data,t,this.fieldTransforms)}}class lc{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new rV(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function ld(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw b(40011,{dataSource:e})}}class lf{constructor(e,t,n,r,i,s){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===i&&this.validatePath(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get dataSource(){return this.settings.dataSource}contextWith(e){return new lf({...this.settings,...e},this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}childContextForField(e){let t=this.path?.child(e),n=this.contextWith({path:t,arrayElement:!1});return n.validatePathSegment(e),n}childContextForFieldPath(e){let t=this.path?.child(e),n=this.contextWith({path:t,arrayElement:!1});return n.validatePath(),n}childContextForArray(e){return this.contextWith({path:void 0,arrayElement:!0})}createError(e){return lR(e,this.settings.methodName,this.settings.hasConverter||!1,this.path,this.settings.targetDoc)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}validatePath(){if(this.path)for(let e=0;e<this.path.length;e++)this.validatePathSegment(this.path.get(e))}validatePathSegment(e){if(0===e.length)throw this.createError("Document fields must not be empty");if(ld(this.dataSource)&&lu.test(e))throw this.createError('Document fields cannot begin and end with "__"')}}class lm{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||aw(e)}createContext(e,t,n,r=!1){return new lf({dataSource:e,methodName:t,targetDoc:n,path:j.emptyPath(),arrayElement:!1,hasConverter:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function lg(e){let t=e._freezeSettings(),n=aw(e._databaseId);return new lm(e._databaseId,!!t.ignoreUndefinedProperties,n)}function lp(e,t,n,r,i,s={}){let a,o;let l=e.createContext(s.merge||s.mergeFields?2:0,t,n,i);lD("Data must be an object, but it was:",l,r);let u=lC(r,l);if(s.merge)a=new tL(l.fieldMask),o=l.fieldTransforms;else if(s.mergeFields){let e=[];for(let r of s.mergeFields){let i=lA(t,r,n);if(!l.contains(i))throw new C(_.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);lO(e,i)||e.push(i)}a=new tL(e),o=l.fieldTransforms.filter(e=>a.covers(e.field))}else a=null,o=l.fieldTransforms;return new lh(new ny(u),a,o)}class ly extends la{_toFieldTransform(e){if(2!==e.dataSource)throw 1===e.dataSource?e.createError(`${this._methodName}() can only appear at the top level of your update data`):e.createError(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof ly}}function lw(e,t,n){return new lf({dataSource:3,targetDoc:t.settings.targetDoc,methodName:e._methodName,arrayElement:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class lv extends la{_toFieldTransform(e){return new rb(e.path,new rg)}isEqual(e){return e instanceof lv}}class lI extends la{constructor(e,t){super(e),this.Ac=t}_toFieldTransform(e){let t=lw(this,e,!0),n=new rp(this.Ac.map(e=>l_(e,t)));return new rb(e.path,n)}isEqual(e){return e instanceof lI&&(0,l.bD)(this.Ac,e.Ac)}}class lT extends la{constructor(e,t){super(e),this.Ac=t}_toFieldTransform(e){let t=lw(this,e,!0),n=new rw(this.Ac.map(e=>l_(e,t)));return new rb(e.path,n)}isEqual(e){return e instanceof lT&&(0,l.bD)(this.Ac,e.Ac)}}class lE extends la{constructor(e,t){super(e),this.Vc=t}_toFieldTransform(e){let t=new rI(e.serializer,rd(e.serializer,this.Vc));return new rb(e.path,t)}isEqual(e){return e instanceof lE&&this.Vc===e.Vc}}function lb(e,t,n,r){let i=e.createContext(1,t,n);lD("Data must be an object, but it was:",i,r);let s=[],a=ny.empty();return tA(r,(e,r)=>{let o=lV(t,e,n);r=(0,l.Ku)(r);let u=i.childContextForFieldPath(o);if(r instanceof ly)s.push(o);else{let e=l_(r,u);null!=e&&(s.push(o),a.set(o,e))}}),new lc(a,new tL(s),i.fieldTransforms)}function lS(e,t,n,r,i,s){let a=e.createContext(1,t,n),o=[lA(t,r,n)],u=[i];if(s.length%2!=0)throw new C(_.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<s.length;e+=2)o.push(lA(t,s[e])),u.push(s[e+1]);let h=[],c=ny.empty();for(let e=o.length-1;e>=0;--e)if(!lO(h,o[e])){let t=o[e],n=u[e];n=(0,l.Ku)(n);let r=a.childContextForFieldPath(t);if(n instanceof ly)h.push(t);else{let e=l_(n,r);null!=e&&(h.push(t),c.set(t,e))}}return new lc(c,new tL(h),a.fieldTransforms)}function lx(e,t,n,r=!1){return l_(n,e.createContext(r?4:3,t))}function l_(e,t){if(lN(e=(0,l.Ku)(e)))return lD("Unsupported field value:",t,e),lC(e,t);if(e instanceof la)return function(e,t){if(!ld(t.dataSource))throw t.createError(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.createError(`${e._methodName}() is not currently supported inside arrays`);let n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.arrayElement&&4!==t.dataSource)throw t.createError("Nested arrays are not supported");return function(e,t){let n=[],r=0;for(let i of e){let e=l_(i,t.childContextForArray(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=(0,l.Ku)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return rd(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){let n=en.fromDate(e);return{timestampValue:r9(t.serializer,n)}}if(e instanceof en){let n=new en(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:r9(t.serializer,n)}}if(e instanceof lo)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof li)return{bytesValue:r7(t.serializer,e._byteString)};if(e instanceof o5){let n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.createError(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:it(e.firestore._databaseId||t.databaseId,e._key.path)}}if(e instanceof ll){var n;return{mapValue:{fields:{[t2]:{stringValue:t6},[t3]:{arrayValue:{values:((n=e)instanceof ll?n.toArray():n).map(e=>{if("number"!=typeof e)throw t.createError("VectorValues must only contain numeric values.");return rh(t.serializer,e)})}}}}}}if(iE(e))return e._toProto(t.serializer);throw t.createError(`Unsupported field value: ${X(e)}`)}(e,t)}function lC(e,t){let n={};return tk(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):tA(e,(e,r)=>{let i=l_(r,t.childContextForField(e));null!=i&&(n[e]=i)}),{mapValue:{fields:n}}}function lN(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof en||e instanceof lo||e instanceof li||e instanceof o5||e instanceof la||e instanceof ll||iE(e))}function lD(e,t,n){if(!lN(n)||!J(n)){let r=X(n);throw"an object"===r?t.createError(e+" a custom object"):t.createError(e+" "+r)}}function lA(e,t,n){if((t=(0,l.Ku)(t))instanceof ls)return t._internalPath;if("string"==typeof t)return lV(e,t);throw lR("Field path arguments must be of type string or ",e,!1,void 0,n)}let lk=RegExp("[~\\*/\\[\\]]");function lV(e,t,n){if(t.search(lk)>=0)throw lR(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new ls(...t.split("."))._internalPath}catch(r){throw lR(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function lR(e,t,n,r,i){let s=r&&!r.isEmpty(),a=void 0!==i,o=`Function ${t}() called with invalid data`;n&&(o+=" (via `toFirestore()`)"),o+=". ";let l="";return(s||a)&&(l+=" (found",s&&(l+=` in field ${r}`),a&&(l+=` in document ${i}`),l+=")"),new C(_.INVALID_ARGUMENT,o+e+l)}function lO(e,t){return e.some(e=>e.isEqual(t))}class lF{convertValue(e,t="none"){switch(t9(e)){case 0:return null;case 1:return e.booleanValue;case 2:return tK(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(t$(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw b(62114,{value:e})}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){let n={};return tA(e,(e,r)=>{n[e]=this.convertValue(r,t)}),n}convertVectorValue(e){return new ll(e.fields?.[t3].arrayValue?.values?.map(e=>tK(e.doubleValue)))}convertGeoPoint(e){return new lo(tK(e.latitude),tK(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":let n=tW(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(tJ(e));default:return null}}convertTimestamp(e){let t=tz(e);return new en(t.seconds,t.nanos)}convertDocumentKey(e,t){let n=$.fromString(e);x(iT(n),9688,{name:e});let r=new t0(n.get(1),n.get(3)),i=new Q(n.popFirst(5));return r.isEqual(t)||I(`Document ${i} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}class lM extends lF{constructor(e){super(),this.firestore=e}convertBytes(e){return new li(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new o5(this.firestore,null,t)}}function lP(){return new lv("serverTimestamp")}class lL{constructor(e){this.optionDefinitions=e}_getKnownOptions(e,t){let n=ny.empty();for(let r in this.optionDefinitions)if(this.optionDefinitions.hasOwnProperty(r)){let i=this.optionDefinitions[r];if(r in e){let s;let a=e[r];i.nestedOptions&&J(a)?s={mapValue:{fields:new lL(i.nestedOptions).getOptionsProto(t,a)}}:a&&(s=l_(a,t)??void 0),s&&n.set(j.fromServerFormat(i.serverName),s)}}return n}getOptionsProto(e,t,n){let r=this._getKnownOptions(t,e);if(n){let t=new Map(function(e,t){let n=[];for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&n.push(t(e[r],r,e));return n}(n,(t,n)=>[j.fromServerFormat(n),void 0!==t?l_(t,e):null]));r.setAll(t)}return r.value.mapValue.fields??{}}}}}]);